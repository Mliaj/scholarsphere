{% extends "base.html" %}

{% block title %}Reset Password - Scholarsphere{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/auth.css') }}">
<style>
    .password-strength {
        margin-top: 0.5rem;
        font-size: 0.85rem;
    }
    .strength-bar {
        height: 4px;
        border-radius: 2px;
        margin-top: 0.25rem;
        transition: width 0.3s, background-color 0.3s;
        width: 0%;
    }
    .strength-weak { background-color: #dc3545; width: 33%; }
    .strength-medium { background-color: #ffc107; width: 66%; }
    .strength-strong { background-color: #28a745; width: 100%; }
    .password-toggle {
        cursor: pointer !important;
        pointer-events: auto !important;
        z-index: 10;
    }
    .password-toggle:hover {
        color: #003366 !important;
    }
</style>
{% endblock %}

{% block content %}
<div class="uc-auth-container">
    <div class="uc-auth-left">
        <div class="uc-auth-logo">
            <img src="{{ url_for('static', filename='images/uc-logo.png') }}" alt="University of Cebu Logo">
        </div>
        <h1>University of Cebu</h1>
        <div class="uc-auth-desc">
            Create a new password for your Scholarsphere account.
        </div>
    </div>
    <div class="uc-auth-right">
        <div class="uc-auth-card">
            <a href="{{ url_for('auth.login') }}" class="back-link"><i class="fas fa-arrow-left"></i> Back to Login</a>
            <h2>Reset Password</h2>
            <p>Enter your new password below.</p>
            
            {% if error %}
            <div class="alert alert-error" style="padding: 1rem; margin-bottom: 1rem; border-radius: 8px; background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb;">
                {{ error }}
            </div>
            {% endif %}
            
            {% if not error %}
            <form method="POST" id="resetPasswordForm">
                <div class="form-group">
                    <label for="password">New Password</label>
                    <div class="password-input-container">
                        <input type="password" id="password" name="password" required placeholder="Enter new password" minlength="8">
                        <span class="password-toggle" id="password-toggle">
                            <i class="fas fa-eye"></i>
                        </span>
                    </div>
                    <div class="password-strength">
                        <div class="strength-bar" id="strengthBar"></div>
                        <small id="strengthText" style="color: #666;"></small>
                    </div>
                </div>
                <div class="form-group">
                    <label for="confirm_password">Confirm Password</label>
                    <div class="password-input-container">
                        <input type="password" id="confirm_password" name="confirm_password" required placeholder="Confirm new password" minlength="8">
                        <span class="password-toggle" id="confirm-password-toggle">
                            <i class="fas fa-eye"></i>
                        </span>
                    </div>
                    <small id="passwordMatch" style="color: #666;"></small>
                </div>
                <button type="submit" class="btn" id="submitBtn">Reset Password</button>
            </form>
            {% endif %}
            <div class="signup-link">
                <p>Remember your password? <a href="{{ url_for('auth.login') }}">Sign In</a></p>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Run after page is fully loaded to avoid conflicts
(function() {
    'use strict';
    
    function initPasswordToggles() {
        // Password field toggle
        var passwordToggle = document.getElementById('password-toggle');
        var passwordInput = document.getElementById('password');
        
        if (passwordToggle && passwordInput) {
            // Remove any existing event listeners by replacing the element
            var newToggle1 = passwordToggle.cloneNode(true);
            passwordToggle.parentNode.replaceChild(newToggle1, passwordToggle);
            
            newToggle1.addEventListener('click', function(event) {
                event.preventDefault();
                event.stopPropagation();
                
                var input = document.getElementById('password');
                if (!input) return;
                
                if (input.type === 'password') {
                    input.type = 'text';
                    var icon = this.querySelector('i');
                    if (icon) {
                        icon.classList.remove('fa-eye');
                        icon.classList.add('fa-eye-slash');
                    }
                } else {
                    input.type = 'password';
                    var icon = this.querySelector('i');
                    if (icon) {
                        icon.classList.remove('fa-eye-slash');
                        icon.classList.add('fa-eye');
                    }
                }
            });
        }
        
        // Confirm password field toggle
        var confirmToggle = document.getElementById('confirm-password-toggle');
        var confirmInput = document.getElementById('confirm_password');
        
        if (confirmToggle && confirmInput) {
            // Remove any existing event listeners by replacing the element
            var newToggle2 = confirmToggle.cloneNode(true);
            confirmToggle.parentNode.replaceChild(newToggle2, confirmToggle);
            
            newToggle2.addEventListener('click', function(event) {
                event.preventDefault();
                event.stopPropagation();
                
                var input = document.getElementById('confirm_password');
                if (!input) return;
                
                if (input.type === 'password') {
                    input.type = 'text';
                    var icon = this.querySelector('i');
                    if (icon) {
                        icon.classList.remove('fa-eye');
                        icon.classList.add('fa-eye-slash');
                    }
                } else {
                    input.type = 'password';
                    var icon = this.querySelector('i');
                    if (icon) {
                        icon.classList.remove('fa-eye-slash');
                        icon.classList.add('fa-eye');
                    }
                }
            });
        }
    }
    
    // Run when DOM is ready
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', function() {
            setTimeout(initPasswordToggles, 200);
        });
    } else {
        setTimeout(initPasswordToggles, 200);
    }
})();

document.addEventListener('DOMContentLoaded', function() {
    const passwordInput = document.getElementById('password');
    const confirmInput = document.getElementById('confirm_password');
    const strengthBar = document.getElementById('strengthBar');
    const strengthText = document.getElementById('strengthText');
    const passwordMatch = document.getElementById('passwordMatch');
    
    // Password strength checker
    passwordInput?.addEventListener('input', function() {
        const password = this.value;
        const strength = checkPasswordStrength(password);
        strengthBar.className = 'strength-bar strength-' + strength.class;
        strengthText.textContent = strength.text;
        
        // Check password match
        if (confirmInput.value) {
            checkPasswordMatch();
        }
    });
    
    // Password match checker
    confirmInput?.addEventListener('input', checkPasswordMatch);
    
    function checkPasswordMatch() {
        if (confirmInput.value === '') {
            passwordMatch.textContent = '';
            return;
        }
        if (passwordInput.value === confirmInput.value) {
            passwordMatch.textContent = '✓ Passwords match';
            passwordMatch.style.color = '#28a745';
        } else {
            passwordMatch.textContent = '✗ Passwords do not match';
            passwordMatch.style.color = '#dc3545';
        }
    }
    
    function checkPasswordStrength(password) {
        let score = 0;
        if (password.length >= 8) score++;
        if (password.length >= 12) score++;
        if (/[a-z]/.test(password) && /[A-Z]/.test(password)) score++;
        if (/\d/.test(password)) score++;
        if (/[^a-zA-Z\d]/.test(password)) score++;
        
        if (score < 2) return { class: 'weak', text: 'Weak password' };
        if (score < 4) return { class: 'medium', text: 'Medium strength' };
        return { class: 'strong', text: 'Strong password' };
    }
});
</script>
{% endblock %}
