{% extends "base.html" %}

{% block title %}Reports & Analytics - Scholarsphere | Admin{% endblock %}

{% block extra_css %}
<style>
  .dashboard-container { display:flex; min-height:100vh; }
  .sidebar { width:280px; background: linear-gradient(135deg, #1a1a1a 0%, #2d2d2d 100%); color:#fff; padding:2rem 0; position:fixed; height:100vh; overflow-y:auto; }
  .sidebar-header { text-align:center; padding:0 2rem 2rem 2rem; border-bottom:1px solid rgba(255,255,255,0.1); }
  .sidebar-logo { width:60px; height:60px; background:#fff; border-radius:50%; margin:0 auto 1rem; display:flex; align-items:center; justify-content:center; overflow:hidden; }
  .sidebar-logo img { width:50px; height:50px; object-fit:cover; border-radius:50%; }
  .sidebar-brand { font-size:1.2rem; font-weight:700; margin-bottom:.5rem; }
  .sidebar-subtitle { font-size:.9rem; opacity:.8; }
  .sidebar-nav { padding:2rem 0; }
  .nav-item { padding:1rem 2rem; cursor:pointer; transition:background .3s; border-left:3px solid transparent; }
  .nav-item:hover, .nav-item.active { background:rgba(255,255,255,0.1); border-left-color:#ffc72c; }
  .nav-item i { margin-right:1rem; width:20px; }

  .main-content { flex:1; margin-left:280px; padding:2rem; }
  .top-bar { display:flex; justify-content:space-between; align-items:center; margin-bottom:2rem; padding:1rem 0; }
  .welcome-text h1 { font-size:2rem; color:#1a1a1a; margin-bottom:.5rem; }
  .welcome-text p { color:#666; }
  .user-menu { display:flex; align-items:center; gap:1rem; }
  .user-avatar { width:50px; height:50px; border-radius:50%; background:#1a1a1a; display:flex; align-items:center; justify-content:center; color:#fff; font-weight:600; font-size:1.2rem; }
  .card { background:#fff; border-radius:15px; box-shadow:0 4px 20px rgba(0,0,0,0.08); overflow:hidden; margin-bottom:1.5rem; }
  .card-header { display:flex; justify-content:space-between; align-items:center; padding:1.25rem 1.5rem; border-bottom:1px solid #e9ecef; background:#f8f9fa; }
  .card-header h3 { margin:0; font-size:1.1rem; color:#1a1a1a; font-weight:600; }
  .grid { display:grid; grid-template-columns: 1fr 1fr; gap:1.5rem; }
  .chart-wrap { position:relative; width:100%; height:360px; padding:0 .25rem 1rem; }
  .pdf-export-btn {
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.75rem 1.5rem;
    background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);
    color: white;
    text-decoration: none;
    border-radius: 8px;
    font-weight: 600;
    font-size: 0.95rem;
    transition: all 0.3s ease;
    box-shadow: 0 2px 8px rgba(220, 53, 69, 0.3);
  }
  .pdf-export-btn:hover {
    background: linear-gradient(135deg, #c82333 0%, #bd2130 100%);
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(220, 53, 69, 0.4);
    color: white;
    text-decoration: none;
  }
  .pdf-export-btn i {
    font-size: 1.1rem;
  }
  @media (max-width: 1024px){ .grid { grid-template-columns: 1fr; } }
</style>
{% endblock %}

{% block content %}
<div class="dashboard-container">
  <div class="sidebar">
    <div class="sidebar-header">
      <div class="sidebar-logo">
        <img src="{{ url_for('static', filename='images/uc-logo.png') }}" alt="UC Logo">
      </div>
      <div class="sidebar-brand">Scholarsphere</div>
      <div class="sidebar-subtitle">Admin Portal</div>
    </div>
    <nav class="sidebar-nav">
      <div class="nav-item" onclick="window.location.href='{{ url_for('admin.dashboard') }}'"><i class="fas fa-home"></i> Dashboard</div>
      <div class="nav-item" onclick="window.location.href='{{ url_for('admin.users') }}'"><i class="fas fa-users"></i> User Management</div>
      <div class="nav-item" onclick="window.location.href='{{ url_for('admin.providers') }}'"><i class="fas fa-building"></i> Provider Admin Management</div>
      <div class="nav-item" onclick="window.location.href='{{ url_for('admin.scholarships') }}'"><i class="fas fa-graduation-cap"></i> Scholarship Oversight</div>
      <div class="nav-item active"><i class="fas fa-chart-bar"></i> Reports & Analytics</div>
      <div class="nav-item" onclick="window.location.href='{{ url_for('logout') }}'"><i class="fas fa-sign-out-alt"></i> Logout</div>
    </nav>
  </div>

  <div class="main-content">
    <div class="top-bar">
      <div class="welcome-text">
        <h1>Reports & Analytics</h1>
        <p>Key metrics about online scholarship applications</p>
      </div>
      <div style="display: flex; align-items: center; gap: 1rem;">
        <a href="{{ url_for('admin.reports_pdf') }}" class="pdf-export-btn" target="_blank">
          <i class="fas fa-file-pdf"></i> Export PDF Report
        </a>
        <div class="user-menu"><div class="user-avatar">A</div></div>
      </div>
    </div>

    <div class="grid">
      <div class="card">
        <div class="card-header">
          <h3 style="margin:0">Application Status Breakdown</h3>
        </div>
        <div style="padding:1rem 1.5rem">
          <div class="chart-wrap"><canvas id="applicationsPie"></canvas></div>
        </div>
      </div>
      <div class="card">
        <div class="card-header">
          <h3 style="margin:0">Top Providers by Applications</h3>
        </div>
        <div style="padding:1rem 1.5rem">
          <div class="chart-wrap"><canvas id="topProvidersBar"></canvas></div>
        </div>
      </div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
  // Safely get data with fallbacks
  const totals = {{ data.totals|tojson|safe }} || { total_students: 0, total_applications: 0, applied_percent: 0 };
  const statusCounts = {{ data.status_counts|tojson|safe }} || { pending: 0, approved: 0, disapproved: 0 };
  const topProviders = {{ data.top_providers|tojson|safe }} || [];

  // Utility number formatter
  const fmt = new Intl.NumberFormat('en-US');

  // Plugin: draw center percentage inside doughnut
  const centerText = {
    id: 'centerText',
    afterDraw(chart, args, opts){
      const {ctx, chartArea} = chart;
      if (!chartArea) return;
      const {width, height} = chartArea;
      ctx.save();
      ctx.font = '700 28px Poppins, sans-serif';
      ctx.fillStyle = '#0f2a43';
      ctx.textAlign = 'center';
      ctx.textBaseline = 'middle';
      ctx.fillText(opts.text || '', width/2 + chartArea.left, height/2 + chartArea.top);
      ctx.restore();
    }
  };

  // Pie: Application Status Breakdown
  // Use pie_chart_total if available, otherwise calculate from status counts
  const pieChartTotal = totals.pie_chart_total !== undefined 
    ? totals.pie_chart_total 
    : Math.max(1, (statusCounts.pending || 0) + (statusCounts.approved || 0) + (statusCounts.disapproved || 0));
  const totalApps = Math.max(1, pieChartTotal);
  const statusLabels = ['Pending', 'Approved', 'Rejected'];
  const statusValues = [
    totalApps > 0 ? ((statusCounts.pending||0) / totalApps) * 100 : 0,
    totalApps > 0 ? ((statusCounts.approved||0) / totalApps) * 100 : 0,
    totalApps > 0 ? ((statusCounts.disapproved||0) / totalApps) * 100 : 0
  ];
  
  const pieCtx = document.getElementById('applicationsPie');
  if (pieCtx) {
    new Chart(pieCtx, {
      type: 'doughnut',
      data: {
        labels: statusLabels,
        datasets: [{ 
          data: statusValues, 
          backgroundColor: ['#ffc72c', '#28a745', '#dc3545'],
          borderWidth: 0
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        layout: { padding: 10 },
        plugins: {
          legend: { 
            position: 'bottom', 
            labels: { 
              boxWidth: 12, 
              color: '#233046',
              padding: 15,
              font: { size: 12 }
            } 
          },
          tooltip: { 
            callbacks: { 
              label: function(context) {
                const label = context.label || '';
                const value = context.parsed || 0;
                const count = Math.round((value / 100) * totalApps);
                return `${label}: ${value.toFixed(1)}% (${count} applications)`;
              }
            } 
          },
          centerText: { text: `${totals.applied_percent.toFixed(1)}%` }
        },
        cutout: '68%'
      },
      plugins: [centerText]
    });
  }

  // Bar: Top Providers by Applications
  const labels = topProviders.length > 0 ? topProviders.map(p => p.name || 'Unknown') : ['No providers yet'];
  const apps = topProviders.length > 0 ? topProviders.map(p => p.applications || 0) : [0];
  
  const barCtx = document.getElementById('topProvidersBar');
  if (barCtx) {
    new Chart(barCtx, {
      type: 'bar',
      data: { 
        labels: labels, 
        datasets: [{ 
          label: 'Applications', 
          data: apps, 
          backgroundColor: '#ffc72c', 
          borderRadius: 6, 
          maxBarThickness: 42 
        }] 
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        scales: {
          x: { 
            grid: { display: false }, 
            ticks: { color: '#586174', font: { size: 11 } } 
          },
          y: { 
            beginAtZero: true, 
            grid: { color: '#f0f3f7' }, 
            ticks: { 
              color: '#586174', 
              callback: function(v) { return fmt.format(v); },
              font: { size: 11 }
            } 
          }
        },
        plugins: { 
          legend: { display: false }, 
          tooltip: { 
            callbacks: { 
              label: function(context) {
                return `Applications: ${fmt.format(context.parsed.y)}`;
              }
            } 
          } 
        }
      }
    });
  }
});
</script>
{% endblock %}


