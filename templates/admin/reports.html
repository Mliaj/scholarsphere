{% extends "base.html" %}

{% block title %}Reports & Analytics - Scholarsphere | Admin{% endblock %}

{% block extra_css %}
<style>
  .dashboard-container { display:flex; min-height:100vh; }
  .sidebar { width:280px; background: linear-gradient(135deg, #1a1a1a 0%, #2d2d2d 100%); color:#fff; padding:2rem 0; position:fixed; height:100vh; overflow-y:auto; }
  .sidebar-header { text-align:center; padding:0 2rem 2rem 2rem; border-bottom:1px solid rgba(255,255,255,0.1); }
  .sidebar-logo { width:60px; height:60px; background:#fff; border-radius:50%; margin:0 auto 1rem; display:flex; align-items:center; justify-content:center; overflow:hidden; }
  .sidebar-logo img { width:50px; height:50px; object-fit:cover; border-radius:50%; }
  .sidebar-brand { font-size:1.2rem; font-weight:700; margin-bottom:.5rem; }
  .sidebar-subtitle { font-size:.9rem; opacity:.8; }
  .sidebar-nav { padding:2rem 0; }
  .nav-item { padding:1rem 2rem; cursor:pointer; transition:background .3s; border-left:3px solid transparent; }
  .nav-item:hover, .nav-item.active { background:rgba(255,255,255,0.1); border-left-color:#ffc72c; }
  .nav-item i { margin-right:1rem; width:20px; }

  .main-content { flex:1; margin-left:280px; padding:2rem; }
  .top-bar { display:flex; justify-content:space-between; align-items:center; margin-bottom:2rem; padding:1rem 0; }
  .welcome-text h1 { font-size:2rem; color:#1a1a1a; margin-bottom:.5rem; }
  .welcome-text p { color:#666; }
  .card { background:#fff; border-radius:15px; box-shadow:0 4px 20px rgba(0,0,0,0.08); overflow:hidden; margin-bottom:1.5rem; }
  .card-header { display:flex; justify-content:space-between; align-items:center; padding:1.25rem 1.5rem; border-bottom:1px solid #e9ecef; background:#f8f9fa; }
  .grid { display:grid; grid-template-columns: 1fr 1fr; gap:1.5rem; }
  .chart-wrap { position:relative; width:100%; height:360px; padding:0 .25rem 1rem; }
  @media (max-width: 1024px){ .grid { grid-template-columns: 1fr; } }
</style>
{% endblock %}

{% block content %}
<div class="dashboard-container">
  <div class="sidebar">
    <div class="sidebar-header">
      <div class="sidebar-logo">
        <img src="{{ url_for('static', filename='images/uc-logo.png') }}" alt="UC Logo">
      </div>
      <div class="sidebar-brand">Scholarsphere</div>
      <div class="sidebar-subtitle">Admin Portal</div>
    </div>
    <nav class="sidebar-nav">
      <div class="nav-item" onclick="window.location.href='{{ url_for('admin.dashboard') }}'"><i class="fas fa-home"></i> Dashboard</div>
      <div class="nav-item" onclick="window.location.href='{{ url_for('admin.users') }}'"><i class="fas fa-users"></i> User Management</div>
      <div class="nav-item" onclick="window.location.href='{{ url_for('admin.providers') }}'"><i class="fas fa-building"></i> Provider Management</div>
      <div class="nav-item" onclick="window.location.href='{{ url_for('admin.scholarships') }}'"><i class="fas fa-graduation-cap"></i> Scholarship Oversight</div>
      <div class="nav-item active"><i class="fas fa-chart-bar"></i> Reports & Analytics</div>
      <div class="nav-item" onclick="window.location.href='{{ url_for('logout') }}'"><i class="fas fa-sign-out-alt"></i> Logout</div>
    </nav>
  </div>

  <div class="main-content">
    <div class="top-bar">
      <div class="welcome-text">
        <h1>Reports & Analytics</h1>
        <p>Key metrics about online scholarship applications</p>
      </div>
      <div class="user-menu"><div class="user-avatar">A</div></div>
    </div>

    <div class="grid">
      <div class="card">
        <div class="card-header">
          <h3 style="margin:0">Application Status Breakdown</h3>
        </div>
        <div style="padding:1rem 1.5rem">
          <div class="chart-wrap"><canvas id="applicationsPie"></canvas></div>
        </div>
      </div>
      <div class="card">
        <div class="card-header">
          <h3 style="margin:0">Top Providers by Applications</h3>
        </div>
        <div style="padding:1rem 1.5rem">
          <div class="chart-wrap"><canvas id="topProvidersBar"></canvas></div>
        </div>
      </div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
  const totals = {{ data.totals|tojson }};
  const statusCounts = {{ data.status_counts|tojson }};
  const topProviders = {{ data.top_providers|tojson }};

  // Utility number formatter
  const fmt = new Intl.NumberFormat('en-US');

  // Plugin: draw center percentage inside doughnut
  const centerText = {
    id: 'centerText',
    afterDraw(chart, args, opts){
      const {ctx, chartArea: {width, height}} = chart;
      ctx.save();
      ctx.font = '700 28px Poppins, sans-serif';
      ctx.fillStyle = '#0f2a43';
      ctx.textAlign = 'center';
      ctx.textBaseline = 'middle';
      ctx.fillText(opts.text || '', width/2, height/2);
      ctx.restore();
    }
  };

  // Pie: percentage of students who applied online
  // Convert status counts to percentages of total applications
  const totalApps = Math.max(1, (statusCounts.pending || 0) + (statusCounts.approved || 0) + (statusCounts.disapproved || 0));
  const statusLabels = ['Pending', 'Approved', 'Disapproved'];
  const statusValues = [
    ((statusCounts.pending||0) / totalApps) * 100,
    ((statusCounts.approved||0) / totalApps) * 100,
    ((statusCounts.disapproved||0) / totalApps) * 100
  ];
  new Chart(document.getElementById('applicationsPie'), {
    type: 'doughnut',
    data: {
      labels: statusLabels,
      datasets: [{ data: statusValues, backgroundColor: ['#ffc72c', '#28a745', '#dc3545'] }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      layout: { padding: 10 },
      plugins: {
        legend: { position: 'bottom', labels: { boxWidth: 12, color: '#233046' } },
        tooltip: { callbacks: { label: c => `${c.label}: ${c.parsed.toFixed(1)}%` } },
        centerText: { text: `${totals.applied_percent.toFixed(1)}%` }
      },
      cutout: '68%'
    },
    plugins: [centerText]
  });

  // Bar: top providers by applications
  const labels = topProviders.map(p => p.name);
  const apps = topProviders.map(p => p.applications);
  new Chart(document.getElementById('topProvidersBar'), {
    type: 'bar',
    data: { labels, datasets: [{ label: 'Applications', data: apps, backgroundColor: '#ffc72c', borderRadius: 6, maxBarThickness: 42 }] },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      scales: {
        x: { grid: { display:false }, ticks: { color:'#586174' } },
        y: { beginAtZero: true, grid: { color:'#f0f3f7' }, ticks: { color:'#586174', callback: v => fmt.format(v) } }
      },
      plugins: { legend: { display:false }, tooltip: { callbacks: { label: c => `Applications: ${fmt.format(c.parsed.y)}` } } }
    }
  });
</script>
{% endblock %}


