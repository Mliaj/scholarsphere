{% extends "base.html" %}

{% block title %}Browse Scholarships - Scholarsphere | University of Cebu{% endblock %}

{% block extra_css %}
<style>
    * { margin:0; padding:0; box-sizing:border-box; }
    body { font-family:'Poppins', sans-serif; background:#f8f9fa; color:#333; }
    .dashboard-container { display: flex; min-height: 100vh; }
    .sidebar { width: 280px; background: linear-gradient(135deg, #003366 0%, #0072ce 100%); color: white; padding: 2rem 0; position: fixed; height: 100vh; overflow-y: auto; }
    .sidebar-header { text-align:center; padding:0 2rem 2rem 2rem; border-bottom:1px solid rgba(255,255,255,0.1); }
    .sidebar-nav { padding:2rem 0; }
    .sidebar-logo { width:60px; height:60px; background:#fff; border-radius:50%; margin:0 auto 1rem; display:flex; align-items:center; justify-content:center; overflow:hidden; border:3px solid rgba(255,255,255,0.25); box-shadow:0 2px 8px rgba(0,0,0,0.15); }
    .sidebar-logo img { width:100%; height:100%; object-fit:cover; border-radius:50%; }
    .sidebar-brand { font-size:1.2rem; font-weight:700; margin-bottom:.25rem; }
    .sidebar-subtitle { font-size:.9rem; opacity:.85; }
    .main-content { flex: 1; margin-left: 280px; padding: 2rem; }
    .top-bar { display:flex; justify-content:space-between; align-items:center; margin-bottom:2rem; padding:1rem 0; }
    .welcome-text h1 { font-size:2rem; color:#003366; margin-bottom:.5rem; }
    .welcome-text p { color:#666; }
    .nav-item { padding: 1rem 2rem; cursor: pointer; transition: background 0.3s; border-left: 3px solid transparent; display:flex; align-items:center; gap:.75rem; }
    .nav-item:hover { background: rgba(255,255,255,0.1); border-left-color: #ffc72c; }
    .nav-item.active { background: rgba(255,255,255,0.15); border-left-color: #ffc72c; }
    .nav-item i { width:20px; margin-right:1rem; }
    .scholarships-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(320px, 1fr)); gap: 1.5rem; }
    .scholarship-card { 
        background: #fff; 
        border: 1px solid #e9ecef; 
        border-radius: 16px; 
        padding: 1.5rem; 
        box-shadow: 0 4px 20px rgba(0,0,0,0.08); 
        display: flex; 
        flex-direction: column; 
        transition: all 0.3s ease;
        position: relative;
        overflow: hidden;
    }
    .scholarship-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 30px rgba(0,0,0,0.12);
    }
    .scholarship-card h3 { 
        color: #003366; 
        margin-bottom: 0.75rem; 
        font-size: 1.25rem; 
        font-weight: 700;
        line-height: 1.3;
    }
    .scholarship-meta { 
        color: #666; 
        font-size: 0.85rem; 
        margin-bottom: 1rem; 
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }
    .scholarship-desc { 
        color: #555; 
        font-size: 0.95rem; 
        line-height: 1.5; 
        margin-bottom: 1rem;
        flex-grow: 1;
    }
    .scholarship-req { 
        color: #444; 
        font-size: 0.9rem; 
        margin-bottom: 1.25rem;
        line-height: 1.4;
    }
    .scholarship-req strong {
        color: #003366;
        font-weight: 600;
    }
    .requirements-list {
        margin-top: 0.5rem;
        display: flex;
        flex-wrap: wrap;
        gap: 0.5rem;
    }
    .requirement-tag {
        background: #f8f9fa;
        color: #495057;
        padding: 0.25rem 0.5rem;
        border-radius: 6px;
        font-size: 0.8rem;
        border: 1px solid #e9ecef;
    }
.actions { 
        margin-top: auto; 
        display: flex; 
        justify-content: space-between; 
        align-items: center; 
        gap: 0.5rem; 
        padding-top: 1rem;
        border-top: 1px solid #f1f3f4;
    }
    .actions .hint-text {
        font-size: 0.8rem;
        color: #6c757d;
    }
    .btn-apply { 
        background: linear-gradient(135deg, #0072ce 0%, #0056a3 100%); 
        color: #fff; 
        border: none; 
        padding: 0.75rem 1.5rem; 
        border-radius: 10px; 
        cursor: pointer; 
        font-weight: 600;
        font-size: 0.9rem;
        transition: all 0.3s ease;
        box-shadow: 0 2px 8px rgba(0,114,206,0.3);
    }
    .btn-apply:hover {
        transform: translateY(-1px);
        box-shadow: 0 4px 12px rgba(0,114,206,0.4);
    }
    .btn-apply:disabled { 
        background: #9db9d6; 
        cursor: not-allowed; 
        transform: none;
        box-shadow: none;
    }
    .badge { 
        display: inline-block; 
        padding: 0.4rem 0.8rem; 
        border-radius: 20px; 
        background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%); 
        color: #1976d2; 
        font-size: 0.8rem; 
        font-weight: 600;
        border: 1px solid #90caf9;
    }
    .empty-state { display: flex; align-items: center; justify-content: center; height: calc(100vh - 4rem); text-align: center; }
    .empty-box { max-width: 520px; padding: 2rem; border: 1px dashed #cfd8e3; border-radius: 12px; background: #f8fbff; margin: 0 auto; }

    /* Page Alert */
    .page-alert { display:none; margin-bottom: 1rem; padding: 0.75rem 1rem; border-radius: 8px; border: 1px solid #f5c2c7; background: #f8d7da; color: #842029; display:flex; justify-content: space-between; align-items: center; }
    .page-alert .close { background:none; border:none; color:#842029; font-size:1.25rem; cursor:pointer; }

    /* Application Modal */
    .modal { display:none; position:fixed; z-index:1000; left:0; top:0; width:100%; height:100%; background:rgba(0,0,0,0.5); }
    .modal-content { background:#fff; margin:2% auto; padding:0; border-radius:15px; width:95%; max-width:900px; max-height:92vh; overflow:auto; }
    .modal-header { padding:1rem 1.25rem; border-bottom:1px solid #e9ecef; display:flex; justify-content:space-between; align-items:center; background:#f8f9fa; border-radius:15px 15px 0 0; }
    .modal-title { margin:0; font-size:1.25rem; color:#003366; font-weight:700; }
    .close { background:none; border:none; font-size:1.5rem; cursor:pointer; color:#666; }
    .modal-body { padding:1.25rem; }
    .form-grid { display:grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap: .75rem 1rem; }
    .form-group { display:flex; flex-direction:column; gap:.35rem; }
    .form-label { font-weight:600; color:#333; }
    .form-control { width:100%; padding:.6rem .7rem; border:1px solid #ddd; border-radius:8px; }
    .section-title { margin:.5rem 0 .25rem; font-weight:700; color:#003366; }
    .modal-footer { padding:1rem 1.25rem; border-top:1px solid #e9ecef; background:#f8f9fa; border-radius:0 0 15px 15px; display:flex; justify-content:flex-end; gap:.5rem; }
    .btn { padding:.6rem 1rem; border:none; border-radius:8px; cursor:pointer; font-weight:600; }
    .btn.secondary { background:#e9ecef; }
    .btn.primary { background:#0072ce; color:#fff; }
    
    /* Credential Picker Styles */
    .credential-picker-info {
        margin-bottom: 1rem;
        padding: 0.75rem;
        background: #f8f9fa;
        border-radius: 8px;
        border-left: 4px solid #007bff;
    }
    
    .credential-picker {
        display: flex;
        flex-direction: column;
        gap: 1rem;
    }
    
    .requirement-group {
        background: #fff;
        border: 1px solid #e9ecef;
        border-radius: 10px;
        padding: 1rem;
        transition: all 0.3s ease;
    }
    
    .requirement-group:hover {
        border-color: #007bff;
        box-shadow: 0 2px 8px rgba(0, 123, 255, 0.1);
    }
    
    .requirement-header {
        margin-bottom: 0.75rem;
    }
    
    .requirement-label {
        display: flex;
        align-items: center;
        justify-content: space-between;
        font-weight: 600;
        color: #333;
        margin-bottom: 0.5rem;
    }
    
    .requirement-status {
        font-size: 0.85rem;
        padding: 0.25rem 0.5rem;
        border-radius: 12px;
        font-weight: 500;
    }
    
    .requirement-status.available {
        background: #d4edda;
        color: #155724;
    }
    
    .requirement-status.missing {
        background: #f8d7da;
        color: #721c24;
    }
    
    .requirement-status.multiple {
        background: #fff3cd;
        color: #856404;
    }
    
    .requirement-status.selected {
        background: #cce5ff;
        color: #004085;
    }
    
    .credential-selector {
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
    }
    
    .credential-select {
        padding: 0.75rem;
        border: 2px solid #e9ecef;
        border-radius: 8px;
        font-size: 0.95rem;
        transition: border-color 0.3s ease;
    }
    
    .credential-select:focus {
        outline: none;
        border-color: #007bff;
        box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.1);
    }
    
    .missing-credential {
        padding: 0.5rem;
        background: #fff5f5;
        border-radius: 6px;
        border-left: 3px solid #dc3545;
    }
    
    .missing-credential a {
        color: #007bff;
        text-decoration: none;
        font-weight: 500;
    }
    
    .missing-credential a:hover {
        text-decoration: underline;
    }
    
    .multiple-options {
        padding: 0.5rem;
        background: #fff8e1;
        border-radius: 6px;
        border-left: 3px solid #ffc107;
    }
    
    .no-requirements {
        text-align: center;
        padding: 2rem;
        color: #6c757d;
        font-style: italic;
    }
    
    .text-muted {
        color: #6c757d;
    }
    
    .text-info {
        color: #0c5460;
    }
    
    /* Upload Interface Styles */
    .upload-options {
        margin-top: 0.5rem;
    }
    
    .option-tabs {
        display: flex;
        margin-bottom: 1rem;
        border-bottom: 2px solid #e9ecef;
    }
    
    .tab-btn {
        padding: 0.5rem 1rem;
        border: none;
        background: transparent;
        color: #6c757d;
        font-weight: 500;
        cursor: pointer;
        border-bottom: 2px solid transparent;
        transition: all 0.3s ease;
    }
    
    .tab-btn.active {
        color: #007bff;
        border-bottom-color: #007bff;
    }
    
    .tab-btn:hover {
        color: #007bff;
    }
    
    .tab-content {
        transition: all 0.3s ease;
    }
    
    .tab-content.hidden {
        display: none;
    }
    
    .file-upload-area {
        border: 2px dashed #dee2e6;
        border-radius: 10px;
        padding: 2rem;
        text-align: center;
        cursor: pointer;
        transition: all 0.3s ease;
        background: #f8f9fa;
    }
    
    .file-upload-area:hover {
        border-color: #007bff;
        background: #e3f2fd;
    }
    
    .file-upload-area i {
        font-size: 2rem;
        color: #6c757d;
        margin-bottom: 0.5rem;
    }
    
    .file-upload-area p {
        margin: 0.5rem 0;
        font-weight: 500;
        color: #333;
    }
    
    .file-upload-area small {
        color: #6c757d;
    }
    
    .file-input {
        display: none;
    }
    
    .upload-progress {
        margin-top: 1rem;
        padding: 1rem;
        background: #f8f9fa;
        border-radius: 8px;
    }
    
    .progress-bar {
        width: 100%;
        height: 8px;
        background: #e9ecef;
        border-radius: 4px;
        overflow: hidden;
        margin-bottom: 0.5rem;
    }
    
    .progress-fill {
        height: 100%;
        background: #007bff;
        width: 0%;
        transition: width 0.3s ease;
        animation: progress-animation 2s ease-in-out infinite;
    }
    
    @keyframes progress-animation {
        0% { width: 0%; }
        50% { width: 70%; }
        100% { width: 100%; }
    }
    
    .progress-text {
        font-size: 0.9rem;
        color: #6c757d;
    }
    
    @media (max-width: 768px) {
        .scholarships-grid { 
            grid-template-columns: 1fr; 
            gap: 1rem; 
        }
        .scholarship-card { 
            padding: 1.25rem; 
        }
        .scholarship-card h3 { 
            font-size: 1.1rem; 
        }
        .requirements-list {
            gap: 0.4rem;
        }
        .requirement-tag {
            font-size: 0.75rem;
            padding: 0.2rem 0.4rem;
        }
        .scholarship-meta {
            flex-direction: column;
            align-items: flex-start;
            gap: 0.25rem;
        }
        .modal-content { width: 98%; margin: 1% auto; }
        .form-grid { grid-template-columns: 1fr; }
        .requirement-label {
            flex-direction: column;
            align-items: flex-start;
            gap: 0.5rem;
        }
        .option-tabs {
            flex-direction: column;
        }
        .tab-btn {
            text-align: center;
            border-bottom: 1px solid #e9ecef;
            border-right: none;
        }
        .file-upload-area {
            padding: 1.5rem;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="dashboard-container">
    <div class="sidebar">
        <div class="sidebar-header">
          <div class="sidebar-logo">
            {% if user and user.profile_picture %}
              <img src="{{ url_for('static', filename='uploads/profile_pictures/' + user.profile_picture) }}" alt="Profile Picture">
            {% else %}
              <img src="{{ url_for('static', filename='images/uc-logo.png') }}" alt="UC Logo">
            {% endif %}
          </div>
          <div class="sidebar-brand">Scholarsphere</div>
          <div class="sidebar-subtitle">Student Portal</div>
        </div>
        <nav class="sidebar-nav">
            <div class="nav-item active" onclick="window.location.href='{{ url_for('students.scholarships') }}'">
                <i class="fas fa-search"></i> Browse Scholarships
            </div>
            <div class="nav-item" onclick="window.location.href='{{ url_for('students.dashboard') }}'">
                <i class="fas fa-home"></i> Dashboard
            </div>
            <div class="nav-item" onclick="window.location.href='{{ url_for('students.profile') }}'">
                <i class="fas fa-user"></i> Profile Settings
            </div>
            <div class="nav-item" onclick="window.location.href='{{ url_for('students.credentials') }}'">
                <i class="fas fa-file-alt"></i> My Credentials
            </div>
            <div class="nav-item" onclick="window.location.href='{{ url_for('students.applications') }}'">
                <i class="fas fa-clipboard-list"></i> My Applications
            </div>
            <div class="nav-item" onclick="window.location.href='{{ url_for('logout') }}'">
                <i class="fas fa-sign-out-alt"></i> Logout
            </div>
        </nav>
    </div>

    <div class="main-content">
        <div class="top-bar">
          <div class="welcome-text">
            <h1>Browse Scholarships</h1>
            <p>Find opportunities that match your goals. If a previous application for a scholarship was rejected, you can apply again while that scholarship is still open.</p>
        </div>
        </div>
        <div id="pageAlert" class="page-alert" role="alert" aria-live="polite" style="display:none;"></div>
        {% if not scholarships or scholarships|length == 0 %}
            <div class="empty-state">
                <div class="empty-box">
                    <h3 style="color:#003366; margin-bottom:0.5rem;">No Scholarships Available</h3>
                    <p style="color:#555; margin-bottom:1rem;">No active scholarships have been created by providers yet.</p>
                    <div style="background: #f8f9fa; padding: 1rem; border-radius: 8px; border-left: 4px solid #007bff; max-width: 400px; margin: 0 auto;">
                        <p style="margin: 0; font-size: 0.9rem; color: #666;">
                            <strong>What to expect:</strong><br>
                            â€¢ Providers will create scholarship opportunities<br>
                            â€¢ You'll be able to browse and apply to relevant scholarships<br>
                            â€¢ Check back regularly for new opportunities
                        </p>
                    </div>
                </div>
            </div>
        {% else %}
            <div class="scholarships-grid">
                {% for s in scholarships %}
                <div class="scholarship-card" data-id="{{ s.scholarship_id }}">
                    <div class="scholarship-meta">
                        <span class="badge">{{ s.provider }}</span>
                        {% if s.type %}<span class="badge" style="background:#e9ecef; color:#495057; border-color:#ced4da;">{{ s.type }}</span>{% endif %}
                        {% if s.level %}<span class="badge" style="background:#fff3cd; color:#856404; border-color:#ffeeba;">{{ s.level }}</span>{% endif %}
                    </div>
                    <h3>{{ s.title }}</h3>
                    <div class="scholarship-desc">{{ s.description }}</div>
                    
                    <div style="display:grid; grid-template-columns: 1fr 1fr; gap:0.5rem; margin-bottom:1rem; font-size:0.9rem; color:#555;">
                        <div><strong>Amount:</strong> {{ s.amount or 'Not specified' }}</div>
                        <div><strong>Slots:</strong> {{ s.slots or 'Unlimited' }}</div>
                    </div>

                    {% if s.eligibility and s.eligibility != 'No specific eligibility criteria' %}
                    <div class="scholarship-req">
                        <strong>Eligibility:</strong>
                        <div style="font-size:0.9rem; color:#555; margin-top:0.25rem;">{{ s.eligibility }}</div>
                    </div>
                    {% endif %}

                    <div class="scholarship-req">
                        <strong>Requirements:</strong>
                        {% if s.requirements and s.requirements != 'No specific requirements' %}
                            <div class="requirements-list">
                                {% for req in s.requirements.split(',') %}
                                    {% if req.strip() %}
                                        <span class="requirement-tag">{{ req.strip() }}</span>
                                    {% endif %}
                                {% endfor %}
                            </div>
                        {% else %}
                            <div class="requirements-list">
                                <span class="requirement-tag" style="background: #e8f5e8; color: #2e7d32; border-color: #c8e6c9;">No specific requirements</span>
                            </div>
                        {% endif %}
                    </div>
                    
                    <div class="scholarship-meta" style="justify-content:space-between;">
                        <span><i class="fas fa-calendar-alt"></i> Deadline: {{ s.deadline }}</span>
                    </div>

                    {% if s.contact_name or s.contact_email or s.contact_phone %}
                    <div style="margin-top:0.5rem; padding-top:0.5rem; border-top:1px dashed #eee; font-size:0.85rem; color:#777;">
                        <strong>Contact:</strong> {{ s.contact_name }} 
                        {% if s.contact_email %} | {{ s.contact_email }}{% endif %}
                        {% if s.contact_phone %} | {{ s.contact_phone }}{% endif %}
                    </div>
                    {% endif %}

                    <div class="actions">
                        {% if s.has_applied and not s.can_apply_again %}
                            <button class="btn-apply" disabled>Applied ({{ s.application_status|title }})</button>
                        {% else %}
                            <button class="btn-apply" onclick="openApplication({{ s.scholarship_id }}, '{{ s.title|escape }}')">{% if s.can_apply_again %}Apply Again{% else %}Apply Now{% endif %}</button>
                            {% if s.can_apply_again %}
                                <span class="hint-text">Previous application was rejected; you may submit a new one for this scholarship.</span>
                            {% endif %}
                        {% endif %}
                    </div>
                </div>
                {% endfor %}
            </div>
        {% endif %}
    </div>
</div>

<script>
let credentialsData = null;
let selectedCredentials = {};
let pageAlertTimer = null;

function openApplication(id, title){
    const modal = document.getElementById('applyModal');
    document.getElementById('applyTitle').textContent = title;
    document.getElementById('applyScholarshipId').value = id;
    
    // Load credentials data for this scholarship
    loadCredentialsData(id);
    
    modal.style.display = 'block';
}

function closeApplication(){ 
    document.getElementById('applyModal').style.display='none';
    credentialsData = null;
    selectedCredentials = {};
}

async function loadCredentialsData(scholarshipId) {
    try {
        const response = await fetch(`{{ url_for('students.get_scholarship_credentials', scholarship_id=0) }}`.replace('0', scholarshipId));
        const result = await response.json();
        
        if (result.success) {
            credentialsData = result.data;
            renderCredentialPicker();
        } else {
            console.error('Failed to load credentials:', result.message);
            renderCredentialPicker(); // Render empty state
        }
    } catch (error) {
        console.error('Error loading credentials:', error);
        renderCredentialPicker(); // Render empty state
    }
}

function renderCredentialPicker() {
    const container = document.getElementById('requiredUploads');
    container.innerHTML = '';
    
    if (!credentialsData || !credentialsData.requirements.length) {
        container.innerHTML = '<div class="no-requirements">No specific requirements found for this scholarship. You can still submit your application with the information provided above.</div>';
        // Allow submission even without requirements
        return;
    }
    
    credentialsData.requirements.forEach(req => {
        const reqDiv = document.createElement('div');
        reqDiv.className = 'requirement-group';
        
        const statusIcon = getStatusIcon(req.status);
        const statusText = getStatusText(req.status);
        const requirementCode = req.requirement_code || req.requirement; // Use code for matching
        const requirementDisplay = req.requirement; // Use descriptive name for display
        
        reqDiv.innerHTML = `
            <div class="requirement-header">
                <label class="form-label requirement-label">
                    ${statusIcon} ${requirementDisplay}
                    <span class="requirement-status ${req.status}">${statusText}</span>
                </label>
            </div>
            <div class="credential-selector">
                <div class="upload-options">
                    <div class="option-tabs">
                        <button type="button" class="tab-btn active" onclick="showTab('${requirementCode}', 'existing')">Select Existing</button>
                        <button type="button" class="tab-btn" onclick="showTab('${requirementCode}', 'upload')">Upload New</button>
                    </div>
                    
                    <div class="tab-content" id="existing-${requirementCode.replace(/[^a-z0-9]/gi, '_')}">
                        <select class="form-control credential-select" data-requirement="${requirementCode}" onchange="selectCredential('${requirementCode}', this.value)">
                            <option value="">Select a credential...</option>
                            ${req.matches.map(cred => 
                                `<option value="${cred.id}" ${req.best_match && req.best_match.id === cred.id ? 'selected' : ''}>
                                    ${cred.credential_type} - ${cred.file_name}
                                </option>`
                            ).join('')}
                        </select>
                        ${req.status === 'missing' ? `
                            <div class="missing-credential">
                                <small class="text-muted">No matching credential found.</small>
                            </div>
                        ` : ''}
                        ${req.status === 'multiple' ? `
                            <div class="multiple-options">
                                <small class="text-info">Multiple options available. Choose the most recent or relevant one.</small>
                            </div>
                        ` : ''}
                    </div>
                    
                    <div class="tab-content hidden" id="upload-${requirementCode.replace(/[^a-z0-9]/gi, '_')}">
                        <div class="file-upload-area" onclick="document.getElementById('file-${requirementCode.replace(/[^a-z0-9]/gi, '_')}').click()">
                            <i class="fas fa-cloud-upload-alt"></i>
                            <p>Click to upload ${requirementDisplay}</p>
                            <small>PDF, JPG, PNG, DOC files accepted</small>
                        </div>
                        <input type="file" id="file-${requirementCode.replace(/[^a-z0-9]/gi, '_')}" 
                               class="file-input" accept=".pdf,.jpg,.jpeg,.png,.doc,.docx" 
                               onchange="handleFileUpload('${requirementCode}', this)"
                               style="display: none;">
                        <div class="upload-progress hidden" id="progress-${requirementCode.replace(/[^a-z0-9]/gi, '_')}">
                            <div class="progress-bar">
                                <div class="progress-fill"></div>
                            </div>
                            <span class="progress-text">Uploading...</span>
                        </div>
                    </div>
                </div>
            </div>
        `;
        
        container.appendChild(reqDiv);
        
        // Set initial selection using requirement code
        if (req.best_match) {
            selectedCredentials[requirementCode] = req.best_match.id;
        }
    });
}

function selectCredential(requirement, credentialId) {
    selectedCredentials[requirement] = credentialId;
    updateRequirementStatus(requirement, credentialId);
}

function updateRequirementStatus(requirement, credentialId) {
    const reqDiv = document.querySelector(`[data-requirement="${requirement}"]`).closest('.requirement-group');
    const statusSpan = reqDiv.querySelector('.requirement-status');
    
    if (credentialId) {
        statusSpan.textContent = 'âœ“ Selected';
        statusSpan.className = 'requirement-status selected';
    } else {
        const req = credentialsData.requirements.find(r => (r.requirement_code || r.requirement) === requirement);
        statusSpan.textContent = getStatusText(req.status);
        statusSpan.className = `requirement-status ${req.status}`;
    }
}

function getStatusIcon(status) {
    switch(status) {
        case 'available': return 'âœ…';
        case 'missing': return 'âŒ';
        case 'multiple': return 'âš ï¸';
        default: return 'ðŸ“„';
    }
}

function getStatusText(status) {
    switch(status) {
        case 'available': return 'Available';
        case 'missing': return 'Missing';
        case 'multiple': return 'Multiple options';
        default: return 'Unknown';
    }
}

function showTab(requirement, tabType) {
    const reqId = requirement.replace(/[^a-z0-9]/gi, '_');
    const existingTab = document.getElementById(`existing-${reqId}`);
    const uploadTab = document.getElementById(`upload-${reqId}`);
    const existingBtn = existingTab.previousElementSibling.querySelector('.tab-btn:first-child');
    const uploadBtn = existingTab.previousElementSibling.querySelector('.tab-btn:last-child');
    
    if (tabType === 'existing') {
        existingTab.classList.remove('hidden');
        uploadTab.classList.add('hidden');
        existingBtn.classList.add('active');
        uploadBtn.classList.remove('active');
    } else {
        existingTab.classList.add('hidden');
        uploadTab.classList.remove('hidden');
        existingBtn.classList.remove('active');
        uploadBtn.classList.add('active');
    }
}

async function handleFileUpload(requirement, fileInput) {
    const file = fileInput.files[0];
    if (!file) return;
    
    const reqId = requirement.replace(/[^a-z0-9]/gi, '_');
    const progressDiv = document.getElementById(`progress-${reqId}`);
    const uploadArea = fileInput.previousElementSibling;
    
    // Show progress
    progressDiv.classList.remove('hidden');
    uploadArea.style.opacity = '0.5';
    
    // Create form data
    const formData = new FormData();
    formData.append('file', file);
    
    // Find the requirement to get the descriptive name for credential_type
    const req = credentialsData.requirements.find(r => (r.requirement_code || r.requirement) === requirement);
    const credentialType = req ? req.requirement : requirement; // Use descriptive name
    formData.append('credential_type', credentialType);
    
    try {
        const response = await fetch('{{ url_for("students.upload_student_credential") }}', {
            method: 'POST',
            body: formData
        });
        
        const result = await response.json();
        
        if (result.success) {
            // Update the requirement status
            updateRequirementStatus(requirement, 'uploaded');
            
            // Reload credentials data to get the new file
            await loadCredentialsData(document.getElementById('applyScholarshipId').value);
            
            // Show success message
            uploadArea.innerHTML = `
                <i class="fas fa-check-circle" style="color: #28a745;"></i>
                <p>${file.name} uploaded successfully!</p>
                <small>File is now available for selection</small>
            `;
            
            // Switch back to existing tab to show the new file
            setTimeout(() => {
                showTab(requirement, 'existing');
            }, 1500);
            
        } else {
            throw new Error(result.message || 'Upload failed');
        }
        
    } catch (error) {
        console.error('Upload error:', error);
        uploadArea.innerHTML = `
            <i class="fas fa-exclamation-triangle" style="color: #dc3545;"></i>
            <p>Upload failed: ${error.message}</p>
            <small>Please try again</small>
        `;
    } finally {
        progressDiv.classList.add('hidden');
        uploadArea.style.opacity = '1';
    }
}

window.addEventListener('click', (e)=>{ const m=document.getElementById('applyModal'); if(e.target===m){ closeApplication(); }});

document.addEventListener('DOMContentLoaded', ()=>{
  const form = document.getElementById('applyForm');
  form.addEventListener('submit', async (e)=>{
    e.preventDefault();
    const id = document.getElementById('applyScholarshipId').value;
    
    // Prepare form data with selected credentials (empty object if no requirements)
    const formData = new FormData(form);
    formData.append('selected_credentials', JSON.stringify(selectedCredentials || {}));
    
    try {
      const resp = await fetch(`{{ url_for('students.apply_scholarship', scholarship_id=0) }}`.replace('0', id), { 
        method:'POST', 
        body: formData,
        headers:{ 'X-Requested-With':'XMLHttpRequest' } 
      });

      let data = null;
      const isJson = (resp.headers.get('content-type') || '').includes('application/json');
      if (isJson) {
        try { data = await resp.json(); } catch(_) { data = null; }
      } else {
        try { const txt = await resp.text(); data = { success: resp.ok, message: txt }; } catch(_) { data = null; }
      }

      if (!resp.ok || !data || !data.success) {
        let msg = 'Your application could not be submitted.';
        if (data && data.message) {
          msg = data.message;
        }
        closeApplication();
        showPageAlert(msg);
        return;
      }

      // Success
      closeApplication();
      location.reload();
    } catch(err){
      console.error('Application error:', err);
      closeApplication();
      showErrorModal('Failed to apply: ' + err.message);
    }
  });

function showPageAlert(message){
  const alertEl = document.getElementById('pageAlert');
  if (!alertEl) return;
  // Clear existing timer
  if (pageAlertTimer) { clearTimeout(pageAlertTimer); pageAlertTimer = null; }
  // Inject content without inline handlers and bind click
  alertEl.innerHTML = `<div>${message}</div><button class=\"close\" aria-label=\"Close\">&times;</button>`;
  alertEl.style.display = 'flex';
  const btn = alertEl.querySelector('.close');
  if (btn) {
    btn.addEventListener('click', (e)=>{ e.preventDefault(); hidePageAlert(); });
  }
  // Auto-hide after 5 seconds
  pageAlertTimer = setTimeout(()=>{ hidePageAlert(); }, 5000);
  // Scroll to top
  window.scrollTo({ top: 0, behavior: 'smooth' });
}
function hidePageAlert(){
  const el = document.getElementById('pageAlert');
  if (pageAlertTimer) { clearTimeout(pageAlertTimer); pageAlertTimer = null; }
  if (el) { el.style.display='none'; }
}
});
</script>

<!-- Apply Modal -->
<div id="applyModal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <div class="modal-title">Apply to: <span id="applyTitle"></span></div>
      <button class="close" onclick="closeApplication()">&times;</button>
    </div>
    <form id="applyForm">
      <input type="hidden" id="applyScholarshipId" name="scholarship_id">
      <div class="modal-body">
        <div class="section-title">Personal Information</div>
        <div class="form-grid">
          <div class="form-group"><label class="form-label">Full Name</label><input class="form-control" name="full_name" required value="{{ current_user.first_name }} {{ current_user.last_name }}"></div>
          <div class="form-group"><label class="form-label">Student ID Number</label><input class="form-control" name="student_id" required value="{{ current_user.student_id or '' }}"></div>
          <div class="form-group"><label class="form-label">Course</label><input class="form-control" name="course" required value="{{ current_user.course or '' }}"></div>
          <div class="form-group"><label class="form-label">Year Level</label><input class="form-control" name="year_level" required value="{{ current_user.year_level or '' }}"></div>
          <div class="form-group"><label class="form-label">Department</label><input class="form-control" name="department" value="{{ current_user.department or '' }}"></div>
          <div class="form-group"><label class="form-label">School / University</label><input class="form-control" name="school" required value="{{ current_user.school or '' }}"></div>
          <div class="form-group"><label class="form-label">Date of Birth</label><input type="date" class="form-control" name="dob" required value="{{ current_user.birthday.strftime('%Y-%m-%d') if current_user.birthday else '' }}" max="{{ today_date }}"></div>
          <div class="form-group"><label class="form-label">Gender</label>
            <select class="form-control" name="gender">
                <option value="Male" {% if current_user.gender == 'Male' %}selected{% endif %}>Male</option>
                <option value="Female" {% if current_user.gender == 'Female' %}selected{% endif %}>Female</option>
                <option value="Prefer not to say" {% if current_user.gender == 'Prefer not to say' %}selected{% endif %}>Prefer not to say</option>
            </select>
          </div>
          <div class="form-group" style="grid-column:1 / -1"><label class="form-label">Address</label><input class="form-control" name="address" required value="{{ current_user.address or '' }}"></div>
          <div class="form-group"><label class="form-label">Contact Number</label><input class="form-control" name="contact" required value="{{ current_user.contact_number or '' }}"></div>
          <div class="form-group"><label class="form-label">Email</label><input type="email" class="form-control" name="email" required value="{{ current_user.email }}"></div>
        </div>

        <div class="section-title">Family Background</div>
        <div class="form-grid">
          <div class="form-group"><label class="form-label">Parent/Guardian Name</label><input class="form-control" name="guardian" required></div>
          <div class="form-group"><label class="form-label">Occupation</label><input class="form-control" name="occupation"></div>
          <div class="form-group"><label class="form-label">Household Income</label><input class="form-control" name="income" placeholder="Monthly or Annual"></div>
          <div class="form-group"><label class="form-label">Dependents</label><input type="number" min="0" class="form-control" name="dependents"></div>
        </div>

        <div class="section-title">Academic Information</div>
        <div class="form-grid">
          <div class="form-group"><label class="form-label">Latest General Average / GPA</label><input class="form-control" name="gpa"></div>
          <div class="form-group"><label class="form-label">Current Semester</label><input class="form-control" name="semester"></div>
          <div class="form-group"><label class="form-label">School Year</label><input class="form-control" name="school_year"></div>
        </div>

        <div class="section-title">Required Documents</div>
        <div class="credential-picker-info">
            <p class="text-muted">For each requirement, you can either select from your existing credentials or upload a new file directly.</p>
        </div>
        <div id="requiredUploads" class="credential-picker"></div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn secondary" onclick="closeApplication()">Cancel</button>
        <button type="submit" class="btn primary">Submit Application</button>
      </div>
    </form>
  </div>
  
  
{% endblock %}


