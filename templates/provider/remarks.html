{% extends "base.html" %}

{% block title %}Review Remarks - Scholarsphere | Provider{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/main.css') }}">
<style>
    .dashboard-container { display:flex; min-height:100vh; }
    .sidebar { width:280px; background: linear-gradient(135deg, #003366 0%, #0072ce 100%); color:#fff; padding:2rem 0; position:fixed; height:100vh; overflow-y:auto; }
    .sidebar-header { text-align:center; padding:0 2rem 2rem 2rem; border-bottom:1px solid rgba(255,255,255,0.1); }
    .sidebar-logo { width:60px; height:60px; background:#fff; border-radius:50%; margin:0 auto 1rem; display:flex; align-items:center; justify-content:center; overflow:hidden; }
    .sidebar-logo img { width:100%; height:100%; object-fit:cover; border-radius:50%; }
    .sidebar-brand { font-size:1.2rem; font-weight:700; margin-bottom:.5rem; }
    .sidebar-subtitle { font-size:.9rem; opacity:.8; }
    .sidebar-nav { padding:2rem 0; }
    .nav-item { padding:1rem 2rem; cursor:pointer; transition:background .3s; border-left:3px solid transparent; display:flex; align-items:center; overflow:hidden; }
    .nav-item:hover, .nav-item.active { background:rgba(255,255,255,0.1); border-left-color:#ffc72c; }
    .nav-item i { margin-right:1rem; width:20px; text-align:center; flex-shrink:0; }
    .nav-item > *:not(i) { overflow:hidden; text-overflow:ellipsis; white-space:nowrap; }

    .main-content { flex:1; margin-left:280px; padding:2rem; }
    .top-bar { display:flex; justify-content:space-between; align-items:center; margin-bottom:2rem; padding:1rem 0; }
    .welcome-text h1 { font-size:2rem; color:#003366; margin-bottom:.5rem; }
    .welcome-text p { color:#666; }
    
    .remarks-container { display:grid; gap:1.5rem; }
    .remark-card { background:#fff; border-radius:15px; box-shadow:0 4px 20px rgba(0,0,0,0.08); padding:1.5rem; }
    .remark-header { display:flex; justify-content:space-between; align-items:start; margin-bottom:1rem; padding-bottom:1rem; border-bottom:2px solid #e9ecef; }
    .remark-meta h3 { color:#003366; margin-bottom:.5rem; }
    .remark-meta p { color:#666; margin:.25rem 0; font-size:.9rem; }
    .remark-status { padding:.4rem .8rem; border-radius:20px; font-weight:600; font-size:.85rem; }
    .remark-status.review { background:#fff3cd; color:#856404; }
    .remark-status.completed { background:#d4edda; color:#155724; }
    
    .remark-content { background:#f8f9fa; padding:1.5rem; border-radius:10px; border-left:4px solid #007bff; margin-top:1rem; }
    .remark-content p { margin:0; color:#333; line-height:1.6; white-space:pre-wrap; }
    
    .add-remark-btn { background:#007bff; color:#fff; padding:.75rem 1.5rem; border:none; border-radius:10px; cursor:pointer; font-weight:600; margin-bottom:2rem; }
    
    .empty-state { text-align:center; padding:4rem; background:#fff; border-radius:15px; box-shadow:0 4px 20px rgba(0,0,0,0.08); }
    
    .modal { display:none; position:fixed; z-index:1000; left:0; top:0; width:100%; height:100%; background:rgba(0,0,0,0.5); }
    .modal-content { background:#fff; margin:5% auto; padding:0; border-radius:15px; width:90%; max-width:700px; max-height:85vh; overflow:auto; box-shadow:0 10px 30px rgba(0,0,0,0.3); }
    .modal-header { padding:1.5rem; border-bottom:1px solid #e9ecef; background:#f8f9fa; border-radius:15px 15px 0 0; display:flex; justify-content:space-between; align-items:center; }
    .modal-title { margin:0; font-size:1.5rem; color:#003366; font-weight:700; }
    .close { background:none; border:none; font-size:2rem; cursor:pointer; color:#666; padding:0; width:30px; height:30px; }
    .modal-body { padding:2rem; }
    .form-group { margin-bottom:1.5rem; }
    .form-group label { display:block; margin-bottom:.5rem; font-weight:600; color:#333; }
    .form-control { width:100%; padding:.75rem; border:1px solid #ddd; border-radius:8px; font-size:1rem; }
    textarea.form-control { min-height:150px; resize:vertical; }
    .modal-footer { padding:1.5rem; border-top:1px solid #e9ecef; background:#f8f9fa; border-radius:0 0 15px 15px; display:flex; justify-content:flex-end; gap:1rem; }
    .btn-modal { padding:.75rem 1.5rem; border:none; border-radius:8px; font-weight:600; cursor:pointer; }
    .btn-modal.primary { background:#007bff; color:#fff; }
    .btn-modal.secondary { background:#6c757d; color:#fff; }
    
    @media (max-width:1024px){ .sidebar{width:250px;} .main-content{margin-left:250px;} }
    @media (max-width:768px){ .sidebar{transform:translateX(-100%);} .main-content{margin-left:0;} }
</style>
{% endblock %}

{% block content %}
<div class="dashboard-container">
  <!-- Sidebar -->
  <div class="sidebar">
    <div class="sidebar-header">
      <div class="sidebar-logo">
        {% if user.profile_picture %}
          <img id="sidebarProfilePicture" src="{{ url_for('static', filename='uploads/profile_pictures/' + user.profile_picture) }}" alt="Profile Picture">
        {% else %}
          <img id="sidebarProfilePicture" src="{{ url_for('static', filename='images/uc-logo.png') }}" alt="UC Logo">
        {% endif %}
      </div>
      <div class="sidebar-brand">Scholarsphere</div>
      <div class="sidebar-subtitle">{% if user.role == 'provider_admin' %}Provider Admin Portal{% else %}Provider Staff Portal{% endif %}</div>
    </div>
    <nav class="sidebar-nav">
      <div class="nav-item" onclick="window.location.href='{{ url_for('provider.dashboard') }}'"><i class="fas fa-home"></i> Dashboard</div>
      {% if user.role == 'provider_admin' %}
      <div class="nav-item" onclick="window.location.href='{{ url_for('provider.scholarships') }}'"><i class="fas fa-graduation-cap"></i> Manage Scholarships</div>
      {% endif %}
      <div class="nav-item" onclick="window.location.href='{{ url_for('provider.applications') }}'"><i class="fas fa-clipboard-list"></i> Applications</div>
      <div class="nav-item" onclick="window.location.href='{{ url_for('provider.schedules') }}'"><i class="fas fa-calendar-alt"></i> Schedules</div>
      <div class="nav-item" onclick="window.location.href='{{ url_for('provider.documents') }}'"><i class="fas fa-file-alt"></i> Documents</div>
      <div class="nav-item active"><i class="fas fa-comments"></i> Review Remarks</div>
      {% if user.role == 'provider_admin' %}
      <div class="nav-item" onclick="window.location.href='{{ url_for('provider.staff_management') }}'"><i class="fas fa-users-cog"></i> Staff Account Management</div>
      <div class="nav-item" onclick="window.location.href='{{ url_for('provider.reports') }}'"><i class="fas fa-chart-bar"></i> Reports & Analytics</div>
      {% endif %}
      <div class="nav-item" onclick="window.location.href='{{ url_for('provider.profile') }}'"><i class="fas fa-building"></i> {% if user.role == 'provider_staff' %}User Profile{% else %}Organization Profile{% endif %}</div>
      <div class="nav-item" onclick="window.location.href='{{ url_for('logout') }}'"><i class="fas fa-sign-out-alt"></i> Logout</div>
    </nav>
    <div style="padding: 1rem 1.5rem; margin-top: 2rem; border-top: 1px solid rgba(255,255,255,0.1);">
      <button onclick="openProviderGuidelinesModal()" style="background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); color: #fff; padding: 0.75rem 1rem; border-radius: 8px; font-weight: 600; cursor: pointer; font-size: 0.9rem; width: 100%; text-align: center; transition: all 0.3s;">
        <i class="fas fa-info-circle"></i> Guidelines
      </button>
    </div>
  </div>

  <!-- Main Content -->
  <div class="main-content">
    <div class="top-bar">
      <div class="welcome-text">
        <h1>Review Remarks</h1>
        <p>History of application reviews and remarks</p>
      </div>
    </div>

    <button class="add-remark-btn" onclick="openAddRemarkModal()">
      <i class="fas fa-plus"></i> Add New Remark
    </button>

    <div class="remarks-container">
      {% if remarks %}
        {% for remark in remarks %}
        <div class="remark-card">
          <div class="remark-header">
            <div class="remark-meta">
              <h3>{{ remark.student_name }}</h3>
              <p><strong>Application:</strong> {{ remark.application_id }}</p>
              <p><strong>Scholarship:</strong> {{ remark.scholarship_code }} - {{ remark.scholarship_title }}</p>
              <p><strong>Date:</strong> {{ remark.created_date }}</p>
              {% if remark.updated_date %}
              <p><strong>Updated:</strong> {{ remark.updated_date }}</p>
              {% endif %}
            </div>
            <span class="remark-status {{ remark.status.lower() }}">{{ remark.status }}</span>
          </div>
          <div class="remark-content">
            <p>{{ remark.remark_text }}</p>
          </div>
        </div>
        {% endfor %}
      {% else %}
        <div class="empty-state">
          <i class="fas fa-comments" style="font-size:4rem; color:#ddd; margin-bottom:1rem;"></i>
          <h3 style="color:#003366; margin-bottom:.5rem;">No Remarks Yet</h3>
          <p style="color:#666;">Start adding remarks to track your review history.</p>
        </div>
      {% endif %}
    </div>
  </div>
</div>

<!-- Add Remark Modal -->
<div id="addRemarkModal" class="modal" style="display:none;">
  <div class="modal-content">
    <div class="modal-header">
      <h2 class="modal-title">Add Review Remark</h2>
      <button class="close" onclick="closeAddRemarkModal()">&times;</button>
    </div>
    <form id="addRemarkForm">
      <div class="modal-body">
        <div class="form-group">
          <label>Application ID *</label>
          <input type="text" class="form-control" name="application_id" id="remarkApplicationId" placeholder="APP-001" required>
          <small style="color:#666; font-size:.85rem;">Enter the application ID to add a remark</small>
        </div>
        <div class="form-group">
          <label>Remark *</label>
          <textarea class="form-control" name="remark_text" id="remarkText" placeholder="Enter your review remarks, observations, or comments..." required></textarea>
        </div>
        <div class="form-group">
          <label>Status</label>
          <select class="form-control" name="status" id="remarkStatus">
            <option value="review">Under Review</option>
            <option value="completed">Completed</option>
          </select>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn-modal secondary" onclick="closeAddRemarkModal()">Cancel</button>
        <button type="submit" class="btn-modal primary">Add Remark</button>
      </div>
    </form>
  </div>
</div>

<script>
function openAddRemarkModal() {
  document.getElementById('addRemarkModal').style.display = 'block';
}

function closeAddRemarkModal() {
  document.getElementById('addRemarkModal').style.display = 'none';
  document.getElementById('addRemarkForm').reset();
}

document.getElementById('addRemarkForm').addEventListener('submit', async function(e) {
  e.preventDefault();
  
  const applicationId = document.getElementById('remarkApplicationId').value.trim();
  const remarkText = document.getElementById('remarkText').value.trim();
  const status = document.getElementById('remarkStatus').value;
  
  if (!applicationId || !remarkText) {
    showNotification('Please fill in all required fields.', 'error');
    return;
  }
  
  // Extract numeric ID from APP-001 format if needed
  let numericId = applicationId;
  if (applicationId.includes('-') && !isNaN(parseInt(applicationId.split('-')[1]))) {
    numericId = parseInt(applicationId.split('-')[1]);
  } else if (!isNaN(parseInt(applicationId))) {
    numericId = parseInt(applicationId);
  } else {
    showNotification('Invalid application ID format. Please enter APP-001 format or numeric ID.', 'error');
    return;
  }
  
  try {
    const response = await fetch('/provider/api/add-remarks', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        application_id: parseInt(numericId),
        remark_text: remarkText,
        status: status
      })
    });
    
    const data = await response.json();
    
    if (data.success) {
      showNotification('Remark added successfully!', 'success');
      closeAddRemarkModal();
      location.reload();
    } else {
      showNotification('Error: ' + (data.error || 'Failed to add remark'), 'error');
    }
  } catch (error) {
    console.error('Error:', error);
    showNotification('Failed to add remark: ' + error.message, 'error');
  }
});

window.onclick = function(event) {
  const modal = document.getElementById('addRemarkModal');
  if (event.target === modal) closeAddRemarkModal();
}

// Listen for profile picture updates across tabs
window.addEventListener('storage', function(e) {
    if (e.key === 'provider_profile_picture_url') {
        const sidebarImg = document.getElementById('sidebarProfilePicture');
        if (sidebarImg && e.newValue) {
            sidebarImg.src = e.newValue;
        }
    }
});

// Listen for profile picture updates on same page
window.addEventListener('profilePictureUpdated', function(e) {
    const sidebarImg = document.getElementById('sidebarProfilePicture');
    if (sidebarImg && e.detail && e.detail.imageUrl) {
        sidebarImg.src = e.detail.imageUrl;
    }
});
</script>

<!-- Provider Guidelines Modal -->
<div id="providerGuidelinesModal" style="display: none; position: fixed; z-index: 10000; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); overflow: auto;">
    <div style="background: #fff; margin: 5% auto; padding: 0; border-radius: 15px; width: 90%; max-width: 700px; max-height: 85vh; display: flex; flex-direction: column; box-shadow: 0 8px 32px rgba(0,0,0,0.2);">
        <div style="padding: 1.5rem 2rem; border-bottom: 2px solid #e9ecef; display: flex; justify-content: space-between; align-items: center;">
            <h2 style="margin: 0; color: #003366; font-size: 1.8rem;">{% if user.role == 'provider_admin' %}Provider Admin Portal{% else %}Provider Staff Portal{% endif %} Guidelines</h2>
            <button onclick="closeProviderGuidelinesModal()" style="background: none; border: none; font-size: 1.8rem; color: #666; cursor: pointer; padding: 0; width: 32px; height: 32px; display: flex; align-items: center; justify-content: center;">&times;</button>
        </div>
        <div style="padding: 2rem; overflow-y: auto; flex: 1;">
            <h3 style="color: #003366; margin-bottom: 1.5rem; font-size: 1.5rem;">Guidelines for Provider</h3>
            <ul style="list-style: none; padding: 0; margin: 0;">
                <li style="margin-bottom: 1rem; padding-left: 1.5rem; position: relative; line-height: 1.6;">
                    <span style="position: absolute; left: 0; color: #0072ce; font-weight: bold;">•</span>
                    In your dashboard, you can see brief info of the scholarships and number of applicants.
                </li>
                <li style="margin-bottom: 1rem; padding-left: 1.5rem; position: relative; line-height: 1.6;">
                    <span style="position: absolute; left: 0; color: #0072ce; font-weight: bold;">•</span>
                    You can also send announcement to your offered scholarship to those who applied or to a specific student.
                </li>
                <li style="margin-bottom: 1rem; padding-left: 1.5rem; position: relative; line-height: 1.6;">
                    <span style="position: absolute; left: 0; color: #0072ce; font-weight: bold;">•</span>
                    You can create scholarship in "Manage Scholarships". Once created it's marked as draft and click publish to go online. You can also view, update, create a PDF report, and archive.
                </li>
                <li style="margin-bottom: 1rem; padding-left: 1.5rem; position: relative; line-height: 1.6;">
                    <span style="position: absolute; left: 0; color: #0072ce; font-weight: bold;">•</span>
                    Another list will appear if you archive. You can create a PDF report of it as well.
                </li>
                <li style="margin-bottom: 1rem; padding-left: 1.5rem; position: relative; line-height: 1.6;">
                    <span style="position: absolute; left: 0; color: #0072ce; font-weight: bold;">•</span>
                    Once archived, the students who are approved/applying the scholarship will be removed. You can restore it and those students will have to apply again if they want to. An update will be sent to the students accordingly.
                </li>
                <li style="margin-bottom: 1rem; padding-left: 1.5rem; position: relative; line-height: 1.6;">
                    <span style="position: absolute; left: 0; color: #0072ce; font-weight: bold;">•</span>
                    You can check the application of the students of the scholarship you created and view their details. Approve their documents. Approval can happen when you verified all the documents. You can reject anytime.
                </li>
                <li style="margin-bottom: 1rem; padding-left: 1.5rem; position: relative; line-height: 1.6;">
                    <span style="position: absolute; left: 0; color: #0072ce; font-weight: bold;">•</span>
                    You can set appointments to student in schedule page, multiple scheduled appointment can be sent to the student.
                </li>
                <li style="margin-bottom: 1rem; padding-left: 1.5rem; position: relative; line-height: 1.6;">
                    <span style="position: absolute; left: 0; color: #0072ce; font-weight: bold;">•</span>
                    In documents you can search student name or id to check their document, you can check even all the students available even if they are not on your scholarship and you can only view their document.
                </li>
                <li style="margin-bottom: 1rem; padding-left: 1.5rem; position: relative; line-height: 1.6;">
                    <span style="position: absolute; left: 0; color: #0072ce; font-weight: bold;">•</span>
                    In Organization is where your information is and you can update it as well.
                </li>
            </ul>
        </div>
    </div>
</div>

<script>
function openProviderGuidelinesModal() {
    document.getElementById('providerGuidelinesModal').style.display = 'block';
}

function closeProviderGuidelinesModal() {
    document.getElementById('providerGuidelinesModal').style.display = 'none';
}

window.onclick = function(event) {
    const modal = document.getElementById('providerGuidelinesModal');
    if (event.target == modal) {
        closeProviderGuidelinesModal();
    }
}
</script>
{% endblock %}

