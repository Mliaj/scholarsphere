{% extends "base.html" %}

{% block title %}Applications - Scholarsphere | Provider{% endblock %}

{% block extra_css %}
<style>
    .dashboard-container { display:flex; min-height:100vh; }
    .sidebar { width:280px; background: linear-gradient(135deg, #003366 0%, #0072ce 100%); color:#fff; padding:2rem 0; position:fixed; height:100vh; overflow-y:auto; }
    .sidebar-header { text-align:center; padding:0 2rem 2rem 2rem; border-bottom:1px solid rgba(255,255,255,0.1); }
    .sidebar-logo { width:60px; height:60px; background:#fff; border-radius:50%; margin:0 auto 1rem; display:flex; align-items:center; justify-content:center; overflow:hidden; }
    .sidebar-logo img { width:100%; height:100%; object-fit:cover; border-radius:50%; }
    .sidebar-brand { font-size:1.2rem; font-weight:700; margin-bottom:.5rem; }
    .sidebar-subtitle { font-size:.9rem; opacity:.8; }
    .sidebar-nav { padding:2rem 0; }
    .nav-item { padding:1rem 2rem; cursor:pointer; transition:background .3s; border-left:3px solid transparent; }
    .nav-item:hover, .nav-item.active { background:rgba(255,255,255,0.1); border-left-color:#ffc72c; }
    .nav-item i { margin-right:1rem; width:20px; }

    .main-content { flex:1; margin-left:280px; padding:2rem; }
    .top-bar { display:flex; justify-content:space-between; align-items:center; margin-bottom:2rem; padding:1rem 0; }
    .welcome-text h1 { font-size:2rem; color:#003366; margin-bottom:.5rem; }
    .welcome-text p { color:#666; }
    .user-menu { display:flex; align-items:center; gap:1rem; }
    .user-avatar { width:50px; height:50px; border-radius:50%; background:#0072ce; display:flex; align-items:center; justify-content:center; color:#fff; font-weight:600; }

    .stats-bar { display:flex; gap:1.5rem; margin-bottom:2rem; }
    .stat-card { flex:1; background:#fff; border-radius:10px; padding:1.5rem; box-shadow:0 2px 10px rgba(0,0,0,0.05); }
    .stat-label { font-size:0.9rem; color:#666; margin-bottom:0.5rem; }
    .stat-value { font-size:2rem; font-weight:700; color:#0072ce; }

    .scholarship-section { background:#fff; border-radius:15px; box-shadow:0 4px 20px rgba(0,0,0,0.08); margin-bottom:2rem; overflow:hidden; }
    .scholarship-header { padding:1.5rem; background:linear-gradient(135deg, #003366 0%, #0072ce 100%); color:#fff; display:flex; justify-content:space-between; align-items:center; }
    .scholarship-info h3 { font-size:1.3rem; margin-bottom:0.5rem; }
    .scholarship-meta { font-size:0.9rem; opacity:0.9; display:flex; gap:1.5rem; margin-top:0.5rem; }
    .application-count-badge { background:rgba(255,255,255,0.2); padding:0.5rem 1rem; border-radius:20px; font-weight:600; }

    .applications-list { padding:1.5rem; }
    .application-item { padding:1.5rem; border-bottom:1px solid #e9ecef; transition:background 0.2s; }
    .application-item:last-child { border-bottom:none; }
    .application-item:hover { background:#f8f9fa; }
    .application-header { display:flex; justify-content:space-between; align-items:center; margin-bottom:1rem; }
    .student-info h4 { font-size:1.1rem; color:#003366; margin-bottom:0.25rem; }
    .student-info .student-email { color:#666; font-size:0.9rem; }
    .student-info .student-id { color:#0072ce; font-size:0.85rem; font-weight:600; margin-top:0.25rem; }
    
    .application-status { padding:0.4rem 0.8rem; border-radius:20px; font-weight:600; font-size:0.85rem; }
    .application-status.pending { background:#fff3cd; color:#856404; }
    .application-status.approved { background:#d4edda; color:#155724; }
.application-status.rejected { background:#f8d7da; color:#721c24; }
    .application-status.withdrawn { background:#e2e3e5; color:#495057; }
    
    .application-meta { display:flex; gap:1.5rem; font-size:0.9rem; color:#666; margin-top:0.5rem; }
    .application-actions { display:flex; gap:0.5rem; }
    .btn-sm { padding:0.5rem 1rem; border-radius:8px; border:none; cursor:pointer; font-weight:600; font-size:0.85rem; }
    .btn-view { background:#007bff; color:#fff; }
    .btn-view:hover { background:#0056b3; }
    .btn-approve { background:#28a745; color:#fff; }
    .btn-approve:hover { background:#218838; }
    .btn-reject { background:#dc3545; color:#fff; }
    .btn-reject:hover { background:#c82333; }

    .empty-state { text-align:center; padding:4rem 2rem; color:#666; }
    .empty-state i { font-size:4rem; color:#ddd; margin-bottom:1rem; }
    .empty-state h3 { font-size:1.5rem; color:#333; margin-bottom:0.5rem; }

    .applications-container { display:grid; gap:1.5rem; }
    
    /* Modal Styles */
    .modal { display:none; position:fixed; z-index:1000; left:0; top:0; width:100%; height:100%; background:rgba(0,0,0,0.5); }
    .modal-content { background:#fff; margin:2% auto; padding:0; border-radius:15px; width:90%; max-width:800px; max-height:90vh; overflow-y:auto; box-shadow:0 10px 30px rgba(0,0,0,0.3); }
    .modal-header { padding:1.5rem; border-bottom:1px solid #e9ecef; background:#f8f9fa; border-radius:15px 15px 0 0; display:flex; justify-content:space-between; align-items:center; }
    .modal-title { font-size:1.5rem; font-weight:700; color:#003366; margin:0; }
    .close { background:none; border:none; font-size:2rem; color:#666; cursor:pointer; padding:0; width:30px; height:30px; display:flex; align-items:center; justify-content:center; }
    .close:hover { color:#000; }
    .modal-body { padding:2rem; }
    .modal-footer { padding:1.5rem; border-top:1px solid #e9ecef; background:#f8f9fa; border-radius:0 0 15px 15px; display:flex; justify-content:flex-end; gap:1rem; }
    .btn-modal { padding:0.75rem 1.5rem; border:none; border-radius:8px; font-weight:600; cursor:pointer; }
    .btn-modal.primary { background:#007bff; color:#fff; }
    .btn-modal.primary:hover { background:#0056b3; }
    .btn-modal.secondary { background:#6c757d; color:#fff; }
    .btn-modal.secondary:hover { background:#545b62; }
    .form-group { margin-bottom:1.5rem; }
    .form-group label { display:block; margin-bottom:.5rem; font-weight:600; color:#333; }
    .form-control { width:100%; padding:.75rem; border:1px solid #ddd; border-radius:8px; font-size:1rem; box-sizing:border-box; }
    .form-control:focus { outline:none; border-color:#007bff; }
    
    /* Autocomplete styles */
    .autocomplete-suggestions { position:absolute; top:100%; left:0; right:0; background:#fff; border:1px solid #ddd; border-top:none; border-radius:0 0 8px 8px; max-height:300px; overflow-y:auto; z-index:1000; box-shadow:0 4px 6px rgba(0,0,0,0.1); }
    .autocomplete-suggestion { padding:0.75rem; cursor:pointer; border-bottom:1px solid #f0f0f0; transition:background 0.2s; }
    .autocomplete-suggestion:hover { background:#f8f9fa; }
    .autocomplete-suggestion:last-child { border-bottom:none; }
    .autocomplete-suggestion.active { background:#e3f2fd; }
    
    /* Animation for highlighting unverified documents */
    @keyframes pulse {
        0%, 100% { opacity: 1; }
        50% { opacity: 0.7; }
    }
    
    @media (max-width:1024px){ .sidebar{width:250px;} .main-content{margin-left:250px;} }
    @media (max-width:768px){ .sidebar{transform:translateX(-100%); transition:transform .3s;} .sidebar.open{transform:translateX(0);} .main-content{margin-left:0;} .stats-bar{flex-direction:column;} }
    
    /* PDF Modal Styles */
    .btn-pdf:hover { transform:translateY(-2px); box-shadow:0 4px 12px rgba(220,53,69,0.4); }
    .pdf-modal { display:none; position:fixed; z-index:1001; left:0; top:0; width:100%; height:100%; background:rgba(0,0,0,0.6); animation:fadeIn 0.2s ease; }
    .pdf-modal-content { background:#fff; margin:5% auto; padding:0; border-radius:15px; width:90%; max-width:500px; box-shadow:0 10px 40px rgba(0,0,0,0.2); animation:slideDown 0.3s ease; }
    @keyframes fadeIn {
        from { opacity:0; }
        to { opacity:1; }
    }
    @keyframes slideDown {
        from { transform:translateY(-30px); opacity:0; }
        to { transform:translateY(0); opacity:1; }
    }
    .pdf-modal-header {
        padding:1.5rem;
        background:linear-gradient(135deg, #dc3545 0%, #c82333 100%);
        border-radius:15px 15px 0 0;
        display:flex;
        justify-content:space-between;
        align-items:center;
    }
    .pdf-modal-header h3 {
        margin:0;
        font-size:1.3rem;
        color:#fff;
        font-weight:700;
    }
    .pdf-modal-body {
        padding:2rem 1.5rem;
    }
    .pdf-modal-body label {
        display:block;
        margin-bottom:0.75rem;
        font-weight:600;
        color:#333;
        font-size:0.95rem;
    }
    .pdf-modal-body select {
        width:100%;
        padding:0.75rem;
        border:2px solid #ddd;
        border-radius:8px;
        font-size:1rem;
        background:#fff;
        cursor:pointer;
        transition:border-color 0.3s;
    }
    .pdf-modal-body select:focus {
        outline:none;
        border-color:#dc3545;
    }
    .pdf-modal-footer {
        padding:1rem 1.5rem 1.5rem;
        display:flex;
        justify-content:flex-end;
        gap:0.75rem;
    }
    .pdf-btn {
        padding:0.75rem 1.5rem;
        border:none;
        border-radius:8px;
        cursor:pointer;
        font-weight:600;
        font-size:0.95rem;
        transition:all 0.3s ease;
    }
    .pdf-btn-cancel {
        background:#e9ecef;
        color:#495057;
    }
    .pdf-btn-cancel:hover {
        background:#dee2e6;
    }
    .pdf-btn-generate {
        background:linear-gradient(135deg, #dc3545 0%, #c82333 100%);
        color:#fff;
        box-shadow:0 2px 8px rgba(220,53,69,0.3);
    }
    .pdf-btn-generate:hover {
        transform:translateY(-1px);
        box-shadow:0 4px 12px rgba(220,53,69,0.4);
    }
    .pdf-btn-generate:disabled {
        opacity:0.6;
        cursor:not-allowed;
        transform:none;
    }
</style>
{% endblock %}

{% block content %}
<div class="dashboard-container">
  <!-- Sidebar -->
  <div class="sidebar">
    <div class="sidebar-header">
      <div class="sidebar-logo">
        {% if user.profile_picture %}
          <img id="sidebarProfilePicture" src="{{ url_for('static', filename='uploads/profile_pictures/' + user.profile_picture) }}" alt="Profile Picture">
        {% else %}
          <img id="sidebarProfilePicture" src="{{ url_for('static', filename='images/uc-logo.png') }}" alt="UC Logo">
        {% endif %}
      </div>
      <div class="sidebar-brand">Scholarsphere</div>
      <div class="sidebar-subtitle">Provider Portal</div>
    </div>
    <nav class="sidebar-nav">
      <div class="nav-item" onclick="window.location.href='{{ url_for('provider.dashboard') }}'"><i class="fas fa-home"></i> Dashboard</div>
      <div class="nav-item" onclick="window.location.href='{{ url_for('provider.scholarships') }}'"><i class="fas fa-graduation-cap"></i> Manage Scholarships</div>
      <div class="nav-item active"><i class="fas fa-clipboard-list"></i> Applications</div>
      <div class="nav-item" onclick="window.location.href='{{ url_for('provider.schedules') }}'"><i class="fas fa-calendar-alt"></i> Schedules</div>
      <div class="nav-item" onclick="window.location.href='{{ url_for('provider.documents') }}'"><i class="fas fa-file-alt"></i> Documents</div>
      <div class="nav-item" onclick="window.location.href='{{ url_for('provider.profile') }}'"><i class="fas fa-building"></i> Organization Profile</div>
      <div class="nav-item" onclick="window.location.href='{{ url_for('logout') }}'"><i class="fas fa-sign-out-alt"></i> Logout</div>
    </nav>
    <div style="padding: 1rem 1.5rem; margin-top: 2rem; border-top: 1px solid rgba(255,255,255,0.1);">
      <button onclick="openProviderGuidelinesModal()" style="background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); color: #fff; padding: 0.75rem 1rem; border-radius: 8px; font-weight: 600; cursor: pointer; font-size: 0.9rem; width: 100%; text-align: center; transition: all 0.3s;">
        <i class="fas fa-info-circle"></i> Guidelines
      </button>
    </div>
  </div>

  <!-- Main Content -->
  <div class="main-content">
    <div class="top-bar">
      <div class="welcome-text">
        <h1>Student Applications</h1>
        <p>Review and manage applications for your scholarship offers</p>
      </div>
      <div class="user-menu" style="display:flex; gap:0.75rem; align-items:center;">
        <button class="btn-pdf" onclick="openPDFModal()" style="padding:0.75rem 1.5rem; background:linear-gradient(135deg, #dc3545 0%, #c82333 100%); color:#fff; border:none; border-radius:8px; font-weight:600; cursor:pointer; display:flex; align-items:center; gap:0.5rem; transition:all 0.3s; box-shadow:0 2px 8px rgba(220,53,69,0.3);">
          <i class="fas fa-file-pdf"></i> Generate PDF
        </button>
        <div class="user-avatar">UC</div>
      </div>
    </div>

    <!-- Statistics Bar -->
    <div class="stats-bar">
      <div class="stat-card">
        <div class="stat-label">Total Applications</div>
        <div class="stat-value">{{ total_applications }}</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">Active Scholarships</div>
        <div class="stat-value">{{ scholarships|length }}</div>
      </div>
    </div>

    <!-- Applications by Scholarship -->
    <div class="filter-bar" style="margin-bottom:1rem; display:flex; justify-content:space-between; gap:0.75rem; align-items:center; flex-wrap:wrap;">
      <div style="display:flex; gap:0.75rem; align-items:center; flex-wrap:wrap; flex:1;">
        <div style="position:relative; flex:1; min-width:250px; max-width:350px;">
          <label for="scholarshipSearch" style="font-size:0.9rem; color:#555; display:block; margin-bottom:0.25rem;">
            Search Scholarship:
          </label>
          <div style="position:relative;">
            <input type="text" id="scholarshipSearch" class="form-control" placeholder="Type to search scholarships..." autocomplete="off" style="width:100%; padding-right:35px;">
            <button type="button" id="clearScholarshipSearch" style="position:absolute; right:8px; top:50%; transform:translateY(-50%); background:none; border:none; color:#999; cursor:pointer; display:none; font-size:1.2rem; padding:0; width:24px; height:24px;" title="Clear">×</button>
          </div>
          <div id="scholarshipSuggestions" class="autocomplete-suggestions" style="display:none;"></div>
        </div>
        <div style="position:relative; flex:1; min-width:250px; max-width:350px;">
          <label for="studentSearch" style="font-size:0.9rem; color:#555; display:block; margin-bottom:0.25rem;">
            Search Student:
          </label>
          <div style="position:relative;">
            <input type="text" id="studentSearch" class="form-control" placeholder="Type to search students..." autocomplete="off" style="width:100%; padding-right:35px;">
            <button type="button" id="clearStudentSearch" style="position:absolute; right:8px; top:50%; transform:translateY(-50%); background:none; border:none; color:#999; cursor:pointer; display:none; font-size:1.2rem; padding:0; width:24px; height:24px;" title="Clear">×</button>
          </div>
          <div id="studentSuggestions" class="autocomplete-suggestions" style="display:none;"></div>
        </div>
      </div>
      <div style="display:flex; gap:0.75rem; align-items:center;">
        <label for="statusFilter" style="font-size:0.9rem; color:#555;">
          Filter by status:
        </label>
        <select id="statusFilter" class="form-control" style="max-width: 180px;">
          <option value="all">All statuses</option>
          <option value="pending">Pending</option>
          <option value="approved">Approved</option>
          <option value="rejected">Rejected</option>
          <option value="withdrawn">Withdrawn</option>
        </select>
      </div>
    </div>

    <div class="applications-container">
      {% if scholarships %}
        {% for scholarship in scholarships %}
        <div class="scholarship-section" data-scholarship-id="{{ scholarship.id }}" data-scholarship-title="{{ scholarship.title|lower }}" data-scholarship-code="{{ scholarship.code|lower }}">
          <div class="scholarship-header">
            <div class="scholarship-info">
              <h3>{{ scholarship.title }}</h3>
              <div class="scholarship-meta">
                <span><i class="fas fa-id-card"></i> {{ scholarship.code }}</span>
                <span><i class="fas fa-calendar"></i> Deadline: {{ scholarship.deadline }}</span>
              </div>
            </div>
            <div class="application-count-badge">
              {{ scholarship.application_count }} {{ 'application' if scholarship.application_count == 1 else 'applications' }}
            </div>
          </div>
          
          {% if scholarship.display_applications %}
          <div class="applications-list">
            {% for app in scholarship.display_applications %}
            <div class="application-item" data-status="{{ app.status.lower() }}" data-student-name="{{ app.student_name|lower }}" data-student-email="{{ app.student_email|lower }}" data-student-id="{{ app.student_id|lower if app.student_id else '' }}" data-user-id="{{ app.user_id }}" data-scholarship-id="{{ scholarship.id }}">
              <div class="application-header">
                <div class="student-info">
                  <h4>{{ app.student_name }}</h4>
                  <div class="student-email">{{ app.student_email }}</div>
                  {% if app.student_id %}
                  <div class="student-id">Student ID: {{ app.student_id }}</div>
                  {% endif %}
                </div>
                <div class="application-actions">
                  <span class="application-status {{ app.status.lower() }}">{{ app.status }}</span>
                  <button class="btn-sm btn-view" onclick="viewApplication({{ app.application_id }})">
                    <i class="fas fa-eye"></i> View Details
                  </button>
                  <button class="btn-sm" onclick="openRemarksModal({{ app.user_id }}, '{{ app.student_name }}')" style="background:#6c757d; color:#fff; border:none; padding:0.4rem 0.8rem; border-radius:6px; cursor:pointer; font-size:0.85rem; margin-left:0.5rem;">
                    <i class="fas fa-comment"></i> Remarks
                  </button>
                  {% if app.status.lower() == 'pending' %}
                  <button class="btn-sm btn-approve" onclick="reviewApplication({{ app.application_id }}, 'approve')">
                    <i class="fas fa-check"></i> Approve
                  </button>
                  <button class="btn-sm btn-reject" onclick="reviewApplication({{ app.application_id }}, 'reject')">
                    <i class="fas fa-times"></i> Reject
                  </button>
                  {% endif %}
                </div>
              </div>
              <div class="application-meta">
                <span><i class="fas fa-calendar"></i> Applied: {{ app.date_applied }}</span>
                <span><i class="fas fa-file-alt"></i> Documents: {{ app.file_count }} file(s)</span>
              </div>
            </div>
            {% endfor %}
          </div>
          {% else %}
          <div class="empty-state">
            <i class="fas fa-inbox"></i>
            <h3>No applications yet</h3>
            <p>No students have applied to this scholarship.</p>
          </div>
          {% endif %}
        </div>
        {% endfor %}
      {% else %}
      <div class="empty-state">
        <i class="fas fa-clipboard-list"></i>
        <h3>No applications received</h3>
        <p>You haven't received any applications yet. Start by creating and publishing scholarship offers.</p>
      </div>
      {% endif %}
    </div>
  </div>
</div>

<!-- Application Details Modal -->
<div id="applicationDetailsModal" class="modal" style="display:none;">
  <div class="modal-content" style="max-width:800px;">
    <div class="modal-header">
      <h2 class="modal-title">Application Details</h2>
      <button class="close" onclick="closeApplicationModal()">&times;</button>
    </div>
    <div class="modal-body" id="applicationDetailsContent">
      <!-- Content loaded dynamically -->
    </div>
    <div class="modal-footer">
      <button type="button" class="btn-modal secondary" onclick="closeApplicationModal()">Close</button>
    </div>
</div>
</div>

<!-- Review Confirmation Modal -->
<div id="reviewConfirmModal" class="modal" style="display:none;">
  <div class="modal-content" style="max-width:600px;">
    <div class="modal-header">
      <h2 class="modal-title">Application Reviewed</h2>
      <button class="close" onclick="closeReviewConfirm()">&times;</button>
    </div>
    <div class="modal-body" id="reviewConfirmBody" style="padding:2rem;"></div>
    <div class="modal-footer">
      <button type="button" class="btn-modal secondary" onclick="closeReviewConfirm()">Close</button>
    </div>
  </div>
</div>

<!-- Student Remarks Modal -->
<div id="remarksModal" class="modal" style="display:none;">
  <div class="modal-content" style="max-width:700px;">
    <div class="modal-header">
      <h2 class="modal-title">Student Remarks</h2>
      <button class="close" onclick="closeRemarksModal()">&times;</button>
    </div>
    <div class="modal-body" style="padding:2rem;">
      <div id="remarksStudentInfo" style="margin-bottom:1.5rem; padding-bottom:1rem; border-bottom:1px solid #e9ecef;">
        <h3 style="margin:0; color:#003366;" id="remarksStudentName"></h3>
      </div>
      <div style="margin-bottom:1.5rem;">
        <h4 style="color:#003366; margin-bottom:0.75rem;">Add New Remark</h4>
        <textarea id="newRemarkText" placeholder="Enter your remark about this student..." style="width:100%; min-height:100px; padding:0.75rem; border:1px solid #ddd; border-radius:6px; font-family:inherit; font-size:0.9rem;" required></textarea>
        <button onclick="addRemark()" style="margin-top:0.75rem; background:#007bff; color:#fff; border:none; padding:0.6rem 1.2rem; border-radius:6px; cursor:pointer; font-weight:600;">
          <i class="fas fa-plus"></i> Add Remark
        </button>
      </div>
      <div>
        <h4 style="color:#003366; margin-bottom:0.75rem;">Previous Remarks</h4>
        <div id="remarksList" style="max-height:400px; overflow-y:auto;">
          <p style="color:#666; font-style:italic;">Loading remarks...</p>
        </div>
      </div>
    </div>
    <div class="modal-footer">
      <button type="button" class="btn-modal secondary" onclick="closeRemarksModal()">Close</button>
    </div>
  </div>
</div>

<script>
// Track verification state for the current application view
let currentAppVerification = {
    id: null,
    total: 0,
    verifiedCount: 0
};

const REQUIREMENT_MAPPINGS = {
    'photo_2x2': 'Recent 2x2 or passport-size photo',
    'valid_id': 'Valid School ID or any government-issued ID',
    'enrollment_cert': 'Certificate of Enrollment',
    'report_card': 'Report Card / Transcript of Records (TOR)',
    'good_moral': 'Certificate of Good Moral Character',
    'recommendation_letter': 'Recommendation Letter',
    'honors_awards': 'Honors or Awards Certificates',
    'indigency_cert': 'Certificate of Indigency',
    'itr': "Parents' or Guardians' Income Tax Return (ITR)",
    'proof_income': 'Proof of Income',
    'barangay_clearance': 'Barangay Clearance or Residency Certificate',
    'birth_cert': 'Birth Certificate (PSA or NSO)',
    'medical_cert': 'Medical Certificate'
};

function closeApplicationModal() {
  document.getElementById('applicationDetailsModal').style.display = 'none';
  // Do not reset state here, so we can approve from the list view immediately after closing
}

function closeReviewConfirm() {
  document.getElementById('reviewConfirmModal').style.display = 'none';
  location.reload();
}

function viewApplication(applicationId) {
  fetch(`/provider/api/application/${applicationId}`)
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        // Initialize verification state based on API data
        currentAppVerification.id = applicationId;
        // Only count active credentials towards the total required for approval
        currentAppVerification.total = (data.credentials) ? data.credentials.filter(c => c.is_active).length : 0;
        currentAppVerification.verifiedCount = 0;

        const content = document.getElementById('applicationDetailsContent');
        
        let credentialsHtml = '<div><strong>No documents submitted yet.</strong></div>';
        
        if (data.credentials && data.credentials.length > 0) {
            const rows = data.credentials.map((cred) => {
                const reqLabel = REQUIREMENT_MAPPINGS[cred.requirement_type] || cred.requirement_type;
                
                // Handle deleted credentials
                if (!cred.is_active) {
                    return `
                      <div style="padding:1rem; background:#fff5f5; border:1px dashed #dc3545; border-radius:8px; display:flex; justify-content:space-between; align-items:center;">
                        <div>
                          <strong>${reqLabel}</strong>
                          <div style="font-size:0.9rem; color:#dc3545;">Deleted - waiting for new document to be uploaded</div>
                        </div>
                        <div style="display:flex; gap:0.5rem;">
                          <button class="btn-sm btn-view" disabled style="opacity:0.5; cursor:not-allowed;">View</button>
                          <button class="btn-sm btn-approve" disabled style="opacity:0.5; cursor:not-allowed;">Verify</button>
                        </div>
                      </div>
                    `;
                }

                const isVerified = cred.is_verified; // Use the explicit boolean from backend
                
                if (isVerified) {
                    currentAppVerification.verifiedCount++;
                }

                const btnHtml = isVerified 
                    ? `<button class="btn-sm btn-approve" disabled style="opacity:0.6; cursor:not-allowed;"><i class="fas fa-check-circle"></i> Verified</button>`
                    : `<button class="btn-sm btn-approve" id="verifyBtn-${cred.id}" onclick="verifyDocument(${cred.id}, 'verifyBtn-${cred.id}')"><i class="fas fa-check"></i> Verify</button>`;

                return `
                  <div style="padding:1rem; background:#f8f9fa; border-radius:8px; display:flex; justify-content:space-between; align-items:center;">
                    <div>
                      <strong>${reqLabel}</strong>
                      <div style="font-size:0.9rem; color:#666;">${cred.file_name}</div>
                    </div>
                    <div style="display:flex; gap:0.5rem;">
                      <button class="btn-sm btn-view" onclick="window.open('/static/uploads/credentials/${cred.file_path}', '_blank')">
                        <i class="fas fa-download"></i> View
                      </button>
                      ${btnHtml}
                    </div>
                  </div>
                `;
            }).join('');
            
            credentialsHtml = `
              <div>
                <h3 style="color:#003366; margin-bottom:1rem;">Submitted Documents</h3>
                <div style="margin-bottom:0.75rem; font-size:0.9rem; color:#555;" id="docsStatus">
                  Documents verified: <strong>${currentAppVerification.verifiedCount} of ${currentAppVerification.total}</strong>
                </div>
                <div style="display:grid; gap:0.75rem;">
                    ${rows}
                </div>
              </div>`;
        }

        // Build Personal Information section
        let personalInfoHtml = '';
        if (data.personal_information) {
          const pi = data.personal_information;
          personalInfoHtml = `
            <div>
              <h3 style="color:#003366; margin-bottom:1rem;">Personal Information</h3>
              <div style="display:grid; gap:0.75rem;">
                ${pi.department ? `<div><strong>Department:</strong> ${pi.department}</div>` : ''}
                ${pi.school_university ? `<div><strong>School/University:</strong> ${pi.school_university}</div>` : ''}
                ${pi.address ? `<div><strong>Address:</strong> ${pi.address}</div>` : ''}
                ${pi.contact_number ? `<div><strong>Contact Number:</strong> ${pi.contact_number}</div>` : ''}
              </div>
            </div>
          `;
        }
        
        // Build Family Background section
        let familyBgHtml = '';
        if (data.family_background) {
          const fb = data.family_background;
          familyBgHtml = `
            <div>
              <h3 style="color:#003366; margin-bottom:1rem;">Family Background</h3>
              <div style="display:grid; gap:0.75rem;">
                ${fb.parent_guardian_name ? `<div><strong>Parent/Guardian Name:</strong> ${fb.parent_guardian_name}</div>` : ''}
                ${fb.occupation ? `<div><strong>Occupation:</strong> ${fb.occupation}</div>` : ''}
                ${fb.household_income ? `<div><strong>Household Income:</strong> ${fb.household_income}</div>` : ''}
                ${fb.dependents !== '' && fb.dependents !== null ? `<div><strong>Dependents:</strong> ${fb.dependents}</div>` : ''}
              </div>
            </div>
          `;
        }
        
        // Build Academic Information section
        let academicInfoHtml = '';
        if (data.academic_information) {
          const ai = data.academic_information;
          academicInfoHtml = `
            <div>
              <h3 style="color:#003366; margin-bottom:1rem;">Academic Information</h3>
              <div style="display:grid; gap:0.75rem;">
                ${ai.latest_gpa ? `<div><strong>Latest GPA:</strong> ${ai.latest_gpa}</div>` : ''}
                ${ai.current_semester ? `<div><strong>Current Semester:</strong> ${ai.current_semester}</div>` : ''}
                ${ai.school_year ? `<div><strong>School Year:</strong> ${ai.school_year}</div>` : ''}
              </div>
            </div>
          `;
        }
        
        // Build Remarks section
        let remarksHtml = '';
        if (data.remarks && data.remarks.length > 0) {
          const remarksList = data.remarks.map(remark => {
            const date = new Date(remark.created_at);
            const formattedDate = date.toLocaleString('en-US', {
              year: 'numeric',
              month: 'short',
              day: 'numeric',
              hour: '2-digit',
              minute: '2-digit'
            });
            return `
              <div style="background:#f8f9fa; padding:1rem; margin-bottom:0.75rem; border-radius:6px; border-left:4px solid #007bff;">
                <div style="color:#666; font-size:0.85rem; margin-bottom:0.5rem;">${formattedDate}</div>
                <div style="color:#333; white-space:pre-wrap;">${remark.remark_text}</div>
              </div>
            `;
          }).join('');
          remarksHtml = `
            <div>
              <h3 style="color:#003366; margin-bottom:1rem;">Your Remarks</h3>
              <div style="max-height:300px; overflow-y:auto;">
                ${remarksList}
              </div>
            </div>
          `;
        } else {
          remarksHtml = `
            <div>
              <h3 style="color:#003366; margin-bottom:1rem;">Your Remarks</h3>
              <div style="color:#666; font-style:italic;">No remarks yet. Use the "Remarks" button on the applications list to add remarks about this student.</div>
            </div>
          `;
        }
        
        content.innerHTML = `
          <div style="display:grid; gap:1.5rem;">
            <div>
              <h3 style="color:#003366; margin-bottom:1rem;">Student Information</h3>
              <div style="display:grid; gap:0.75rem;">
                <div><strong>Name:</strong> ${data.application.student_name}</div>
                <div><strong>Email:</strong> ${data.application.student_email}</div>
                ${data.application.student_id ? `<div><strong>Student ID:</strong> ${data.application.student_id}</div>` : ''}
              </div>
            </div>
            <div>
              <h3 style="color:#003366; margin-bottom:1rem;">Application Details</h3>
              <div style="display:grid; gap:0.75rem;">
                <div><strong>Scholarship:</strong> ${data.application.scholarship_title}</div>
                <div><strong>Date Applied:</strong> ${data.application.date_applied}</div>
                <div><strong>Status:</strong> <span class="application-status ${data.application.status.toLowerCase()}">${data.application.status}</span></div>
              </div>
            </div>
            ${personalInfoHtml}
            ${familyBgHtml}
            ${academicInfoHtml}
            ${credentialsHtml}
            ${remarksHtml}
          </div>
        `;

        document.getElementById('applicationDetailsModal').style.display = 'block';
      } else {
        showNotification('Error loading application details: ' + (data.error || 'Unknown error'), 'error');
      }
    })
    .catch(error => {
      console.error('Error:', error);
      showNotification('Error loading application details', 'error');
    });
}

function verifyDocument(credentialId, btnId) {
  const btn = document.getElementById(btnId);
  const originalContent = btn.innerHTML;
  btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
  btn.disabled = true;

  fetch(`/provider/api/credential/${credentialId}/review`, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ action: 'approve' })
  })
  .then(r => r.json())
  .then(data => {
    if (data.success) {
        btn.innerHTML = '<i class="fas fa-check-circle"></i> Verified';
        btn.style.opacity = '0.6';
        btn.style.cursor = 'not-allowed';
        btn.disabled = true;
        // Remove highlight from verified button
        btn.style.animation = '';
        btn.style.border = '';
        btn.style.boxShadow = '';
        
        currentAppVerification.verifiedCount++;
        const statusEl = document.getElementById('docsStatus');
        if (statusEl) {
            statusEl.innerHTML = `Documents verified: <strong>${currentAppVerification.verifiedCount} of ${currentAppVerification.total}</strong>`;
            // Update status color based on verification count
            if (currentAppVerification.verifiedCount >= currentAppVerification.total) {
                statusEl.style.color = '#28a745';
                statusEl.style.fontWeight = 'bold';
                statusEl.style.animation = '';
            } else {
                statusEl.style.color = '#dc3545';
                statusEl.style.fontWeight = 'bold';
            }
        }
        showNotification('Document verified successfully.', 'success');
        
        // Check if all documents are now verified and remove remaining highlights
        if (currentAppVerification.verifiedCount >= currentAppVerification.total) {
            // All verified - remove any remaining highlights
            highlightUnverifiedDocuments();
        }
    } else {
        btn.innerHTML = originalContent;
        btn.disabled = false;
        showNotification('Verification failed: ' + (data.error || 'Unknown error'), 'error');
    }
  })
  .catch(err => {
    console.error(err);
    btn.innerHTML = originalContent;
    btn.disabled = false;
    showNotification('Verification failed. Check connection.', 'error');
  });
}

function reviewApplication(applicationId, action) {
  if (action === 'approve') {
    // Check if documents are verified
    let needsVerification = false;
    
    // Always re-check verification status, especially if modal is open
    // If modal is open for this app, use live count (which may have been updated)
    if (currentAppVerification.id === applicationId) {
        // Re-count verified documents from the DOM to ensure accuracy
        const modalContent = document.getElementById('applicationDetailsContent');
        if (modalContent) {
            // Count verified buttons (disabled verify buttons are verified)
            const verifiedButtons = modalContent.querySelectorAll('button[id^="verifyBtn-"]:disabled');
            const totalButtons = modalContent.querySelectorAll('button[id^="verifyBtn-"]');
            const activeCredentials = Array.from(totalButtons).filter(btn => {
                // Check if parent container is not the deleted credential style
                const parent = btn.closest('div[style*="background"]');
                if (parent && parent.style.background.includes('#fff5f5')) {
                    return false; // Deleted credential
                }
                return true;
            }).length;
            
            // Update counts based on actual DOM state
            currentAppVerification.verifiedCount = verifiedButtons.length;
            currentAppVerification.total = activeCredentials;
        }
        
        if (currentAppVerification.total > 0 && currentAppVerification.verifiedCount < currentAppVerification.total) {
            needsVerification = true;
        }
    } else {
        // Modal not open - open it first and check verification status
        viewApplication(applicationId);
        // Wait for modal to load, then check and highlight
        setTimeout(() => {
            if (currentAppVerification.total > 0 && currentAppVerification.verifiedCount < currentAppVerification.total) {
                highlightUnverifiedDocuments();
                showNotification('Please verify all documents before approving. Unverified documents are highlighted below.', 'warning');
            }
        }, 500);
        return;
    }
    
    // If documents need verification, ensure modal is displayed and highlighted
    if (needsVerification) {
        // Ensure modal is open (should already be open, but just in case)
        const modal = document.getElementById('applicationDetailsModal');
        if (modal && modal.style.display === 'none') {
            viewApplication(applicationId);
            setTimeout(() => {
                highlightUnverifiedDocuments();
            }, 300);
        } else {
            highlightUnverifiedDocuments();
        }
        showNotification('Please verify all documents before approving. Unverified documents are highlighted below.', 'warning');
        return;
    }
  }

  const actionText = action === 'approve' ? 'approve' : 'reject';
  if (confirm(`Are you sure you want to ${actionText} this application? This action cannot be undone.`)) {
    proceedWithReview(applicationId, action);
  }
}

function highlightUnverifiedDocuments() {
  // Highlight unverified document buttons in the modal
  const modalContent = document.getElementById('applicationDetailsContent');
  if (!modalContent) return;
  
  // First, remove any existing highlights
  const allButtons = modalContent.querySelectorAll('button[id^="verifyBtn-"]');
  allButtons.forEach(btn => {
    btn.style.animation = '';
    btn.style.border = '';
    btn.style.boxShadow = '';
  });
  
  // Find all verify buttons that are not disabled (i.e., not verified)
  const verifyButtons = modalContent.querySelectorAll('button[id^="verifyBtn-"]:not([disabled])');
  verifyButtons.forEach(btn => {
    // Add a pulsing highlight effect
    btn.style.animation = 'pulse 2s infinite';
    btn.style.border = '2px solid #ffc107';
    btn.style.boxShadow = '0 0 10px rgba(255, 193, 7, 0.5)';
  });
  
  // Also highlight the documents status message
  const docsStatus = document.getElementById('docsStatus');
  if (docsStatus) {
    const originalColor = docsStatus.style.color || '';
    if (currentAppVerification.verifiedCount < currentAppVerification.total) {
      docsStatus.style.color = '#dc3545';
      docsStatus.style.fontWeight = 'bold';
      docsStatus.style.animation = 'pulse 2s infinite';
    } else {
      docsStatus.style.color = originalColor || '#555';
      docsStatus.style.fontWeight = '';
      docsStatus.style.animation = '';
    }
  }
  
  // Scroll to the documents section if needed
  const docsSection = modalContent.querySelector('h3');
  if (docsSection && verifyButtons.length > 0) {
    docsSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
  }
}

function proceedWithReview(applicationId, action) {
  fetch(`/provider/api/application/${applicationId}/review`, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ action: action })
  })
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        const body = document.getElementById('reviewConfirmBody');
        body.innerHTML = `<div style="display:grid; gap:.75rem;">
          <div><strong>Application:</strong> APP-${String(applicationId).padStart(3,'0')}</div>
          <div><strong>Result:</strong> ${action==='approve'?'Approved':'Rejected'}</div>
          <div>The student has been notified.</div>
        </div>`;
        document.getElementById('reviewConfirmModal').style.display = 'block';
      } else {
        showNotification('Error: ' + (data.error || 'Unknown error'), 'error');
      }
    })
    .catch(error => {
      console.error('Error:', error);
      showNotification('Error processing application.', 'error');
    });
}

// Search state
let selectedScholarshipId = null;
let selectedStudentId = null;

// Autocomplete functionality for scholarships
function setupScholarshipAutocomplete() {
  const input = document.getElementById('scholarshipSearch');
  const suggestions = document.getElementById('scholarshipSuggestions');
  let debounceTimer;
  let selectedIndex = -1;
  let currentSuggestions = [];

  if (!input || !suggestions) return;

  input.addEventListener('input', function() {
    const query = this.value.trim();
    clearTimeout(debounceTimer);
    selectedIndex = -1;

    if (query.length < 2) {
      suggestions.style.display = 'none';
      selectedScholarshipId = null;
      applyFilters();
      return;
    }

    debounceTimer = setTimeout(() => {
      fetch(`/provider/api/scholarships/search?q=${encodeURIComponent(query)}`)
        .then(response => response.json())
        .then(data => {
          currentSuggestions = data;
          if (data.length === 0) {
            suggestions.style.display = 'none';
            return;
          }

          suggestions.innerHTML = data.map((item, index) => 
            `<div class="autocomplete-suggestion" data-index="${index}" data-id="${item.id}">${item.display}</div>`
          ).join('');
          suggestions.style.display = 'block';
        })
        .catch(error => {
          console.error('Error fetching scholarships:', error);
          suggestions.style.display = 'none';
        });
    }, 300);
  });

  input.addEventListener('keydown', function(e) {
    if (suggestions.style.display === 'none') return;

    const items = suggestions.querySelectorAll('.autocomplete-suggestion');
    if (e.key === 'ArrowDown') {
      e.preventDefault();
      selectedIndex = Math.min(selectedIndex + 1, items.length - 1);
      updateSelection(items);
    } else if (e.key === 'ArrowUp') {
      e.preventDefault();
      selectedIndex = Math.max(selectedIndex - 1, -1);
      updateSelection(items);
    } else if (e.key === 'Enter') {
      e.preventDefault();
      if (selectedIndex >= 0 && currentSuggestions[selectedIndex]) {
        selectScholarship(currentSuggestions[selectedIndex]);
      }
    } else if (e.key === 'Escape') {
      suggestions.style.display = 'none';
    }
  });

  suggestions.addEventListener('click', function(e) {
    const item = e.target.closest('.autocomplete-suggestion');
    if (item) {
      const index = parseInt(item.dataset.index);
      selectScholarship(currentSuggestions[index]);
    }
  });

  function updateSelection(items) {
    items.forEach((item, index) => {
      item.classList.toggle('active', index === selectedIndex);
    });
  }

  function selectScholarship(item) {
    input.value = item.display;
    selectedScholarshipId = item.id;
    suggestions.style.display = 'none';
    document.getElementById('clearScholarshipSearch').style.display = 'block';
    applyFilters();
  }

  // Clear button
  const clearBtn = document.getElementById('clearScholarshipSearch');
  if (clearBtn) {
    clearBtn.addEventListener('click', function() {
      input.value = '';
      selectedScholarshipId = null;
      suggestions.style.display = 'none';
      this.style.display = 'none';
      applyFilters();
    });
  }

  // Show/hide clear button
  input.addEventListener('input', function() {
    if (this.value.trim()) {
      clearBtn.style.display = 'block';
    } else {
      clearBtn.style.display = 'none';
    }
  });

  // Clear selection when input is cleared
  input.addEventListener('blur', function() {
    setTimeout(() => {
      if (!this.value.trim()) {
        selectedScholarshipId = null;
        clearBtn.style.display = 'none';
        applyFilters();
      }
    }, 200);
  });
}

// Autocomplete functionality for students
function setupStudentAutocomplete() {
  const input = document.getElementById('studentSearch');
  const suggestions = document.getElementById('studentSuggestions');
  let debounceTimer;
  let selectedIndex = -1;
  let currentSuggestions = [];

  if (!input || !suggestions) return;

  input.addEventListener('input', function() {
    const query = this.value.trim();
    clearTimeout(debounceTimer);
    selectedIndex = -1;

    if (query.length < 2) {
      suggestions.style.display = 'none';
      selectedStudentId = null;
      applyFilters();
      return;
    }

    debounceTimer = setTimeout(() => {
      fetch(`/provider/api/students/search?q=${encodeURIComponent(query)}`)
        .then(response => response.json())
        .then(data => {
          currentSuggestions = data;
          if (data.length === 0) {
            suggestions.style.display = 'none';
            return;
          }

          suggestions.innerHTML = data.map((item, index) => 
            `<div class="autocomplete-suggestion" data-index="${index}" data-id="${item.id}">${item.display}</div>`
          ).join('');
          suggestions.style.display = 'block';
        })
        .catch(error => {
          console.error('Error fetching students:', error);
          suggestions.style.display = 'none';
        });
    }, 300);
  });

  input.addEventListener('keydown', function(e) {
    if (suggestions.style.display === 'none') return;

    const items = suggestions.querySelectorAll('.autocomplete-suggestion');
    if (e.key === 'ArrowDown') {
      e.preventDefault();
      selectedIndex = Math.min(selectedIndex + 1, items.length - 1);
      updateSelection(items);
    } else if (e.key === 'ArrowUp') {
      e.preventDefault();
      selectedIndex = Math.max(selectedIndex - 1, -1);
      updateSelection(items);
    } else if (e.key === 'Enter') {
      e.preventDefault();
      if (selectedIndex >= 0 && currentSuggestions[selectedIndex]) {
        selectStudent(currentSuggestions[selectedIndex]);
      }
    } else if (e.key === 'Escape') {
      suggestions.style.display = 'none';
    }
  });

  suggestions.addEventListener('click', function(e) {
    const item = e.target.closest('.autocomplete-suggestion');
    if (item) {
      const index = parseInt(item.dataset.index);
      selectStudent(currentSuggestions[index]);
    }
  });

  function updateSelection(items) {
    items.forEach((item, index) => {
      item.classList.toggle('active', index === selectedIndex);
    });
  }

  function selectStudent(item) {
    input.value = item.display;
    selectedStudentId = item.id;
    suggestions.style.display = 'none';
    document.getElementById('clearStudentSearch').style.display = 'block';
    applyFilters();
  }

  // Clear button
  const clearBtn = document.getElementById('clearStudentSearch');
  if (clearBtn) {
    clearBtn.addEventListener('click', function() {
      input.value = '';
      selectedStudentId = null;
      suggestions.style.display = 'none';
      this.style.display = 'none';
      applyFilters();
    });
  }

  // Show/hide clear button
  input.addEventListener('input', function() {
    if (this.value.trim()) {
      clearBtn.style.display = 'block';
    } else {
      clearBtn.style.display = 'none';
    }
  });

  // Clear selection when input is cleared
  input.addEventListener('blur', function() {
    setTimeout(() => {
      if (!this.value.trim()) {
        selectedStudentId = null;
        clearBtn.style.display = 'none';
        applyFilters();
      }
    }, 200);
  });
}

// Apply filters based on search and status
function applyFilters() {
  const statusFilter = document.getElementById('statusFilter');
  const statusValue = statusFilter ? statusFilter.value : 'all';
  
  const scholarshipSections = document.querySelectorAll('.scholarship-section');
  const applicationItems = document.querySelectorAll('.application-item');

  scholarshipSections.forEach(section => {
    let sectionVisible = false;
    const scholarshipId = parseInt(section.dataset.scholarshipId);

    // Filter by scholarship
    if (selectedScholarshipId && scholarshipId !== selectedScholarshipId) {
      section.style.display = 'none';
      return;
    }

    // Check if any applications in this section match
    const items = section.querySelectorAll('.application-item');
    items.forEach(item => {
      let visible = true;

      // Filter by status
      const status = (item.getAttribute('data-status') || '').toLowerCase();
      if (statusValue !== 'all' && status !== statusValue) {
        visible = false;
      }

      // Filter by student
      if (selectedStudentId) {
        const itemUserId = parseInt(item.dataset.userId);
        if (itemUserId !== selectedStudentId) {
          visible = false;
        }
      }

      if (visible) {
        item.style.display = '';
        sectionVisible = true;
      } else {
        item.style.display = 'none';
      }
    });

    section.style.display = sectionVisible ? '' : 'none';
  });
}

// Client-side filter
document.addEventListener('DOMContentLoaded', function() {
  setupScholarshipAutocomplete();
  setupStudentAutocomplete();
  
  const filter = document.getElementById('statusFilter');
  if (filter) {
    filter.addEventListener('change', function() {
      applyFilters();
    });
  }
});

// Auto-refresh
(function autoRefreshOnNewApplications(){
  const initialTotal = {{ total_applications }};
  let lastTotal = initialTotal;

  async function checkForUpdates() {
    try {
      const resp = await fetch('/provider/api/applications/list', { headers: { 'Accept': 'application/json' } });
      const data = await resp.json();
      if (!data.success || !Array.isArray(data.applications)) return;
      
      // Only refresh if total count changed, to avoid interrupting review
      if (data.applications.length !== lastTotal) {
        window.location.reload();
      }
    } catch (e) { console.error('Auto-refresh check failed:', e); }
  }
  setInterval(checkForUpdates, 10000);
})();

// Listen for profile picture updates across tabs
window.addEventListener('storage', function(e) {
    if (e.key === 'provider_profile_picture_url') {
        const sidebarImg = document.getElementById('sidebarProfilePicture');
        if (sidebarImg && e.newValue) {
            sidebarImg.src = e.newValue;
        }
    }
});

// Listen for profile picture updates on same page
window.addEventListener('profilePictureUpdated', function(e) {
    const sidebarImg = document.getElementById('sidebarProfilePicture');
    if (sidebarImg && e.detail && e.detail.imageUrl) {
        sidebarImg.src = e.detail.imageUrl;
    }
});
</script>

<!-- PDF Generation Modal -->
<div id="pdfModal" class="pdf-modal">
    <div class="pdf-modal-content">
        <div class="pdf-modal-header">
            <h3><i class="fas fa-file-pdf"></i> Generate PDF Report</h3>
            <button onclick="closePDFModal()" style="background:none; border:none; font-size:1.5rem; cursor:pointer; color:#fff; padding:0; width:30px; height:30px; display:flex; align-items:center; justify-content:center;">&times;</button>
        </div>
        <div class="pdf-modal-body">
            <label for="pdfScholarshipSelect">Select Scholarship:</label>
            <select id="pdfScholarshipSelect" class="form-control">
                <option value="">-- Select a Scholarship --</option>
                {% if scholarships %}
                    {% for scholarship in scholarships %}
                        <option value="{{ scholarship.id }}">{{ scholarship.title }} ({{ scholarship.code }}) - {{ scholarship.application_count }} application{{ 's' if scholarship.application_count != 1 else '' }}</option>
                    {% endfor %}
                {% endif %}
            </select>
            <p style="margin-top:1rem; font-size:0.85rem; color:#666;">
                <i class="fas fa-info-circle"></i> This will generate a comprehensive PDF report including scholarship details, application statistics, and applicant list.
            </p>
        </div>
        <div class="pdf-modal-footer">
            <button class="pdf-btn pdf-btn-cancel" onclick="closePDFModal()">Cancel</button>
            <button class="pdf-btn pdf-btn-generate" onclick="generatePDF()" id="generatePDFBtn">
                <i class="fas fa-download"></i> Generate & Download
            </button>
        </div>
    </div>
</div>

<!-- Provider Guidelines Modal -->
<div id="providerGuidelinesModal" style="display: none; position: fixed; z-index: 10000; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); overflow: auto;">
    <div style="background: #fff; margin: 5% auto; padding: 0; border-radius: 15px; width: 90%; max-width: 700px; max-height: 85vh; display: flex; flex-direction: column; box-shadow: 0 8px 32px rgba(0,0,0,0.2);">
        <div style="padding: 1.5rem 2rem; border-bottom: 2px solid #e9ecef; display: flex; justify-content: space-between; align-items: center;">
            <h2 style="margin: 0; color: #003366; font-size: 1.8rem;">Provider Portal Guidelines</h2>
            <button onclick="closeProviderGuidelinesModal()" style="background: none; border: none; font-size: 1.8rem; color: #666; cursor: pointer; padding: 0; width: 32px; height: 32px; display: flex; align-items: center; justify-content: center;">&times;</button>
        </div>
        <div style="padding: 2rem; overflow-y: auto; flex: 1;">
            <h3 style="color: #003366; margin-bottom: 1.5rem; font-size: 1.5rem;">Guidelines for Provider</h3>
            <ul style="list-style: none; padding: 0; margin: 0;">
                <li style="margin-bottom: 1rem; padding-left: 1.5rem; position: relative; line-height: 1.6;">
                    <span style="position: absolute; left: 0; color: #0072ce; font-weight: bold;">•</span>
                    In your dashboard, you can see brief info of the scholarships and number of applicants.
                </li>
                <li style="margin-bottom: 1rem; padding-left: 1.5rem; position: relative; line-height: 1.6;">
                    <span style="position: absolute; left: 0; color: #0072ce; font-weight: bold;">•</span>
                    You can also send announcement to your offered scholarship to those who applied or to a specific student.
                </li>
                <li style="margin-bottom: 1rem; padding-left: 1.5rem; position: relative; line-height: 1.6;">
                    <span style="position: absolute; left: 0; color: #0072ce; font-weight: bold;">•</span>
                    You can create scholarship in "Manage Scholarships". Once created it's marked as draft and click publish to go online. You can also view, update, create a PDF report, and archive.
                </li>
                <li style="margin-bottom: 1rem; padding-left: 1.5rem; position: relative; line-height: 1.6;">
                    <span style="position: absolute; left: 0; color: #0072ce; font-weight: bold;">•</span>
                    Another list will appear if you archive. You can create a PDF report of it as well.
                </li>
                <li style="margin-bottom: 1rem; padding-left: 1.5rem; position: relative; line-height: 1.6;">
                    <span style="position: absolute; left: 0; color: #0072ce; font-weight: bold;">•</span>
                    Once archived, the students who are approved/applying the scholarship will be removed. You can restore it and those students will have to apply again if they want to. An update will be sent to the students accordingly.
                </li>
                <li style="margin-bottom: 1rem; padding-left: 1.5rem; position: relative; line-height: 1.6;">
                    <span style="position: absolute; left: 0; color: #0072ce; font-weight: bold;">•</span>
                    You can check the application of the students of the scholarship you created and view their details. Approve their documents. Approval can happen when you verified all the documents. You can reject anytime.
                </li>
                <li style="margin-bottom: 1rem; padding-left: 1.5rem; position: relative; line-height: 1.6;">
                    <span style="position: absolute; left: 0; color: #0072ce; font-weight: bold;">•</span>
                    You can set appointments to student in schedule page, multiple scheduled appointment can be sent to the student.
                </li>
                <li style="margin-bottom: 1rem; padding-left: 1.5rem; position: relative; line-height: 1.6;">
                    <span style="position: absolute; left: 0; color: #0072ce; font-weight: bold;">•</span>
                    In documents you can search student name or id to check their document, you can check even all the students available even if they are not on your scholarship and you can only view their document.
                </li>
                <li style="margin-bottom: 1rem; padding-left: 1.5rem; position: relative; line-height: 1.6;">
                    <span style="position: absolute; left: 0; color: #0072ce; font-weight: bold;">•</span>
                    In Organization is where your information is and you can update it as well.
                </li>
            </ul>
        </div>
    </div>
</div>

<script>
function openProviderGuidelinesModal() {
    document.getElementById('providerGuidelinesModal').style.display = 'block';
}

function closeProviderGuidelinesModal() {
    document.getElementById('providerGuidelinesModal').style.display = 'none';
}

window.onclick = function(event) {
    const modal = document.getElementById('providerGuidelinesModal');
    if (event.target == modal) {
        closeProviderGuidelinesModal();
    }
    const pdfModal = document.getElementById('pdfModal');
    if (event.target == pdfModal) {
        closePDFModal();
    }
}

// PDF Generation Functions
function openPDFModal() {
    const modal = document.getElementById('pdfModal');
    if (modal) {
        modal.style.display = 'block';
        // Reset selection
        document.getElementById('pdfScholarshipSelect').value = '';
        const generateBtn = document.getElementById('generatePDFBtn');
        if (generateBtn) {
            generateBtn.disabled = false;
            generateBtn.innerHTML = '<i class="fas fa-download"></i> Generate & Download';
        }
    }
}

function closePDFModal() {
    const modal = document.getElementById('pdfModal');
    if (modal) {
        modal.style.display = 'none';
    }
}

function generatePDF() {
    const select = document.getElementById('pdfScholarshipSelect');
    const scholarshipId = select.value;
    const generateBtn = document.getElementById('generatePDFBtn');
    
    if (!scholarshipId) {
        alert('Please select a scholarship first.');
        return;
    }
    
    // Disable button and show loading state
    if (generateBtn) {
        generateBtn.disabled = true;
        generateBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Generating...';
    }
    
    // Generate PDF by redirecting to the PDF route
    window.location.href = `/provider/api/scholarship/${scholarshipId}/report-pdf`;
    
    // Close modal after a short delay (to allow download to start)
    setTimeout(() => {
        closePDFModal();
        if (generateBtn) {
            generateBtn.disabled = false;
            generateBtn.innerHTML = '<i class="fas fa-download"></i> Generate & Download';
        }
    }, 1000);
}

// Remarks Modal Functions
let currentRemarksStudentId = null;

function openRemarksModal(studentId, studentName) {
    currentRemarksStudentId = studentId;
    document.getElementById('remarksStudentName').textContent = studentName;
    document.getElementById('remarksModal').style.display = 'block';
    document.getElementById('newRemarkText').value = '';
    loadRemarks(studentId);
}

function closeRemarksModal() {
    document.getElementById('remarksModal').style.display = 'none';
    currentRemarksStudentId = null;
    document.getElementById('remarksList').innerHTML = '<p style="color:#666; font-style:italic;">Loading remarks...</p>';
}

function loadRemarks(studentId) {
    fetch(`/provider/api/student/${studentId}/remarks`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const remarksList = document.getElementById('remarksList');
                if (data.remarks && data.remarks.length > 0) {
                    remarksList.innerHTML = data.remarks.map(remark => {
                        const date = new Date(remark.created_at);
                        const formattedDate = date.toLocaleString('en-US', {
                            year: 'numeric',
                            month: 'short',
                            day: 'numeric',
                            hour: '2-digit',
                            minute: '2-digit'
                        });
                        return `
                            <div style="background:#f8f9fa; padding:1rem; margin-bottom:0.75rem; border-radius:6px; border-left:4px solid #007bff;">
                                <div style="color:#666; font-size:0.85rem; margin-bottom:0.5rem;">${formattedDate}</div>
                                <div style="color:#333; white-space:pre-wrap;">${remark.remark_text}</div>
                            </div>
                        `;
                    }).join('');
                } else {
                    remarksList.innerHTML = '<p style="color:#666; font-style:italic;">No remarks yet. Add your first remark above.</p>';
                }
            } else {
                document.getElementById('remarksList').innerHTML = '<p style="color:#dc3545;">Error loading remarks: ' + (data.error || 'Unknown error') + '</p>';
            }
        })
        .catch(error => {
            document.getElementById('remarksList').innerHTML = '<p style="color:#dc3545;">Error loading remarks: ' + error.message + '</p>';
        });
}

function addRemark() {
    if (!currentRemarksStudentId) {
        alert('Error: Student ID not set');
        return;
    }
    
    const remarkText = document.getElementById('newRemarkText').value.trim();
    if (!remarkText) {
        alert('Please enter a remark');
        return;
    }
    
    fetch(`/provider/api/student/${currentRemarksStudentId}/remarks`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({
            remark_text: remarkText
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            document.getElementById('newRemarkText').value = '';
            loadRemarks(currentRemarksStudentId);
        } else {
            alert('Error adding remark: ' + (data.error || 'Unknown error'));
        }
    })
    .catch(error => {
        alert('Error adding remark: ' + error.message);
    });
}

// Close modal when clicking outside
window.onclick = function(event) {
    const remarksModal = document.getElementById('remarksModal');
    if (event.target === remarksModal) {
        closeRemarksModal();
    }
}
</script>
{% endblock %}