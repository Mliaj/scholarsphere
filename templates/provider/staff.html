{% extends "base.html" %}

{% block title %}Staff Account Management - Scholarsphere | Provider{% endblock %}

{% block extra_css %}
<style>
    .dashboard-container { display:flex; min-height:100vh; }
    .sidebar { width:280px; background: linear-gradient(135deg, #003366 0%, #0072ce 100%); color:#fff; padding:2rem 0; position:fixed; height:100vh; overflow-y:auto; }
    .sidebar-header { text-align:center; padding:0 2rem 2rem 2rem; border-bottom:1px solid rgba(255,255,255,0.1); }
    .sidebar-logo { width:60px; height:60px; background:#fff; border-radius:50%; margin:0 auto 1rem; display:flex; align-items:center; justify-content:center; overflow:hidden; }
    .sidebar-logo img { width:100%; height:100%; object-fit:cover; border-radius:50%; }
    .sidebar-brand { font-size:1.2rem; font-weight:700; margin-bottom:.5rem; }
    .sidebar-subtitle { font-size:.9rem; opacity:.8; }
    .sidebar-nav { padding:2rem 0; }
    .nav-item { padding:1rem 2rem; cursor:pointer; transition:background .3s; border-left:3px solid transparent; display:flex; align-items:center; overflow:hidden; }
    .nav-item:hover, .nav-item.active { background:rgba(255,255,255,0.1); border-left-color:#ffc72c; }
    .nav-item i { margin-right:1rem; width:20px; text-align:center; flex-shrink:0; }
    .nav-item span { overflow:hidden; text-overflow:ellipsis; white-space:nowrap; }

    .main-content { flex:1; margin-left:280px; padding:2rem; }
    .top-bar { display:flex; justify-content:space-between; align-items:center; margin-bottom:2rem; padding:1rem 0; }
    .welcome-text h1 { font-size:2rem; color:#003366; margin-bottom:.5rem; }
    .welcome-text p { color:#666; }
    .user-menu { display:flex; align-items:center; gap:1rem; }
    .user-avatar { width:50px; height:50px; border-radius:50%; background:#0072ce; display:flex; align-items:center; justify-content:center; color:#fff; font-weight:600; }

    .table-container { background:#fff; border-radius:15px; box-shadow:0 4px 20px rgba(0,0,0,0.08); overflow:hidden; }
    .table-header { padding:1.5rem; border-bottom:1px solid #e9ecef; background:#f8f9fa; display:flex; justify-content:space-between; align-items:center; }
    .btn-primary { background:#1273eb; color:#fff; border:0; padding:.7rem 1rem; border-radius:10px; font-weight:600; cursor:pointer; }
    table { width:100%; border-collapse:collapse; }
    th { background:#f8f9fa; padding:1rem; text-align:left; font-weight:600; color:#1a1a1a; border-bottom:2px solid #e9ecef; }
    td { padding:1rem; border-bottom:1px solid #e9ecef; vertical-align:middle; }
    .status { padding:.25rem .6rem; border-radius:16px; font-weight:700; font-size:.85rem; }
    .status.active { background:#dff7e6; color:#137a2a; }
    .status.inactive { background:#f8d7da; color:#721c24; }
    .actions { display:flex; gap:.5rem; }
    .btn { padding:.5rem .8rem; border-radius:10px; border:0; cursor:pointer; font-weight:600; }
    .btn.gray { background:#e5e8ee; color:#233046; }
    .btn.blue { background:#007bff; color:#fff; }
    .btn.red { background:#dc3545; color:#fff; }
    .btn.green { background:#28a745; color:#fff; }

    /* Modal Styles */
    .modal { display:none; position:fixed; z-index:1000; left:0; top:0; width:100%; height:100%; background:rgba(0,0,0,0.5); }
    .modal-content { background:#fff; margin:2% auto; padding:0; border-radius:15px; width:90%; max-width:600px; max-height:90vh; overflow-y:auto; box-shadow:0 10px 30px rgba(0,0,0,0.3); }
    .modal-header { padding:1.5rem; border-bottom:1px solid #e9ecef; background:#f8f9fa; border-radius:15px 15px 0 0; display:flex; justify-content:space-between; align-items:center; }
    .modal-title { font-size:1.5rem; font-weight:700; color:#003366; margin:0; }
    .close { background:none; border:none; font-size:2rem; color:#666; cursor:pointer; padding:0; width:30px; height:30px; display:flex; align-items:center; justify-content:center; }
    .close:hover { color:#000; }
    .modal-body { padding:2rem; }
    .form-group { margin-bottom:1.5rem; }
    .form-label { display:block; margin-bottom:0.5rem; font-weight:600; color:#333; }
    .form-control { width:100%; padding:0.75rem; border:1px solid #ddd; border-radius:8px; font-size:1rem; transition:border-color 0.3s; }
    .form-control:focus { outline:none; border-color:#007bff; box-shadow:0 0 0 2px rgba(0,123,255,0.25); }
    .modal-footer { padding:1.5rem; border-top:1px solid #e9ecef; background:#f8f9fa; border-radius:0 0 15px 15px; display:flex; justify-content:flex-end; gap:1rem; }
    .btn-modal { padding:0.75rem 1.5rem; border:none; border-radius:8px; font-weight:600; cursor:pointer; transition:all 0.3s; }
    .btn-modal.primary { background:#007bff; color:#fff; }
    .btn-modal.primary:hover { background:#0056b3; }
    .btn-modal.secondary { background:#6c757d; color:#fff; }
    .btn-modal.secondary:hover { background:#545b62; }

    /* Password Input Styles */
    .password-input-container {
        position: relative;
        width: 100%;
    }

    .password-input-container input {
        padding-right: 2.5rem !important;
        position: relative;
        z-index: 1;
    }
    
    .password-toggle {
        position: absolute;
        right: 0.75rem;
        top: 50%;
        transform: translateY(-50%);
        cursor: pointer !important;
        color: #666;
        z-index: 100 !important;
        pointer-events: auto !important;
        padding: 0.5rem;
        display: flex;
        align-items: center;
        justify-content: center;
        user-select: none;
        -webkit-user-select: none;
        -moz-user-select: none;
    }

    .password-toggle i {
        pointer-events: none !important;
    }

    .password-toggle:hover {
        color: #003366;
    }
    
    .password-strength {
        margin-top: 0.5rem;
        font-size: 0.85rem;
    }
    
    .strength-bar {
        height: 4px;
        border-radius: 2px;
        margin-top: 0.25rem;
        transition: width 0.3s, background-color 0.3s;
        width: 0%;
    }
    
    .strength-weak {
        background-color: #dc3545;
        width: 33%;
    }
    
    .strength-medium {
        background-color: #ffc107;
        width: 66%;
    }
    
    .strength-strong {
        background-color: #28a745;
        width: 100%;
    }

    @media (max-width:1024px){ .sidebar{width:250px;} .main-content{margin-left:250px;} }
    @media (max-width:768px){ .sidebar{transform:translateX(-100%); transition:transform .3s;} .sidebar.open{transform:translateX(0);} .main-content{margin-left:0;} .modal-content{width:95%; margin:5% auto;} }
</style>
{% endblock %}

{% block content %}
<div class="dashboard-container">
  <div class="sidebar">
    <div class="sidebar-header">
      <div class="sidebar-logo">
        {% if user.profile_picture %}
          <img src="{{ url_for('static', filename='uploads/profile_pictures/' + user.profile_picture) }}" alt="Profile Picture">
        {% else %}
          <img src="{{ url_for('static', filename='images/uc-logo.png') }}" alt="UC Logo">
        {% endif %}
      </div>
      <div class="sidebar-brand">Scholarsphere</div>
      <div class="sidebar-subtitle">Provider Portal</div>
    </div>
    <nav class="sidebar-nav">
      <div class="nav-item" onclick="window.location.href='{{ url_for('provider.dashboard') }}'"><i class="fas fa-home"></i> Dashboard</div>
      {% if user.role == 'provider_admin' %}
      <div class="nav-item" onclick="window.location.href='{{ url_for('provider.scholarships') }}'"><i class="fas fa-graduation-cap"></i> Manage Scholarships</div>
      {% endif %}
      <div class="nav-item" onclick="window.location.href='{{ url_for('provider.applications') }}'"><i class="fas fa-clipboard-list"></i> Applications</div>
      <div class="nav-item" onclick="window.location.href='{{ url_for('provider.schedules') }}'"><i class="fas fa-calendar-alt"></i> Schedules</div>
      <div class="nav-item" onclick="window.location.href='{{ url_for('provider.documents') }}'"><i class="fas fa-file-alt"></i> Documents</div>
      {% if user.role == 'provider_admin' %}
      <div class="nav-item active"><i class="fas fa-users-cog"></i> Staff Account Management</div>
      <div class="nav-item" onclick="window.location.href='{{ url_for('provider.reports') }}'"><i class="fas fa-chart-bar"></i> Reports & Analytics</div>
      {% endif %}
      <div class="nav-item" onclick="window.location.href='{{ url_for('provider.profile') }}'"><i class="fas fa-building"></i> {% if user.role == 'provider_staff' %}User Profile{% else %}Organization Profile{% endif %}</div>
      <div class="nav-item" onclick="window.location.href='{{ url_for('logout') }}'"><i class="fas fa-sign-out-alt"></i> Logout</div>
    </nav>
  </div>

  <div class="main-content">
    <div class="top-bar">
      <div class="welcome-text">
        <h1>Staff Account Management</h1>
        <p>Manage your staff accounts</p>
      </div>
      <div class="user-menu">
        <button class="btn-primary" onclick="openCreateStaffModal()"><i class="fas fa-plus"></i> Create Staff</button>
      </div>
    </div>

    <div class="table-container">
      <div class="table-header">
        <h3>Staff Members</h3>
      </div>
      <table>
        <thead>
          <tr>
            <th>Staff Name</th>
            <th>Email</th>
            <th>Status</th>
            <th>Created</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody id="staffTableBody">
          {% if staff_members %}
            {% for staff in staff_members %}
            <tr data-staff-id="{{ staff.id }}">
              <td>{{ staff.first_name }} {{ staff.last_name }}</td>
              <td>{{ staff.email }}</td>
              <td>
                <span class="status {% if staff.is_active %}active{% else %}inactive{% endif %}">
                  {% if staff.is_active %}Active{% else %}Inactive{% endif %}
                </span>
              </td>
              <td>{{ staff.created_at }}</td>
              <td>
                <div class="actions">
                  <button class="btn blue" onclick="viewStaff({{ staff.id }})">View</button>
                  <button class="btn gray" onclick="editStaff({{ staff.id }})">Update</button>
                  {% if staff.is_active %}
                    <button class="btn red" onclick="deactivateStaff({{ staff.id }})">Deactivate</button>
                  {% else %}
                    <button class="btn green" onclick="activateStaff({{ staff.id }})">Activate</button>
                  {% endif %}
                </div>
              </td>
            </tr>
            {% endfor %}
          {% else %}
            <tr>
              <td colspan="5" style="text-align: center; padding: 2rem; color: #666;">
                No staff members found. Create your first staff account to get started!
              </td>
            </tr>
          {% endif %}
        </tbody>
      </table>
    </div>
  </div>
</div>

<!-- Create Staff Modal -->
<div id="createStaffModal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h2 class="modal-title">Create Staff Account</h2>
      <button class="close" onclick="closeCreateStaffModal()">&times;</button>
    </div>
    <form id="createStaffForm">
      <div class="modal-body">
        <div class="form-group">
          <label for="staffFirstName" class="form-label">Staff Name (First) *</label>
          <input type="text" id="staffFirstName" name="first_name" class="form-control" required>
        </div>
        <div class="form-group">
          <label for="staffLastName" class="form-label">Staff Name (Last) *</label>
          <input type="text" id="staffLastName" name="last_name" class="form-control" required>
        </div>
        <div class="form-group">
          <label for="staffEmail" class="form-label">Email *</label>
          <input type="email" id="staffEmail" name="email" class="form-control" required>
        </div>
        <div class="form-group">
          <label for="staffPassword" class="form-label">Password *</label>
          <div class="password-input-container">
            <input type="password" id="staffPassword" name="password" class="form-control" required minlength="8">
            <span class="password-toggle" id="staffPassword-toggle" onclick="window.toggleStaffPasswordVisibility('staffPassword', 'staffPassword-toggle'); event.preventDefault(); event.stopPropagation(); return false;" style="cursor: pointer !important; pointer-events: auto !important; z-index: 100 !important;">
              <i class="fas fa-eye"></i>
            </span>
          </div>
          <div class="password-strength">
            <div class="strength-bar" id="staffPasswordStrengthBar"></div>
            <small id="staffPasswordStrengthText" style="color: #666;"></small>
          </div>
        </div>
        <div class="form-group">
          <label for="staffConfirmPassword" class="form-label">Confirm Password *</label>
          <div class="password-input-container">
            <input type="password" id="staffConfirmPassword" name="confirm_password" class="form-control" required minlength="8">
            <span class="password-toggle" id="staffConfirmPassword-toggle" onclick="window.toggleStaffPasswordVisibility('staffConfirmPassword', 'staffConfirmPassword-toggle'); event.preventDefault(); event.stopPropagation(); return false;" style="cursor: pointer !important; pointer-events: auto !important; z-index: 100 !important;">
              <i class="fas fa-eye"></i>
            </span>
          </div>
          <small id="staffPasswordMatch" style="color: #666; font-size: 0.85rem;"></small>
        </div>
        <div class="form-group">
          <label for="staffOrganization" class="form-label">Organization</label>
          <input type="text" id="staffOrganization" name="organization" class="form-control" value="{{ user.organization or '' }}" readonly style="background: #f8f9fa; color: #6c757d; cursor: not-allowed;">
          <small style="color: #6c757d; font-size: 0.85rem; margin-top: 0.25rem; display: block;">Organization is automatically set from your profile</small>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn-modal secondary" onclick="closeCreateStaffModal()">Cancel</button>
        <button type="submit" class="btn-modal primary">Create Staff</button>
      </div>
    </form>
  </div>
</div>

<!-- View/Edit Staff Modal -->
<div id="editStaffModal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h2 class="modal-title" id="editStaffModalTitle">View Staff</h2>
      <button class="close" onclick="closeEditStaffModal()">&times;</button>
    </div>
    <form id="editStaffForm">
      <input type="hidden" id="editStaffId" name="id">
      <div class="modal-body">
        <div class="form-group">
          <label for="editStaffFirstName" class="form-label">Staff Name (First) *</label>
          <input type="text" id="editStaffFirstName" name="first_name" class="form-control" required>
        </div>
        <div class="form-group">
          <label for="editStaffLastName" class="form-label">Staff Name (Last) *</label>
          <input type="text" id="editStaffLastName" name="last_name" class="form-control" required>
        </div>
        <div class="form-group">
          <label for="editStaffEmail" class="form-label">Email *</label>
          <input type="email" id="editStaffEmail" name="email" class="form-control" required>
        </div>
        <div class="form-group">
          <label for="editStaffPassword" class="form-label">Password (leave blank to keep current)</label>
          <input type="password" id="editStaffPassword" name="password" class="form-control" minlength="8">
        </div>
        <div class="form-group">
          <label for="editStaffOrganization" class="form-label">Organization</label>
          <input type="text" id="editStaffOrganization" name="organization" class="form-control">
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn-modal secondary" onclick="closeEditStaffModal()">Cancel</button>
        <button type="submit" class="btn-modal primary">Update Staff</button>
      </div>
    </form>
  </div>
</div>

<script>
// Password toggle function
window.toggleStaffPasswordVisibility = function(inputId, toggleId) {
    const input = document.getElementById(inputId);
    const toggle = document.getElementById(toggleId);
    if (!input || !toggle) {
        return false;
    }
    
    const icon = toggle.querySelector('i');
    if (input.type === 'password') {
        input.type = 'text';
        icon.classList.remove('fa-eye');
        icon.classList.add('fa-eye-slash');
    } else {
        input.type = 'password';
        icon.classList.remove('fa-eye-slash');
        icon.classList.add('fa-eye');
    }
    return false;
};

// Password strength checker
function checkPasswordStrength(password) {
    let strength = 0;
    let feedback = [];
    
    if (password.length >= 8) strength++;
    else feedback.push('At least 8 characters');
    
    if (/[a-z]/.test(password)) strength++;
    else feedback.push('lowercase letter');
    
    if (/[A-Z]/.test(password)) strength++;
    else feedback.push('uppercase letter');
    
    if (/[0-9]/.test(password)) strength++;
    else feedback.push('number');
    
    if (/[^a-zA-Z0-9]/.test(password)) strength++;
    else feedback.push('special character');
    
    return { strength, feedback };
}

// Update password strength indicator
function updatePasswordStrength() {
    const password = document.getElementById('staffPassword').value;
    const strengthBar = document.getElementById('staffPasswordStrengthBar');
    const strengthText = document.getElementById('staffPasswordStrengthText');
    
    if (!password) {
        strengthBar.className = 'strength-bar';
        strengthBar.style.width = '0%';
        strengthText.textContent = '';
        return;
    }
    
    const { strength, feedback } = checkPasswordStrength(password);
    
    strengthBar.className = 'strength-bar';
    if (strength <= 2) {
        strengthBar.classList.add('strength-weak');
        strengthText.textContent = 'Weak password';
        strengthText.style.color = '#dc3545';
    } else if (strength <= 3) {
        strengthBar.classList.add('strength-medium');
        strengthText.textContent = 'Medium password';
        strengthText.style.color = '#ffc107';
    } else {
        strengthBar.classList.add('strength-strong');
        strengthText.textContent = 'Strong password';
        strengthText.style.color = '#28a745';
    }
}

// Check password match
function checkPasswordMatch() {
    const password = document.getElementById('staffPassword').value;
    const confirmPassword = document.getElementById('staffConfirmPassword').value;
    const matchText = document.getElementById('staffPasswordMatch');
    
    if (!confirmPassword) {
        matchText.textContent = '';
        return;
    }
    
    if (password === confirmPassword) {
        matchText.textContent = '✓ Passwords match';
        matchText.style.color = '#28a745';
    } else {
        matchText.textContent = '✗ Passwords do not match';
        matchText.style.color = '#dc3545';
    }
}

function openCreateStaffModal() {
  document.getElementById('createStaffModal').style.display = 'block';
  document.getElementById('createStaffForm').reset();
  // Reset password indicators
  document.getElementById('staffPasswordStrengthBar').className = 'strength-bar';
  document.getElementById('staffPasswordStrengthBar').style.width = '0%';
  document.getElementById('staffPasswordStrengthText').textContent = '';
  document.getElementById('staffPasswordMatch').textContent = '';
  
  // Add event listeners for password fields
  document.getElementById('staffPassword').addEventListener('input', updatePasswordStrength);
  document.getElementById('staffConfirmPassword').addEventListener('input', checkPasswordMatch);
}

function closeCreateStaffModal() {
  document.getElementById('createStaffModal').style.display = 'none';
}

function closeEditStaffModal() {
  document.getElementById('editStaffModal').style.display = 'none';
}

function viewStaff(id) {
  editStaff(id, true);
}

function editStaff(id, viewOnly = false) {
  fetch(`/provider/api/staff/${id}`)
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        document.getElementById('editStaffId').value = data.staff.id;
        document.getElementById('editStaffFirstName').value = data.staff.first_name;
        document.getElementById('editStaffLastName').value = data.staff.last_name;
        document.getElementById('editStaffEmail').value = data.staff.email;
        document.getElementById('editStaffOrganization').value = data.staff.organization || '';
        document.getElementById('editStaffPassword').value = '';
        
        if (viewOnly) {
          document.getElementById('editStaffModalTitle').textContent = 'View Staff';
          document.getElementById('editStaffForm').querySelectorAll('input, button[type="submit"]').forEach(el => {
            if (el.type !== 'hidden') el.disabled = true;
          });
        } else {
          document.getElementById('editStaffModalTitle').textContent = 'Update Staff';
          document.getElementById('editStaffForm').querySelectorAll('input, button[type="submit"]').forEach(el => {
            el.disabled = false;
          });
        }
        
        document.getElementById('editStaffModal').style.display = 'block';
      } else {
        alert('Error loading staff: ' + (data.error || 'Unknown error'));
      }
    })
    .catch(error => {
      console.error('Error:', error);
      alert('Error loading staff details');
    });
}

function deactivateStaff(id) {
  if (!confirm('Are you sure you want to deactivate this staff member?')) return;
  
  fetch(`/provider/api/staff/${id}`, {
    method: 'DELETE',
    headers: { 'Content-Type': 'application/json' }
  })
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        location.reload();
      } else {
        alert('Error deactivating staff: ' + (data.error || 'Unknown error'));
      }
    })
    .catch(error => {
      console.error('Error:', error);
      alert('Error deactivating staff');
    });
}

function activateStaff(id) {
  fetch(`/provider/api/staff/${id}/activate`, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' }
  })
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        location.reload();
      } else {
        alert('Error activating staff: ' + (data.error || 'Unknown error'));
      }
    })
    .catch(error => {
      console.error('Error:', error);
      alert('Error activating staff');
    });
}

document.getElementById('createStaffForm').addEventListener('submit', async function(e) {
  e.preventDefault();
  
  const password = document.getElementById('staffPassword').value;
  const confirmPassword = document.getElementById('staffConfirmPassword').value;
  
  // Validate password match
  if (password !== confirmPassword) {
    alert('Passwords do not match. Please try again.');
    return;
  }
  
  const formData = new FormData(this);
  const data = Object.fromEntries(formData);
  
  // Remove confirm_password from data sent to server
  delete data.confirm_password;
  
  const btn = this.querySelector('button[type="submit"]');
  btn.disabled = true;
  btn.textContent = 'Creating...';
  
  try {
    const resp = await fetch('/provider/api/staff', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(data)
    });
    
    const result = await resp.json();
    
    if (result.success) {
      closeCreateStaffModal();
      location.reload();
    } else {
      alert('Error creating staff: ' + (result.error || 'Unknown error'));
      btn.disabled = false;
      btn.textContent = 'Create Staff';
    }
  } catch (error) {
    console.error('Error:', error);
    alert('Error creating staff');
    btn.disabled = false;
    btn.textContent = 'Create Staff';
  }
});

document.getElementById('editStaffForm').addEventListener('submit', async function(e) {
  e.preventDefault();
  
  const formData = new FormData(this);
  const data = Object.fromEntries(formData);
  const id = data.id;
  
  // Don't send password if empty
  if (!data.password) {
    delete data.password;
  }
  
  const btn = this.querySelector('button[type="submit"]');
  btn.disabled = true;
  btn.textContent = 'Updating...';
  
  try {
    const resp = await fetch(`/provider/api/staff/${id}`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(data)
    });
    
    const result = await resp.json();
    
    if (result.success) {
      closeEditStaffModal();
      location.reload();
    } else {
      alert('Error updating staff: ' + (result.error || 'Unknown error'));
      btn.disabled = false;
      btn.textContent = 'Update Staff';
    }
  } catch (error) {
    console.error('Error:', error);
    alert('Error updating staff');
    btn.disabled = false;
    btn.textContent = 'Update Staff';
  }
});

window.addEventListener('click', function(e) {
  const createModal = document.getElementById('createStaffModal');
  const editModal = document.getElementById('editStaffModal');
  if (e.target === createModal) closeCreateStaffModal();
  if (e.target === editModal) closeEditStaffModal();
});
</script>
{% endblock %}

