{% extends "base.html" %}

{% block title %}Reports & Analytics - Scholarsphere | Provider{% endblock %}

{% block extra_css %}
<style>
  .dashboard-container { display:flex; min-height:100vh; }
  .sidebar { width:280px; background: linear-gradient(135deg, #003366 0%, #0072ce 100%); color:#fff; padding:2rem 0; position:fixed; height:100vh; overflow-y:auto; }
  .sidebar-header { text-align:center; padding:0 2rem 2rem 2rem; border-bottom:1px solid rgba(255,255,255,0.1); }
  .sidebar-logo { width:60px; height:60px; background:#fff; border-radius:50%; margin:0 auto 1rem; display:flex; align-items:center; justify-content:center; overflow:hidden; }
  .sidebar-logo img { width:100%; height:100%; object-fit:cover; border-radius:50%; }
  .sidebar-brand { font-size:1.2rem; font-weight:700; margin-bottom:.5rem; }
  .sidebar-subtitle { font-size:.9rem; opacity:.8; }
  .sidebar-nav { padding:2rem 0; }
  .nav-item { padding:1rem 2rem; cursor:pointer; transition:background .3s; border-left:3px solid transparent; display:flex; align-items:center; overflow:hidden; }
  .nav-item:hover, .nav-item.active { background:rgba(255,255,255,0.1); border-left-color:#ffc72c; }
  .nav-item i { margin-right:1rem; width:20px; text-align:center; flex-shrink:0; }
  .nav-item > *:not(i) { overflow:hidden; text-overflow:ellipsis; white-space:nowrap; }

  .main-content { flex:1; margin-left:280px; padding:2rem; }
  .top-bar { display:flex; justify-content:space-between; align-items:center; margin-bottom:2rem; padding:1rem 0; }
  .welcome-text h1 { font-size:2rem; color:#003366; margin-bottom:.5rem; }
  .welcome-text p { color:#666; }
  .user-menu { display:flex; align-items:center; gap:1rem; }
  .user-avatar { width:50px; height:50px; border-radius:50%; background:#0072ce; display:flex; align-items:center; justify-content:center; color:#fff; font-weight:600; font-size:1.2rem; }
  .card { background:#fff; border-radius:15px; box-shadow:0 4px 20px rgba(0,0,0,0.08); overflow:hidden; margin-bottom:1.5rem; }
  .card-header { display:flex; justify-content:space-between; align-items:center; padding:1.25rem 1.5rem; border-bottom:1px solid #e9ecef; background:#f8f9fa; }
  .card-header h3 { margin:0; font-size:1.1rem; color:#003366; font-weight:600; }
  .grid { display:grid; grid-template-columns: 1fr 1fr; gap:1.5rem; }
  .chart-wrap { position:relative; width:100%; height:360px; padding:0 .25rem 1rem; }
  @media (max-width: 1024px){ .grid { grid-template-columns: 1fr; } }
</style>
{% endblock %}

{% block content %}
<div class="dashboard-container">
  <div class="sidebar">
    <div class="sidebar-header">
      <div class="sidebar-logo">
        {% if user.profile_picture %}
          <img src="{{ url_for('static', filename='uploads/profile_pictures/' + user.profile_picture) }}" alt="Profile Picture">
        {% else %}
          <img src="{{ url_for('static', filename='images/uc-logo.png') }}" alt="UC Logo">
        {% endif %}
      </div>
      <div class="sidebar-brand">Scholarsphere</div>
      <div class="sidebar-subtitle">{% if user.role == 'provider_admin' %}Provider Admin Portal{% else %}Provider Staff Portal{% endif %}</div>
    </div>
    <nav class="sidebar-nav">
      <div class="nav-item" onclick="window.location.href='{{ url_for('provider.dashboard') }}'"><i class="fas fa-home"></i> Dashboard</div>
      <div class="nav-item" onclick="window.location.href='{{ url_for('provider.scholarships') }}'"><i class="fas fa-graduation-cap"></i> Manage Scholarships</div>
      <div class="nav-item" onclick="window.location.href='{{ url_for('provider.applications') }}'"><i class="fas fa-clipboard-list"></i> Applications</div>
      <div class="nav-item" onclick="window.location.href='{{ url_for('provider.schedules') }}'"><i class="fas fa-calendar-alt"></i> Schedules</div>
      <div class="nav-item" onclick="window.location.href='{{ url_for('provider.documents') }}'"><i class="fas fa-file-alt"></i> Documents</div>
      <div class="nav-item" onclick="window.location.href='{{ url_for('provider.staff_management') }}'"><i class="fas fa-users-cog"></i> Staff Account Management</div>
      <div class="nav-item active"><i class="fas fa-chart-bar"></i> Reports & Analytics</div>
      <div class="nav-item" onclick="window.location.href='{{ url_for('provider.profile') }}'"><i class="fas fa-building"></i> {% if user.role == 'provider_staff' %}User Profile{% else %}Organization Profile{% endif %}</div>
      <div class="nav-item" onclick="window.location.href='{{ url_for('logout') }}'"><i class="fas fa-sign-out-alt"></i> Logout</div>
    </nav>
  </div>

  <div class="main-content">
    <div class="top-bar">
      <div class="welcome-text">
        <h1>Reports & Analytics</h1>
        <p>Key metrics about your scholarship applications</p>
      </div>
      <div class="user-menu"><div class="user-avatar">{{ user.first_name[0] }}{{ user.last_name[0] }}</div></div>
    </div>

    <div class="grid">
      <div class="card">
        <div class="card-header">
          <h3 style="margin:0">Application Status Breakdown</h3>
        </div>
        <div style="padding:1rem 1.5rem">
          <div class="chart-wrap"><canvas id="applicationsPie"></canvas></div>
        </div>
      </div>
      <div class="card">
        <div class="card-header">
          <h3 style="margin:0">Top Scholarships by Applications</h3>
        </div>
        <div style="padding:1rem 1.5rem">
          <div class="chart-wrap"><canvas id="topScholarshipsBar"></canvas></div>
        </div>
      </div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
  const totals = {{ data.totals|tojson|safe }} || { total_applications: 0 };
  const statusCounts = {{ data.status_counts|tojson|safe }} || { pending: 0, approved: 0, disapproved: 0 };
  const topScholarships = {{ data.top_scholarships|tojson|safe }} || [];

  const fmt = new Intl.NumberFormat('en-US');

  const centerText = {
    id: 'centerText',
    afterDraw(chart, args, opts){
      const {ctx, chartArea} = chart;
      if (!chartArea) return;
      const {width, height} = chartArea;
      ctx.save();
      ctx.font = '700 28px Poppins, sans-serif';
      ctx.fillStyle = '#003366';
      ctx.textAlign = 'center';
      ctx.textBaseline = 'middle';
      ctx.fillText(opts.text || '', width/2 + chartArea.left, height/2 + chartArea.top);
      ctx.restore();
    }
  };

  // Pie: Application Status Breakdown
  const pieCtx = document.getElementById('applicationsPie');
  if (pieCtx) {
    const total = statusCounts.pending + statusCounts.approved + statusCounts.disapproved;
    const approvedPercent = total > 0 ? Math.round((statusCounts.approved / total) * 100) : 0;
    
    new Chart(pieCtx, {
      type: 'doughnut',
      data: { 
        labels: ['Pending', 'Approved', 'Rejected'], 
        datasets: [{ 
          data: [statusCounts.pending || 0, statusCounts.approved || 0, statusCounts.disapproved || 0], 
          backgroundColor: ['#ffc72c', '#28a745', '#dc3545'],
          borderWidth: 0
        }] 
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: { 
          legend: { 
            position: 'bottom',
            labels: { 
              padding: 15, 
              font: { size: 12, family: 'Poppins' },
              color: '#586174'
            } 
          },
          tooltip: {
            callbacks: {
              label: function(context) {
                const label = context.label || '';
                const value = context.parsed || 0;
                const total = context.dataset.data.reduce((a, b) => a + b, 0);
                const percent = total > 0 ? Math.round((value / total) * 100) : 0;
                return `${label}: ${fmt.format(value)} (${percent}%)`;
              }
            }
          },
          centerText: { text: `${approvedPercent}%` }
        }
      },
      plugins: [centerText]
    });
  }

  // Bar: Top Scholarships by Applications
  const labels = topScholarships.length > 0 ? topScholarships.map(s => s.name || 'Unknown') : ['No scholarships yet'];
  const apps = topScholarships.length > 0 ? topScholarships.map(s => s.applications || 0) : [0];
  
  const barCtx = document.getElementById('topScholarshipsBar');
  if (barCtx) {
    new Chart(barCtx, {
      type: 'bar',
      data: { 
        labels: labels, 
        datasets: [{ 
          label: 'Applications', 
          data: apps, 
          backgroundColor: '#ffc72c', 
          borderRadius: 6, 
          maxBarThickness: 42 
        }] 
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        scales: {
          x: { 
            grid: { display: false }, 
            ticks: { color: '#586174', font: { size: 11 } } 
          },
          y: { 
            beginAtZero: true, 
            grid: { color: '#f0f3f7' }, 
            ticks: { 
              color: '#586174', 
              callback: function(v) { return fmt.format(v); },
              font: { size: 11 }
            } 
          }
        },
        plugins: { 
          legend: { display: false }, 
          tooltip: { 
            callbacks: { 
              label: function(context) {
                return `Applications: ${fmt.format(context.parsed.y)}`;
              }
            } 
          } 
        }
      }
    });
  }
});
</script>
{% endblock %}

