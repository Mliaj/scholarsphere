{% extends "base.html" %}

{% block title %}Schedules - Scholarsphere | Provider{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/main.css') }}">
<style>
    .dashboard-container { display:flex; min-height:100vh; }
    .sidebar { width:280px; background: linear-gradient(135deg, #003366 0%, #0072ce 100%); color:#fff; padding:2rem 0; position:fixed; height:100vh; overflow-y:auto; }
    .sidebar-header { text-align:center; padding:0 2rem 2rem 2rem; border-bottom:1px solid rgba(255,255,255,0.1); }
    .sidebar-logo { width:60px; height:60px; background:#fff; border-radius:50%; margin:0 auto 1rem; display:flex; align-items:center; justify-content:center; overflow:hidden; }
    .sidebar-logo img { width:100%; height:100%; object-fit:cover; border-radius:50%; }
    .sidebar-brand { font-size:1.2rem; font-weight:700; margin-bottom:.5rem; }
    .sidebar-subtitle { font-size:.9rem; opacity:.8; }
    .sidebar-nav { padding:2rem 0; }
    .nav-item { padding:1rem 2rem; cursor:pointer; transition:background .3s; border-left:3px solid transparent; display:flex; align-items:center; overflow:hidden; }
    .nav-item:hover, .nav-item.active { background:rgba(255,255,255,0.1); border-left-color:#ffc72c; }
    .nav-item i { margin-right:1rem; width:20px; text-align:center; flex-shrink:0; }
    .nav-item > *:not(i) { overflow:hidden; text-overflow:ellipsis; white-space:nowrap; }

    .main-content { flex:1; margin-left:280px; padding:2rem; }
    .top-bar { display:flex; justify-content:space-between; align-items:center; margin-bottom:2rem; padding:1rem 0; }
    .welcome-text h1 { font-size:2rem; color:#003366; margin-bottom:.5rem; }
    .welcome-text p { color:#666; }
    
    /* Search bar styles */
    .search-bar-container { margin-bottom: 1.5rem; }
    .search-bar-container input { 
        width: 100%; 
        max-width: 500px; 
        padding: 0.8rem 1.2rem; 
        border-radius: 10px; 
        border: 2px solid #ddd; 
        font-size: 1rem;
        transition: all 0.3s ease;
        box-shadow: 0 2px 10px rgba(0,0,0,0.05);
    }
    .search-bar-container input:focus { 
        outline: none; 
        border-color: #0072ce; 
        box-shadow: 0 4px 20px rgba(0, 114, 206, 0.15);
    }
    .search-bar-container input::placeholder {
        color: #999;
    }
    
    .table-container { background:#fff; border-radius:15px; box-shadow:0 4px 20px rgba(0,0,0,0.08); overflow:hidden; }
    table { width:100%; border-collapse:collapse; }
    th { background:#f8f9fa; padding:1rem; text-align:left; font-weight:600; color:#1a1a1a; border-bottom:2px solid #e9ecef; }
    td { padding:1rem; border-bottom:1px solid #e9ecef; }
    .status { padding:.4rem .8rem; border-radius:20px; font-weight:600; font-size:.85rem; }
    .status.pending { background:#fff3cd; color:#856404; }
    .status.approved { background:#d4edda; color:#155724; }
    .status.rejected { background:#f8d7da; color:#721c24; }
    .actions { display:flex; gap:.5rem; }
    .btn { padding:.5rem 1rem; border-radius:8px; border:none; cursor:pointer; font-weight:600; font-size:.9rem; }
    .btn.primary { background:#007bff; color:#fff; }
    .btn.success { background:#28a745; color:#fff; }
    .btn.danger { background:#dc3545; color:#fff; }
    
    @media (max-width:1024px){ .sidebar{width:250px;} .main-content{margin-left:250px;} }
    @media (max-width:768px){ .sidebar{transform:translateX(-100%);} .main-content{margin-left:0;} }
</style>
{% endblock %}

{% block content %}
<div class="dashboard-container">
  <!-- Sidebar -->
  <div class="sidebar">
    <div class="sidebar-header">
      <div class="sidebar-logo">
        {% if user.profile_picture %}
          <img id="sidebarProfilePicture" src="{{ url_for('static', filename='uploads/profile_pictures/' + user.profile_picture) }}" alt="Profile Picture">
        {% else %}
          <img id="sidebarProfilePicture" src="{{ url_for('static', filename='images/uc-logo.png') }}" alt="UC Logo">
        {% endif %}
      </div>
      <div class="sidebar-brand">Scholarsphere</div>
      <div class="sidebar-subtitle">{% if user.role == 'provider_admin' %}Provider Admin Portal{% else %}Provider Staff Portal{% endif %}</div>
    </div>
    <nav class="sidebar-nav">
      <div class="nav-item" onclick="window.location.href='{{ url_for('provider.dashboard') }}'"><i class="fas fa-home"></i> Dashboard</div>
      {% if user.role == 'provider_admin' %}
      <div class="nav-item" onclick="window.location.href='{{ url_for('provider.scholarships') }}'"><i class="fas fa-graduation-cap"></i> Manage Scholarships</div>
      {% endif %}
      <div class="nav-item" onclick="window.location.href='{{ url_for('provider.applications') }}'"><i class="fas fa-clipboard-list"></i> Applications</div>
      <div class="nav-item active"><i class="fas fa-calendar-alt"></i> Schedules</div>
      <div class="nav-item" onclick="window.location.href='{{ url_for('provider.documents') }}'"><i class="fas fa-file-alt"></i> Documents</div>
      {% if user.role == 'provider_admin' %}
      <div class="nav-item" onclick="window.location.href='{{ url_for('provider.staff_management') }}'"><i class="fas fa-users-cog"></i> Staff Account Management</div>
      <div class="nav-item" onclick="window.location.href='{{ url_for('provider.reports') }}'"><i class="fas fa-chart-bar"></i> Reports & Analytics</div>
      {% endif %}
      <div class="nav-item" onclick="window.location.href='{{ url_for('provider.profile') }}'"><i class="fas fa-building"></i> {% if user.role == 'provider_staff' %}User Profile{% else %}Organization Profile{% endif %}</div>
      <div class="nav-item" onclick="window.location.href='{{ url_for('logout') }}'"><i class="fas fa-sign-out-alt"></i> Logout</div>
    </nav>
    <div style="padding: 1rem 1.5rem; margin-top: 2rem; border-top: 1px solid rgba(255,255,255,0.1);">
      <button onclick="openProviderGuidelinesModal()" style="background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); color: #fff; padding: 0.75rem 1rem; border-radius: 8px; font-weight: 600; cursor: pointer; font-size: 0.9rem; width: 100%; text-align: center; transition: all 0.3s;">
        <i class="fas fa-info-circle"></i> Guidelines
      </button>
    </div>
  </div>

  <!-- Main Content -->
  <div class="main-content">
    <div class="top-bar">
      <div class="welcome-text">
        <h1>Schedule Appointments</h1>
        <p>Review applications and schedule interviews</p>
      </div>
    </div>

    <!-- Search Bar -->
    <div class="search-bar-container">
      <input type="text" id="scheduleSearch" placeholder="Search by student name, scholarship title, or code..." autocomplete="off">
    </div>

    <div class="table-container">
      <table>
        <thead>
          <tr>
            <th>Application ID</th>
            <th>Student Name</th>
            <th>Scholarship</th>
            <th>Status</th>
            <th>Date Applied</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody>
          {% if applications %}
            {% for app in applications %}
            <tr class="schedule-row" data-student-name="{{ app.student_name.lower() }}" data-scholarship-title="{{ app.scholarship_title.lower() }}" data-scholarship-code="{{ app.scholarship_code.lower() }}">
              <td>{{ app.application_id }}</td>
              <td><strong>{{ app.student_name }}</strong><br><small>{{ app.student_email }}</small></td>
              <td><strong>{{ app.scholarship_code }}</strong><br><small>{{ app.scholarship_title }}</small></td>
              <td><span class="status {{ app.status.lower() }}">{{ app.status }}</span></td>
              <td>{{ app.date_applied }}</td>
              <td>
                <div class="actions" id="actions-{{ app.application_id_raw }}">
                  {% if app.status.lower() == 'pending' %}
                  <button class="btn primary" onclick="scheduleAppointment({{ app.application_id_raw }}, '{{ app.student_name|escape }}')">
                    <i class="fas fa-calendar-plus"></i> Schedule
                  </button>
                  {% endif %}
                </div>
              </td>
            </tr>
            {% endfor %}
          {% else %}
            <tr id="noApplicationsRow">
              <td colspan="6" style="text-align:center; padding:3rem;">
                <i class="fas fa-calendar-times" style="font-size:3rem; color:#ddd; margin-bottom:1rem;"></i>
                <p>No applications to schedule yet.</p>
              </td>
            </tr>
          {% endif %}
        </tbody>
      </table>
    </div>
  </div>
</div>

<!-- Schedule Modal -->
<div id="scheduleModal" class="modal" style="display:none;">
  <div class="modal-content" style="max-width:600px;">
    <div class="modal-header">
      <h2 class="modal-title">Schedule Appointment</h2>
      <button class="close" onclick="closeScheduleModal()">&times;</button>
    </div>
    <form id="scheduleForm">
      <input type="hidden" id="scheduleApplicationId" name="application_id">
      <div class="modal-body">
        <div class="form-group">
          <label>Student</label>
          <div id="scheduleStudentName" style="padding:.5rem; background:#f8f9fa; border-radius:5px;"></div>
        </div>
        <div class="form-group">
          <label>Date *</label>
          <input type="date" class="form-control" name="schedule_date" required min="{{ today_date }}">
        </div>
        <div class="form-group">
          <label>Time *</label>
          <input type="time" class="form-control" name="schedule_time" required>
        </div>
        <div class="form-group">
          <label>Location</label>
          <input type="text" class="form-control" name="location" placeholder="e.g., UC Main Campus, Room 301">
        </div>
        <div class="form-group">
          <label>Notes/Instructions</label>
          <textarea class="form-control" name="notes" rows="3" placeholder="Any special instructions for the student..."></textarea>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn-modal secondary" onclick="closeScheduleModal()">Cancel</button>
        <button type="submit" class="btn-modal primary">Schedule Appointment</button>
      </div>
    </form>
  </div>
</div>

<!-- Schedule Confirmation Modal -->
<div id="scheduleConfirmModal" class="modal" style="display:none;">
  <div class="modal-content" style="max-width:600px;">
    <div class="modal-header">
      <h2 class="modal-title">Schedule Created</h2>
      <button class="close" onclick="closeScheduleConfirm()">&times;</button>
    </div>
    <div class="modal-body" id="scheduleConfirmBody" style="padding:2rem;"></div>
    <div class="modal-footer">
      <button type="button" class="btn-modal secondary" onclick="closeScheduleConfirm()">Close</button>
    </div>
  </div>
</div>

<style>
.modal { position:fixed; z-index:1000; left:0; top:0; width:100%; height:100%; background:rgba(0,0,0,0.5); }
.modal-content { background:#fff; margin:2% auto; padding:0; border-radius:15px; max-height:90vh; overflow-y:auto; box-shadow:0 10px 30px rgba(0,0,0,0.3); }
.modal-header { padding:1.5rem; border-bottom:1px solid #e9ecef; background:#f8f9fa; border-radius:15px 15px 0 0; display:flex; justify-content:space-between; align-items:center; }
.modal-title { margin:0; font-size:1.5rem; color:#003366; font-weight:700; }
.close { background:none; border:none; font-size:2rem; cursor:pointer; color:#666; padding:0; width:30px; height:30px; display:flex; align-items:center; justify-content:center; }
.close:hover { color:#000; }
.modal-body { padding:2rem; }
.form-group { margin-bottom:1.5rem; }
.form-group label { display:block; margin-bottom:.5rem; font-weight:600; color:#333; }
.form-control { width:100%; padding:.75rem; border:1px solid #ddd; border-radius:8px; font-size:1rem; }
.modal-footer { padding:1.5rem; border-top:1px solid #e9ecef; background:#f8f9fa; border-radius:0 0 15px 15px; display:flex; justify-content:flex-end; gap:1rem; }
.btn-modal { padding:.75rem 1.5rem; border:none; border-radius:8px; font-weight:600; cursor:pointer; }
.btn-modal.primary { background:#007bff; color:#fff; }
.btn-modal.secondary { background:#6c757d; color:#fff; }
</style>

<script>
function scheduleAppointment(applicationId, studentName) {
  document.getElementById('scheduleApplicationId').value = applicationId;
  document.getElementById('scheduleStudentName').textContent = studentName;
  document.getElementById('scheduleModal').style.display = 'block';
}

function retractApplication(applicationId) {
  if (!confirm('Retract this application back to pending?')) return;
  fetch(`/provider/api/application/${applicationId}/retract`, { method: 'POST', headers: { 'Content-Type': 'application/json' }})
    .then(r => r.json())
    .then(d => {
      if (d.success) { showNotification('Application retracted to pending.', 'success'); location.reload(); }
      else { showNotification('Error: ' + (d.error || 'Unknown error'), 'error'); }
    })
    .catch(err => { console.error('Error:', err); showNotification('Failed to retract application', 'error'); });
}

function closeScheduleConfirm(){ document.getElementById('scheduleConfirmModal').style.display='none'; }

function closeScheduleModal() {
  document.getElementById('scheduleModal').style.display = 'none';
  document.getElementById('scheduleForm').reset();
}

function reviewApplication(applicationId, action) {
  if (!confirm(`Are you sure you want to ${action} this application?`)) return;
  
  fetch(`/provider/api/application/${applicationId}/review`, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ action: action })
  })
  .then(r => r.json())
  .then(d => {
    if (d.success) {
      showNotification(`Application ${action}d successfully!`, 'success');
      location.reload();
    } else {
      showNotification('Error: ' + (d.error || 'Unknown error'), 'error');
    }
  })
  .catch(err => {
    console.error('Error:', err);
    showNotification('Error processing application', 'error');
  });
}

document.getElementById('scheduleForm').addEventListener('submit', async function(e) {
  e.preventDefault();
  
  const formData = {
    application_id: document.getElementById('scheduleApplicationId').value,
    schedule_date: this.schedule_date.value,
    schedule_time: this.schedule_time.value,
    location: this.location.value,
    notes: this.notes.value
  };
  
  fetch(`/provider/api/application/${formData.application_id}/schedule`, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(formData) })
    .then(r=>r.json())
    .then(d=>{
      if(d.success){
        // Update row actions with note and remove schedule button
        const actions = document.getElementById(`actions-${formData.application_id}`);
        if (actions){
          actions.innerHTML = `<div class=\"schedule-note\" style=\"text-align:left;\">\n            <strong>Scheduled:</strong> ${formData.schedule_date} ${formData.schedule_time}<br>\n            <strong>Location:</strong> ${formData.location || 'TBD'}<br>\n            ${formData.notes ? `<strong>Notes:</strong> ${formData.notes}` : ''}\n          </div>`;
        }
        // Close creation modal and show confirmation details
        closeScheduleModal();
        const body = document.getElementById('scheduleConfirmBody');
        body.innerHTML = `
          <div style=\"display:grid; gap:.75rem;\">
            <div><strong>Application:</strong> APP-${String(formData.application_id).padStart(3,'0')}</div>
            <div><strong>Date:</strong> ${formData.schedule_date}</div>
            <div><strong>Time:</strong> ${formData.schedule_time}</div>
            <div><strong>Location:</strong> ${formData.location || 'TBD'}</div>
            ${formData.notes ? `<div><strong>Notes:</strong> ${formData.notes}</div>` : ''}
          </div>`;
        document.getElementById('scheduleConfirmModal').style.display = 'block';
      } else {
        showNotification('Error: ' + (d.error || 'Failed to schedule'), 'error');
      }
    })
    .catch(err=>{ console.error(err); showNotification('Failed to schedule', 'error'); });
});

window.onclick = function(event) {
  const modal = document.getElementById('scheduleModal');
  if (event.target === modal) closeScheduleModal();
}

// Search functionality
document.addEventListener('DOMContentLoaded', function() {
  const searchInput = document.getElementById('scheduleSearch');
  const scheduleRows = document.querySelectorAll('.schedule-row');
  const noApplicationsRow = document.getElementById('noApplicationsRow');
  const tbody = document.querySelector('tbody');
  
  // Create a "no results" row if it doesn't exist
  let noResultsRow = null;
  
  function createNoResultsRow() {
    if (!noResultsRow) {
      noResultsRow = document.createElement('tr');
      noResultsRow.id = 'noResultsRow';
      noResultsRow.style.display = 'none';
      noResultsRow.innerHTML = `
        <td colspan="6" style="text-align:center; padding:3rem;">
          <i class="fas fa-search" style="font-size:3rem; color:#ddd; margin-bottom:1rem;"></i>
          <p>No matching applications found.</p>
        </td>
      `;
      tbody.appendChild(noResultsRow);
    }
  }
  
  createNoResultsRow();
  
  function performSearch() {
    const query = searchInput.value.toLowerCase().trim();
    let visibleCount = 0;
    
    scheduleRows.forEach(row => {
      const studentName = row.getAttribute('data-student-name') || '';
      const scholarshipTitle = row.getAttribute('data-scholarship-title') || '';
      const scholarshipCode = row.getAttribute('data-scholarship-code') || '';
      
      if (query === '' || studentName.includes(query) || scholarshipTitle.includes(query) || scholarshipCode.includes(query)) {
        row.style.display = '';
        if (query !== '') {
          visibleCount++;
        }
      } else {
        row.style.display = 'none';
      }
    });
    
    // Show/hide no results message
    if (query !== '' && visibleCount === 0) {
      noResultsRow.style.display = '';
      if (noApplicationsRow) {
        noApplicationsRow.style.display = 'none';
      }
    } else {
      noResultsRow.style.display = 'none';
      if (noApplicationsRow) {
        noApplicationsRow.style.display = '';
      }
    }
  }
  
  searchInput.addEventListener('input', performSearch);
  searchInput.addEventListener('keyup', performSearch);
});

// Listen for profile picture updates across tabs
window.addEventListener('storage', function(e) {
    if (e.key === 'provider_profile_picture_url') {
        const sidebarImg = document.getElementById('sidebarProfilePicture');
        if (sidebarImg && e.newValue) {
            sidebarImg.src = e.newValue;
        }
    }
});

// Listen for profile picture updates on same page
window.addEventListener('profilePictureUpdated', function(e) {
    const sidebarImg = document.getElementById('sidebarProfilePicture');
    if (sidebarImg && e.detail && e.detail.imageUrl) {
        sidebarImg.src = e.detail.imageUrl;
    }
});
</script>

<!-- Provider Guidelines Modal -->
<div id="providerGuidelinesModal" style="display: none; position: fixed; z-index: 10000; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); overflow: auto;">
    <div style="background: #fff; margin: 5% auto; padding: 0; border-radius: 15px; width: 90%; max-width: 700px; max-height: 85vh; display: flex; flex-direction: column; box-shadow: 0 8px 32px rgba(0,0,0,0.2);">
        <div style="padding: 1.5rem 2rem; border-bottom: 2px solid #e9ecef; display: flex; justify-content: space-between; align-items: center;">
            <h2 style="margin: 0; color: #003366; font-size: 1.8rem;">{% if user.role == 'provider_admin' %}Provider Admin Portal{% else %}Provider Staff Portal{% endif %} Guidelines</h2>
            <button onclick="closeProviderGuidelinesModal()" style="background: none; border: none; font-size: 1.8rem; color: #666; cursor: pointer; padding: 0; width: 32px; height: 32px; display: flex; align-items: center; justify-content: center;">&times;</button>
        </div>
        <div style="padding: 2rem; overflow-y: auto; flex: 1;">
            <h3 style="color: #003366; margin-bottom: 1.5rem; font-size: 1.5rem;">Guidelines for Provider</h3>
            <ul style="list-style: none; padding: 0; margin: 0;">
                <li style="margin-bottom: 1rem; padding-left: 1.5rem; position: relative; line-height: 1.6;">
                    <span style="position: absolute; left: 0; color: #0072ce; font-weight: bold;">•</span>
                    In your dashboard, you can see brief info of the scholarships and number of applicants.
                </li>
                <li style="margin-bottom: 1rem; padding-left: 1.5rem; position: relative; line-height: 1.6;">
                    <span style="position: absolute; left: 0; color: #0072ce; font-weight: bold;">•</span>
                    You can also send announcement to your offered scholarship to those who applied or to a specific student.
                </li>
                <li style="margin-bottom: 1rem; padding-left: 1.5rem; position: relative; line-height: 1.6;">
                    <span style="position: absolute; left: 0; color: #0072ce; font-weight: bold;">•</span>
                    You can create scholarship in "Manage Scholarships". Once created it's marked as draft and click publish to go online. You can also view, update, create a PDF report, and archive.
                </li>
                <li style="margin-bottom: 1rem; padding-left: 1.5rem; position: relative; line-height: 1.6;">
                    <span style="position: absolute; left: 0; color: #0072ce; font-weight: bold;">•</span>
                    Another list will appear if you archive. You can create a PDF report of it as well.
                </li>
                <li style="margin-bottom: 1rem; padding-left: 1.5rem; position: relative; line-height: 1.6;">
                    <span style="position: absolute; left: 0; color: #0072ce; font-weight: bold;">•</span>
                    Once archived, the students who are approved/applying the scholarship will be removed. You can restore it and those students will have to apply again if they want to. An update will be sent to the students accordingly.
                </li>
                <li style="margin-bottom: 1rem; padding-left: 1.5rem; position: relative; line-height: 1.6;">
                    <span style="position: absolute; left: 0; color: #0072ce; font-weight: bold;">•</span>
                    You can check the application of the students of the scholarship you created and view their details. Approve their documents. Approval can happen when you verified all the documents. You can reject anytime.
                </li>
                <li style="margin-bottom: 1rem; padding-left: 1.5rem; position: relative; line-height: 1.6;">
                    <span style="position: absolute; left: 0; color: #0072ce; font-weight: bold;">•</span>
                    You can set appointments to student in schedule page, multiple scheduled appointment can be sent to the student.
                </li>
                <li style="margin-bottom: 1rem; padding-left: 1.5rem; position: relative; line-height: 1.6;">
                    <span style="position: absolute; left: 0; color: #0072ce; font-weight: bold;">•</span>
                    In documents you can search student name or id to check their document, you can check even all the students available even if they are not on your scholarship and you can only view their document.
                </li>
                <li style="margin-bottom: 1rem; padding-left: 1.5rem; position: relative; line-height: 1.6;">
                    <span style="position: absolute; left: 0; color: #0072ce; font-weight: bold;">•</span>
                    In Organization is where your information is and you can update it as well.
                </li>
            </ul>
        </div>
    </div>
</div>

<script>
function openProviderGuidelinesModal() {
    document.getElementById('providerGuidelinesModal').style.display = 'block';
}

function closeProviderGuidelinesModal() {
    document.getElementById('providerGuidelinesModal').style.display = 'none';
}

window.onclick = function(event) {
    const modal = document.getElementById('providerGuidelinesModal');
    if (event.target == modal) {
        closeProviderGuidelinesModal();
    }
}
</script>
{% endblock %}


