{% extends "base.html" %}

{% block title %}Manage Scholarships - Scholarsphere | Provider{% endblock %}

{% block extra_css %}
<style>
    .dashboard-container { display:flex; min-height:100vh; }
    .sidebar { width:280px; background: linear-gradient(135deg, #003366 0%, #0072ce 100%); color:#fff; padding:2rem 0; position:fixed; height:100vh; overflow-y:auto; }
    .sidebar-header { text-align:center; padding:0 2rem 2rem 2rem; border-bottom:1px solid rgba(255,255,255,0.1); }
    .sidebar-logo { width:60px; height:60px; background:#fff; border-radius:50%; margin:0 auto 1rem; display:flex; align-items:center; justify-content:center; overflow:hidden; }
    .sidebar-logo img { width:50px; height:50px; object-fit:cover; border-radius:50%; }
    .sidebar-brand { font-size:1.2rem; font-weight:700; margin-bottom:.5rem; }
    .sidebar-subtitle { font-size:.9rem; opacity:.8; }
    .sidebar-nav { padding:2rem 0; }
    .nav-item { padding:1rem 2rem; cursor:pointer; transition:background .3s; border-left:3px solid transparent; }
    .nav-item:hover, .nav-item.active { background:rgba(255,255,255,0.1); border-left-color:#ffc72c; }
    .nav-item i { margin-right:1rem; width:20px; }

    .main-content { flex:1; margin-left:280px; padding:2rem; }
    .top-bar { display:flex; justify-content:space-between; align-items:center; margin-bottom:2rem; padding:1rem 0; }
    .welcome-text h1 { font-size:2rem; color:#003366; margin-bottom:.5rem; }
    .welcome-text p { color:#666; }
    .user-menu { display:flex; align-items:center; gap:1rem; }
    .user-avatar { width:50px; height:50px; border-radius:50%; background:#0072ce; display:flex; align-items:center; justify-content:center; color:#fff; font-weight:600; }

    .table-container { background:#fff; border-radius:15px; box-shadow:0 4px 20px rgba(0,0,0,0.08); overflow:hidden; }
    .table-header { padding:1.5rem; border-bottom:1px solid #e9ecef; background:#f8f9fa; display:flex; justify-content:space-between; align-items:center; }
    .btn-primary { background:#1273eb; color:#fff; border:0; padding:.7rem 1rem; border-radius:10px; font-weight:600; cursor:pointer; }
    table { width:100%; border-collapse:collapse; }
    th { background:#f8f9fa; padding:1rem; text-align:left; font-weight:600; color:#1a1a1a; border-bottom:2px solid #e9ecef; }
    td { padding:1rem; border-bottom:1px solid #e9ecef; vertical-align:middle; }
    .status { padding:.25rem .6rem; border-radius:16px; font-weight:700; font-size:.85rem; }
    .status.active { background:#dff7e6; color:#137a2a; }
    .status.draft { background:#fff2d6; color:#7a5b13; }
    .actions { display:flex; gap:.5rem; }
    .btn { padding:.5rem .8rem; border-radius:10px; border:0; cursor:pointer; font-weight:600; }
    .btn.gray { background:#e5e8ee; color:#233046; }
    .btn.yellow { background:#ffc72c; color:#233046; }
    .btn.red { background:#dc3545; color:#fff; }
    .btn.blue { background:#007bff; color:#fff; }

    /* Modal Styles */
    .modal { display:none; position:fixed; z-index:1000; left:0; top:0; width:100%; height:100%; background:rgba(0,0,0,0.5); }
    .modal-content { background:#fff; margin:2% auto; padding:0; border-radius:15px; width:90%; max-width:800px; max-height:90vh; overflow-y:auto; box-shadow:0 10px 30px rgba(0,0,0,0.3); }
    .modal-header { padding:1.5rem; border-bottom:1px solid #e9ecef; background:#f8f9fa; border-radius:15px 15px 0 0; display:flex; justify-content:space-between; align-items:center; }
    .modal-title { font-size:1.5rem; font-weight:700; color:#003366; margin:0; }
    .close { background:none; border:none; font-size:2rem; color:#666; cursor:pointer; padding:0; width:30px; height:30px; display:flex; align-items:center; justify-content:center; }
    .close:hover { color:#000; }
    .modal-body { padding:2rem; }
    .form-group { margin-bottom:1.5rem; }
    .form-label { display:block; margin-bottom:0.5rem; font-weight:600; color:#333; }
    .form-control { width:100%; padding:0.75rem; border:1px solid #ddd; border-radius:8px; font-size:1rem; transition:border-color 0.3s; }
    .form-control:focus { outline:none; border-color:#007bff; box-shadow:0 0 0 2px rgba(0,123,255,0.25); }
    .form-control[type="date"] { padding:0.75rem; }
    .form-control[type="textarea"] { min-height:100px; resize:vertical; }
    .modal-footer { padding:1.5rem; border-top:1px solid #e9ecef; background:#f8f9fa; border-radius:0 0 15px 15px; display:flex; justify-content:flex-end; gap:1rem; }
    .btn-modal { padding:0.75rem 1.5rem; border:none; border-radius:8px; font-weight:600; cursor:pointer; transition:all 0.3s; }
    .btn-modal.primary { background:#007bff; color:#fff; }
    .btn-modal.primary:hover { background:#0056b3; }
    .btn-modal.secondary { background:#6c757d; color:#fff; }
    .btn-modal.secondary:hover { background:#545b62; }

    @media (max-width:1024px){ .sidebar{width:250px;} .main-content{margin-left:250px;} }
    @media (max-width:768px){ .sidebar{transform:translateX(-100%); transition:transform .3s;} .sidebar.open{transform:translateX(0);} .main-content{margin-left:0;} .modal-content{width:95%; margin:5% auto;} }
</style>
{% endblock %}

{% block content %}
<div class="dashboard-container">
  <!-- Sidebar -->
  <div class="sidebar">
    <div class="sidebar-header">
      <div class="sidebar-logo">
        <img src="{{ url_for('static', filename='images/uc-logo.png') }}" alt="UC Logo">
      </div>
      <div class="sidebar-brand">Scholarsphere</div>
      <div class="sidebar-subtitle">Provider Portal</div>
    </div>
    <nav class="sidebar-nav">
      <div class="nav-item" onclick="window.location.href='{{ url_for('provider.dashboard') }}'"><i class="fas fa-home"></i> Dashboard</div>
      <div class="nav-item active"><i class="fas fa-graduation-cap"></i> Manage Scholarships</div>
      <div class="nav-item" onclick="window.location.href='{{ url_for('provider.applications') }}'"><i class="fas fa-clipboard-list"></i> Applications</div>
      <div class="nav-item" onclick="window.location.href='{{ url_for('provider.schedules') }}'"><i class="fas fa-calendar-alt"></i> Schedules</div>
      <div class="nav-item" onclick="window.location.href='{{ url_for('provider.documents') }}'"><i class="fas fa-file-alt"></i> Documents</div>
      <div class="nav-item" onclick="window.location.href='{{ url_for('provider.remarks') }}'"><i class="fas fa-comments"></i> Review Remarks</div>
      <div class="nav-item" onclick="window.location.href='{{ url_for('provider.profile') }}'"><i class="fas fa-building"></i> Organization Profile</div>
      <div class="nav-item" onclick="window.location.href='{{ url_for('logout') }}'"><i class="fas fa-sign-out-alt"></i> Logout</div>
    </nav>
  </div>

  <!-- Main Content -->
  <div class="main-content">
    <div class="top-bar">
      <div class="welcome-text">
        <h1>Manage Scholarships</h1>
        <p>Welcome, {{ current_user.organization or 'Provider' }}!</p>
      </div>
      <div class="user-menu"><div class="user-avatar">UC</div></div>
    </div>

    <div class="table-container">
      <div class="table-header">
        <h3>Scholarships</h3>
        <button class="btn-primary" onclick="createScholarship()"><i class="fas fa-plus"></i> Create New Scholarship</button>
      </div>
      <table>
      <thead>
        <tr>
          <th>Scholarship ID</th>
          <th>Title</th>
          <th>Deadline</th>
          <th>Create Date</th>
          <th>Applications</th>
          <th>Status</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody>
        {% for s in scholarships %}
        <tr>
          <td>{{ s.id }}</td>
          <td>{{ s.title }}</td>
          <td>{{ s.deadline }}</td>
          <td>{{ s.created_date }}</td>
          <td>{{ s.applications }}</td>
          <td>
            {% if s.status.lower() == 'approved' %}
              <span class="status active">Active</span>
            {% else %}
              <span class="status draft">Draft</span>
            {% endif %}
          </td>
          <td>
            <div class="actions">
              <button class="btn blue" onclick="viewScholarship('{{ s.id }}')">View</button>
              <button class="btn gray" onclick="editScholarship('{{ s.id }}')">Update</button>
              <button class="btn red" onclick="deleteScholarship('{{ s.id }}')">Delete</button>
              {% if s.status.lower() == 'draft' %}
                <button class="btn yellow" onclick="publishScholarshipPk({{ loop.index0 }})">Publish</button>
              {% endif %}
            </div>
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
    </div>
  </div>
</div>

<!-- Create Scholarship Modal -->
<div id="createScholarshipModal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h2 class="modal-title">Create New Scholarship</h2>
      <button class="close" onclick="closeCreateModal()">&times;</button>
    </div>
    <form id="createScholarshipForm">
      <div class="modal-body">
        <div class="form-group">
          <label for="scholarshipCode" class="form-label">Scholarship Code *</label>
          <input type="text" id="scholarshipCode" name="code" class="form-control" placeholder="e.g., SCH-001" required pattern="[A-Za-z0-9-]+" title="Alphanumeric characters and hyphens only">
        </div>
        <div class="form-group">
          <label for="scholarshipTitle" class="form-label">Title *</label>
          <input type="text" id="scholarshipTitle" name="title" class="form-control" placeholder="e.g., Academic Excellence Scholarship" required>
        </div>
        <div class="form-group">
          <label for="scholarshipDeadline" class="form-label">Deadline *</label>
          <input type="date" id="scholarshipDeadline" name="deadline" class="form-control" required>
        </div>
        <div class="form-group">
          <label for="scholarshipRequirements" class="form-label">Requirements *</label>
          <textarea id="scholarshipRequirements" name="requirements" class="form-control" placeholder="List the requirements for this scholarship..." required></textarea>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn-modal secondary" onclick="closeCreateModal()">Cancel</button>
        <button type="submit" class="btn-modal primary">Create Scholarship</button>
      </div>
    </form>
  </div>
</div>

<!-- View Scholarship Modal -->
<div id="viewScholarshipModal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h2 class="modal-title">Scholarship Details</h2>
      <button class="close" onclick="closeViewModal()">&times;</button>
    </div>
    <div class="modal-body" id="viewScholarshipContent">
      <!-- Content will be loaded dynamically -->
    </div>
    <div class="modal-footer">
      <button type="button" class="btn-modal secondary" onclick="closeViewModal()">Close</button>
    </div>
  </div>
</div>

<!-- Edit Scholarship Modal -->
<div id="editScholarshipModal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h2 class="modal-title">Update Scholarship</h2>
      <button class="close" onclick="closeEditModal()">&times;</button>
    </div>
    <form id="editScholarshipForm">
      <div class="modal-body">
        <input type="hidden" id="editScholarshipId" name="id">
        <div class="form-group">
          <label for="editScholarshipCode" class="form-label">Scholarship Code *</label>
          <input type="text" id="editScholarshipCode" name="code" class="form-control" required pattern="[A-Za-z0-9-]+" title="Alphanumeric characters and hyphens only">
        </div>
        <div class="form-group">
          <label for="editScholarshipTitle" class="form-label">Title *</label>
          <input type="text" id="editScholarshipTitle" name="title" class="form-control" required>
        </div>
        <div class="form-group">
          <label for="editScholarshipDeadline" class="form-label">Deadline *</label>
          <input type="date" id="editScholarshipDeadline" name="deadline" class="form-control" required>
        </div>
        <div class="form-group">
          <label for="editScholarshipRequirements" class="form-label">Requirements *</label>
          <textarea id="editScholarshipRequirements" name="requirements" class="form-control" required></textarea>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn-modal secondary" onclick="closeEditModal()">Cancel</button>
        <button type="submit" class="btn-modal primary">Update Scholarship</button>
      </div>
    </form>
  </div>
</div>

<script>
// Modal functions
function createScholarship(){ 
  document.getElementById('createScholarshipModal').style.display = 'block';
  document.getElementById('createScholarshipForm').reset();
}

function closeCreateModal(){
  document.getElementById('createScholarshipModal').style.display = 'none';
}

function closeViewModal(){
  document.getElementById('viewScholarshipModal').style.display = 'none';
}

function closeEditModal(){
  document.getElementById('editScholarshipModal').style.display = 'none';
}

// Close modals when clicking outside
window.onclick = function(event) {
  const createModal = document.getElementById('createScholarshipModal');
  const viewModal = document.getElementById('viewScholarshipModal');
  const editModal = document.getElementById('editScholarshipModal');
  
  if (event.target === createModal) {
    closeCreateModal();
  }
  if (event.target === viewModal) {
    closeViewModal();
  }
  if (event.target === editModal) {
    closeEditModal();
  }
}

// View scholarship function
function viewScholarship(id){
  fetch(`/provider/api/scholarship/${id}`)
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        const content = document.getElementById('viewScholarshipContent');
        content.innerHTML = `
          <div style="display: grid; gap: 1rem;">
            <div><strong>Code:</strong> ${data.scholarship.code}</div>
            <div><strong>Title:</strong> ${data.scholarship.title}</div>
            <div><strong>Deadline:</strong> ${data.scholarship.deadline}</div>
            <div><strong>Created:</strong> ${data.scholarship.created_date}</div>
            <div><strong>Status:</strong> <span class="status ${data.scholarship.status.toLowerCase()}">${data.scholarship.status}</span></div>
            <div><strong>Applications:</strong> ${data.scholarship.applications}</div>
            <div><strong>Requirements:</strong><br>${data.scholarship.requirements.replace(/\n/g, '<br>')}</div>
          </div>
        `;
        document.getElementById('viewScholarshipModal').style.display = 'block';
      } else {
        alert('Error loading scholarship: ' + (data.error || 'Unknown error'));
      }
    })
    .catch(error => {
      console.error('Error:', error);
      alert('Error loading scholarship details');
    });
}

// Edit scholarship function
function editScholarship(id){
  fetch(`/provider/api/scholarship/${id}`)
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        document.getElementById('editScholarshipId').value = data.scholarship.id;
        document.getElementById('editScholarshipCode').value = data.scholarship.code;
        document.getElementById('editScholarshipTitle').value = data.scholarship.title;
        document.getElementById('editScholarshipDeadline').value = data.scholarship.deadline;
        document.getElementById('editScholarshipRequirements').value = data.scholarship.requirements;
        document.getElementById('editScholarshipModal').style.display = 'block';
      } else {
        alert('Error loading scholarship: ' + (data.error || 'Unknown error'));
      }
    })
    .catch(error => {
      console.error('Error:', error);
      alert('Error loading scholarship details');
    });
}

// Delete scholarship function
function deleteScholarship(id){
  if (confirm('Are you sure you want to delete this scholarship? This action cannot be undone.')) {
    fetch(`/provider/api/scholarship/${id}`, {
      method: 'DELETE',
      headers: {
        'Content-Type': 'application/json',
      }
    })
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        alert('Scholarship deleted successfully');
        location.reload();
      } else {
        alert('Error deleting scholarship: ' + (data.error || 'Unknown error'));
      }
    })
    .catch(error => {
      console.error('Error:', error);
      alert('Error deleting scholarship');
    });
  }
}

// Form submission handlers
document.getElementById('createScholarshipForm').addEventListener('submit', function(e) {
  e.preventDefault();
  
  const formData = new FormData(this);
  const data = Object.fromEntries(formData);
  
  fetch('/provider/api/create-scholarship', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
    },
    body: JSON.stringify(data)
  })
  .then(response => response.json())
  .then(data => {
    if (data.success) {
      alert('Scholarship created successfully!');
      closeCreateModal();
      location.reload();
    } else {
      alert('Error creating scholarship: ' + (data.error || 'Unknown error'));
    }
  })
  .catch(error => {
    console.error('Error:', error);
    alert('Error creating scholarship');
  });
});

document.getElementById('editScholarshipForm').addEventListener('submit', function(e) {
  e.preventDefault();
  
  const formData = new FormData(this);
  const data = Object.fromEntries(formData);
  const id = data.id;
  
  fetch(`/provider/api/scholarship/${id}`, {
    method: 'PUT',
    headers: {
      'Content-Type': 'application/json',
    },
    body: JSON.stringify(data)
  })
  .then(response => response.json())
  .then(data => {
    if (data.success) {
      alert('Scholarship updated successfully!');
      closeEditModal();
      location.reload();
    } else {
      alert('Error updating scholarship: ' + (data.error || 'Unknown error'));
    }
  })
  .catch(error => {
    console.error('Error:', error);
    alert('Error updating scholarship');
  });
});

function publishScholarshipPk(index){
  // We don't have the PK in the table, so request by code -> server maps code to pk
  const code = document.querySelectorAll('tbody tr')[index].children[0].textContent.trim();
  fetch('/provider/api/publish-by-code', {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ code })})
    .then(r=>r.json()).then(d=>{ if(d.success){ location.reload(); } else { alert(d.error||'Failed'); } });
}

function viewApps(id){ alert('Viewing applications for ' + id); }
function publishScholarship(id){ alert('Publish ' + id + ' coming soon'); }
</script>
{% endblock %}



