{% extends "base.html" %}

{% block title %}Manage Scholarships - Scholarsphere | Provider{% endblock %}

{% block extra_css %}
<style>
    .dashboard-container { display:flex; min-height:100vh; }
    .sidebar { width:280px; background: linear-gradient(135deg, #003366 0%, #0072ce 100%); color:#fff; padding:2rem 0; position:fixed; height:100vh; overflow-y:auto; }
    .sidebar-header { text-align:center; padding:0 2rem 2rem 2rem; border-bottom:1px solid rgba(255,255,255,0.1); }
    .sidebar-logo { width:60px; height:60px; background:#fff; border-radius:50%; margin:0 auto 1rem; display:flex; align-items:center; justify-content:center; overflow:hidden; }
    .sidebar-logo img { width:100%; height:100%; object-fit:cover; border-radius:50%; }
    .sidebar-brand { font-size:1.2rem; font-weight:700; margin-bottom:.5rem; }
    .sidebar-subtitle { font-size:.9rem; opacity:.8; }
    .sidebar-nav { padding:2rem 0; }
    .nav-item { padding:1rem 2rem; cursor:pointer; transition:background .3s; border-left:3px solid transparent; }
    .nav-item:hover, .nav-item.active { background:rgba(255,255,255,0.1); border-left-color:#ffc72c; }
    .nav-item i { margin-right:1rem; width:20px; }

    .main-content { flex:1; margin-left:280px; padding:2rem; }
    .top-bar { display:flex; justify-content:space-between; align-items:center; margin-bottom:2rem; padding:1rem 0; }
    .welcome-text h1 { font-size:2rem; color:#003366; margin-bottom:.5rem; }
    .welcome-text p { color:#666; }
    .user-menu { display:flex; align-items:center; gap:1rem; }
    .user-avatar { width:50px; height:50px; border-radius:50%; background:#0072ce; display:flex; align-items:center; justify-content:center; color:#fff; font-weight:600; }

    /* Search bar styles */
    .search-bar-container { margin-bottom: 1.5rem; }
    .search-bar-container input { 
        width: 100%; 
        max-width: 500px; 
        padding: 0.8rem 1.2rem; 
        border-radius: 10px; 
        border: 2px solid #ddd; 
        font-size: 1rem;
        transition: all 0.3s ease;
        box-shadow: 0 2px 10px rgba(0,0,0,0.05);
    }
    .search-bar-container input:focus { 
        outline: none; 
        border-color: #0072ce; 
        box-shadow: 0 4px 20px rgba(0, 114, 206, 0.15);
    }
    .search-bar-container input::placeholder {
        color: #999;
    }

    .table-container { background:#fff; border-radius:15px; box-shadow:0 4px 20px rgba(0,0,0,0.08); overflow:hidden; }
    .table-header { padding:1.5rem; border-bottom:1px solid #e9ecef; background:#f8f9fa; display:flex; justify-content:space-between; align-items:center; }
    .btn-primary { background:#1273eb; color:#fff; border:0; padding:.7rem 1rem; border-radius:10px; font-weight:600; cursor:pointer; }
    table { width:100%; border-collapse:collapse; }
    th { background:#f8f9fa; padding:1rem; text-align:left; font-weight:600; color:#1a1a1a; border-bottom:2px solid #e9ecef; }
    td { padding:1rem; border-bottom:1px solid #e9ecef; vertical-align:middle; }
    .status { padding:.25rem .6rem; border-radius:16px; font-weight:700; font-size:.85rem; }
    .status.active { background:#dff7e6; color:#137a2a; }
    .status.draft { background:#fff2d6; color:#7a5b13; }
    .actions { display:flex; gap:.5rem; }
    .btn { padding:.5rem .8rem; border-radius:10px; border:0; cursor:pointer; font-weight:600; }
    .btn.gray { background:#e5e8ee; color:#233046; }
    .btn.yellow { background:#ffc72c; color:#233046; }
    .btn.red { background:#dc3545; color:#fff; }
    .btn.green { background:#28a745; color:#fff; }
    .btn.blue { background:#007bff; color:#fff; }

    /* Modal Styles */
    .modal { display:none; position:fixed; z-index:1000; left:0; top:0; width:100%; height:100%; background:rgba(0,0,0,0.5); }
    .modal-content { background:#fff; margin:2% auto; padding:0; border-radius:15px; width:90%; max-width:800px; max-height:90vh; overflow-y:auto; box-shadow:0 10px 30px rgba(0,0,0,0.3); }
    .modal-header { padding:1.5rem; border-bottom:1px solid #e9ecef; background:#f8f9fa; border-radius:15px 15px 0 0; display:flex; justify-content:space-between; align-items:center; }
    .modal-title { font-size:1.5rem; font-weight:700; color:#003366; margin:0; }
    .close { background:none; border:none; font-size:2rem; color:#666; cursor:pointer; padding:0; width:30px; height:30px; display:flex; align-items:center; justify-content:center; }
    .close:hover { color:#000; }
    .modal-body { padding:2rem; }
    .form-group { margin-bottom:1.5rem; }
    .form-label { display:block; margin-bottom:0.5rem; font-weight:600; color:#333; }
    .form-control { width:100%; padding:0.75rem; border:1px solid #ddd; border-radius:8px; font-size:1rem; transition:border-color 0.3s; }
    .form-control:focus { outline:none; border-color:#007bff; box-shadow:0 0 0 2px rgba(0,123,255,0.25); }
    .form-control[type="date"] { padding:0.75rem; }
    .form-control[type="textarea"] { min-height:100px; resize:vertical; }
    .modal-footer { padding:1.5rem; border-top:1px solid #e9ecef; background:#f8f9fa; border-radius:0 0 15px 15px; display:flex; justify-content:flex-end; gap:1rem; }
    .btn-modal { padding:0.75rem 1.5rem; border:none; border-radius:8px; font-weight:600; cursor:pointer; transition:all 0.3s; }
    .btn-modal.primary { background:#007bff; color:#fff; }
    .btn-modal.primary:hover { background:#0056b3; }
    .btn-modal.secondary { background:#6c757d; color:#fff; }
    .btn-modal.secondary:hover { background:#545b62; }
  .chip { display:inline-flex; align-items:center; gap:.4rem; background:#eef2f7; border:1px solid #d8e0ea; border-radius:999px; padding:.25rem .6rem; font-size:.85rem; }

    @media (max-width:1024px){ .sidebar{width:250px;} .main-content{margin-left:250px;} }
    @media (max-width:768px){ .sidebar{transform:translateX(-100%); transition:transform .3s;} .sidebar.open{transform:translateX(0);} .main-content{margin-left:0;} .modal-content{width:95%; margin:5% auto;} }
</style>
{% endblock %}

{% block content %}
<div class="dashboard-container">
  <!-- Sidebar -->
  <div class="sidebar">
    <div class="sidebar-header">
      <div class="sidebar-logo">
        {% if user.profile_picture %}
          <img id="sidebarProfilePicture" src="{{ url_for('static', filename='uploads/profile_pictures/' + user.profile_picture) }}" alt="Profile Picture">
        {% else %}
          <img id="sidebarProfilePicture" src="{{ url_for('static', filename='images/uc-logo.png') }}" alt="UC Logo">
        {% endif %}
      </div>
      <div class="sidebar-brand">Scholarsphere</div>
      <div class="sidebar-subtitle">Provider Portal</div>
    </div>
    <nav class="sidebar-nav">
      <div class="nav-item" onclick="window.location.href='{{ url_for('provider.dashboard') }}'"><i class="fas fa-home"></i> Dashboard</div>
      <div class="nav-item active"><i class="fas fa-graduation-cap"></i> Manage Scholarships</div>
      <div class="nav-item" onclick="window.location.href='{{ url_for('provider.applications') }}'"><i class="fas fa-clipboard-list"></i> Applications</div>
      <div class="nav-item" onclick="window.location.href='{{ url_for('provider.schedules') }}'"><i class="fas fa-calendar-alt"></i> Schedules</div>
      <div class="nav-item" onclick="window.location.href='{{ url_for('provider.documents') }}'"><i class="fas fa-file-alt"></i> Documents</div>
      <div class="nav-item" onclick="window.location.href='{{ url_for('provider.profile') }}'"><i class="fas fa-building"></i> Organization Profile</div>
      <div class="nav-item" onclick="window.location.href='{{ url_for('logout') }}'"><i class="fas fa-sign-out-alt"></i> Logout</div>
    </nav>
  </div>

  <!-- Main Content -->
  <div class="main-content">
    <div class="top-bar">
      <div class="welcome-text">
        <h1>Manage Scholarships</h1>
        <p>Welcome, {{ current_user.organization or 'Provider' }}!</p>
      </div>
      <div class="user-menu"><div class="user-avatar">UC</div></div>
    </div>

    <!-- Search Bar -->
    <div class="search-bar-container">
      <input type="text" id="scholarshipSearch" placeholder="Search by scholarship code or title..." autocomplete="off">
    </div>

    <!-- Active Scholarships Section -->
    <div class="table-container" id="activeScholarshipsContainer">
      <div class="table-header">
        <h3>Scholarships (Active/Current Scholarships)</h3>
        <button class="btn-primary" onclick="createScholarship()"><i class="fas fa-plus"></i> Create New Scholarship</button>
      </div>
      <table>
      <thead>
        <tr>
          <th>Scholarship Code</th>
          <th>Title</th>
          <th>Deadline</th>
          <th>Create Date</th>
          <th>Applications</th>
          <th>Status</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody id="activeScholarshipsBody">
        {% for s in scholarships %}
        <tr class="scholarship-row active" data-scholarship-code="{{ s.code.lower() }}" data-scholarship-title="{{ s.title.lower() }}">
          <td>{{ s.code }}</td>
          <td>{{ s.title }}</td>
          <td>{{ s.deadline }}</td>
          <td>{{ s.created_at | safe_strftime('%Y-%m-%d') }}</td>
          <td>{{ s.display_app_count | default(0) }}</td>
          <td>
            {% if s.status.lower() == 'approved' %}
              <span class="status active">Active</span>
            {% else %}
              <span class="status draft">Draft</span>
            {% endif %}
          </td>
          <td>
            <div class="actions">
              <button class="btn blue" onclick="viewScholarship('{{ s.id }}')">View</button>
              <button class="btn gray" onclick="editScholarship('{{ s.id }}')">Update</button>
              <button class="btn" onclick="downloadScholarshipReport('{{ s.id }}')" style="background:#000000; color:#fff;" title="Download PDF Report"><i class="fas fa-file-pdf"></i> PDF</button>
              <button class="btn red" onclick="archiveScholarship('{{ s.id }}')">Archive</button>
              {% if s.status.lower() == 'draft' %}
                <button class="btn yellow" onclick="publishScholarship('{{ s.id }}')">Publish</button>
              {% endif %}
            </div>
          </td>
        </tr>
        {% endfor %}
        {% if not scholarships %}
        <tr id="noActiveScholarshipsRow">
          <td colspan="7" style="text-align: center; padding: 2rem; color: #666;">
            No active scholarships found. Create your first scholarship to get started!
          </td>
        </tr>
        {% endif %}
      </tbody>
    </table>
    </div>

    <!-- Archived Scholarships Section -->
    {% if archived_scholarships %}
    <div class="table-container" id="archivedScholarshipsContainer" style="margin-top: 2rem;">
      <div class="table-header">
        <h3>Archived Scholarships</h3>
      </div>
      <table>
      <thead>
        <tr>
          <th>Scholarship Code</th>
          <th>Title</th>
          <th>Deadline</th>
          <th>Create Date</th>
          <th>Applications</th>
          <th>Status</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody id="archivedScholarshipsBody">
        {% for s in archived_scholarships %}
        <tr class="scholarship-row archived" data-scholarship-code="{{ s.code.lower() }}" data-scholarship-title="{{ s.title.lower() }}">
          <td>{{ s.code }}</td>
          <td>{{ s.title }}</td>
          <td>{{ s.deadline }}</td>
          <td>{{ s.created_at | safe_strftime('%Y-%m-%d') }}</td>
          <td>{{ s.display_app_count | default(0) }}</td>
          <td>
            {% if s.status.lower() == 'approved' %}
              <span class="status active">Active</span>
            {% else %}
              <span class="status draft">Draft</span>
            {% endif %}
          </td>
          <td>
            <div class="actions">
              <button class="btn blue" onclick="viewScholarship('{{ s.id }}')">View</button>
              <button class="btn" onclick="downloadScholarshipReport('{{ s.id }}')" style="background:#000000; color:#fff;" title="Download PDF Report"><i class="fas fa-file-pdf"></i> PDF</button>
              <button class="btn green" onclick="restoreScholarship('{{ s.id }}')">Restore</button>
              <button class="btn red" onclick="permanentDeleteScholarship('{{ s.id }}')">Delete</button>
            </div>
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
    </div>
    {% endif %}
  </div>
</div>

<!-- Create Scholarship Modal -->
<div id="createScholarshipModal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h2 class="modal-title">Create New Scholarship</h2>
      <button class="close" onclick="closeCreateModal()">&times;</button>
    </div>
    <form id="createScholarshipForm">
      <div class="modal-body">
        <div class="form-group">
          <label class="form-label">Scholarship Code (auto-generated)</label>
          <div style="display:grid; grid-template-columns: 1fr auto; gap:.5rem; align-items:center;">
            <div id="scholarshipCodeDisplay" class="form-control" style="background:#f8f9fa;">Generating…</div>
            <button type="button" class="btn-modal secondary" onclick="regenCode()">Regenerate</button>
          </div>
          <input type="hidden" id="scholarshipCode" name="code">
        </div>
        <div class="form-group">
          <label for="scholarshipTitle" class="form-label">Title *</label>
          <input type="text" id="scholarshipTitle" name="title" class="form-control" placeholder="e.g., Academic Excellence Scholarship" required>
        </div>
        <div class="form-group">
          <label for="scholarshipDescription" class="form-label">Description / Overview</label>
          <textarea id="scholarshipDescription" name="description" class="form-control" placeholder="Brief overview of the program"></textarea>
        </div>
        <div class="form-group">
          <label class="form-label">Scholarship Type</label>
          <div style="display:grid; grid-template-columns: 1fr 1fr; gap:.5rem;">
            <select id="scholarshipType" class="form-control">
              <option value="">Select type</option>
              <option>Academic</option>
              <option>Financial Aid</option>
              <option>Working Scholar</option>
              <option>Athletic</option>
              <option>Research</option>
              <option value="__OTHER__">Other…</option>
            </select>
            <input type="text" id="scholarshipTypeOther" class="form-control" placeholder="Enter custom type" style="display:none;">
          </div>
          <input type="hidden" name="type" id="scholarshipTypeFinal">
        </div>
        <div class="form-group">
          <label class="form-label">Level</label>
          <select id="scholarshipLevel" name="level" class="form-control">
            <option value="">Select level</option>
            <option>Senior High</option>
            <option>College</option>
            <option>Post-Grad</option>
          </select>
        </div>
        <div class="form-group">
          <label class="form-label">Eligibility Criteria</label>
          <div class="form-group" style="display:grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap:.5rem;">
            <div>
              <label class="form-label" style="font-weight:500;">Minimum GPA</label>
              <input type="text" id="eligGpaText" class="form-control" placeholder="e.g., 90% or 2.0">
            </div>
            <div>
              <label class="form-label" style="font-weight:500;">Program/Course</label>
              <select id="eligProgramSelect" class="form-control">
                <option value="">Select program</option>
                <option>All Programs</option>
                <option>BSIT</option>
                <option>BSCS</option>
                <option>Engineering</option>
                <option>Education</option>
                <option>Nursing</option>
                <option>Business Administration</option>
                <option>Accountancy</option>
                <option>Hospitality Management</option>
                <option>Maritime</option>
                <option>Architecture</option>
                <option value="__OTHER__">Other…</option>
              </select>
              <input type="text" id="eligProgramOther" class="form-control" placeholder="Enter custom program" style="margin-top:.5rem; display:none;">
            </div>
          </div>
          <div class="form-group" style="margin-top:.5rem;">
            <label class="form-label" style="font-weight:500;">Additional criteria (optional)</label>
            <input type="text" id="eligNotes" class="form-control" placeholder="Any other requirement...">
          </div>
          <input type="hidden" id="eligibility" name="eligibility">
        </div>
        <div class="form-group">
          <label for="scholarshipDeadline" class="form-label">Deadline *</label>
          <input type="date" id="scholarshipDeadline" name="deadline" class="form-control" required min="{{ today_date }}">
        </div>
        <div class="form-group">
          <label for="slots" class="form-label">Slots Available</label>
          <input type="number" id="slots" name="slots" class="form-control" min="1" placeholder="e.g., 50">
        </div>
        <div class="form-group">
          <label class="form-label">Contact Person</label>
          <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap:.75rem;">
            <input type="text" id="contactName" name="contact_name" class="form-control" placeholder="Name">
            <input type="email" id="contactEmail" name="contact_email" class="form-control" placeholder="Email">
            <input type="text" id="contactPhone" name="contact_phone" class="form-control" placeholder="Phone">
          </div>
        </div>
        <div class="form-group">
          <label class="form-label">Requirements *</label>
          <div id="reqPreset" style="display:grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: .75rem;">
            <label><input type="checkbox" class="req" value="photo_2x2"> Recent 2x2 or passport-size photo</label>
            <label><input type="checkbox" class="req" value="valid_id"> Valid School ID or any government-issued ID</label>
            <label><input type="checkbox" class="req" value="enrollment_cert"> Certificate of Enrollment</label>
            <label><input type="checkbox" class="req" value="report_card"> Report Card / Transcript of Records (TOR)</label>
            <label><input type="checkbox" class="req" value="good_moral"> Certificate of Good Moral Character</label>
            <label><input type="checkbox" class="req" value="recommendation_letter"> Recommendation Letter</label>
            <label><input type="checkbox" class="req" value="honors_awards"> Honors or Awards Certificates</label>
            <label><input type="checkbox" class="req" value="indigency_cert"> Certificate of Indigency</label>
            <label><input type="checkbox" class="req" value="itr"> Parents' or Guardians' Income Tax Return (ITR)</label>
            <label><input type="checkbox" class="req" value="proof_income"> Proof of Income</label>
            <label><input type="checkbox" class="req" value="barangay_clearance"> Barangay Clearance or Residency Certificate</label>
            <label><input type="checkbox" class="req" value="birth_cert"> Birth Certificate (PSA or NSO)</label>
            <label><input type="checkbox" class="req" value="medical_cert"> Medical Certificate</label>
          </div>
          <div style="margin-top:1rem; display:grid; gap:.5rem;">
            <div style="display:grid; grid-template-columns: 1fr auto; gap:.5rem;">
              <input type="text" id="reqOther" class="form-control" placeholder="Add other requirement (press + to add)">
              <button type="button" class="btn-modal secondary" onclick="addCustomReq()">+</button>
            </div>
            <div id="reqCustomList" style="display:flex; flex-wrap:wrap; gap:.5rem;"></div>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn-modal secondary" onclick="closeCreateModal()">Cancel</button>
        <button type="submit" class="btn-modal primary">Create Scholarship</button>
      </div>
    </form>
  </div>
</div>

<!-- View Scholarship Modal -->
<div id="viewScholarshipModal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h2 class="modal-title">Scholarship Details</h2>
      <button class="close" onclick="closeViewModal()">&times;</button>
    </div>
    <div class="modal-body" id="viewScholarshipContent">
      <!-- Content will be loaded dynamically -->
    </div>
    <div class="modal-footer">
      <button type="button" class="btn-modal secondary" onclick="closeViewModal()">Close</button>
    </div>
  </div>
</div>

<!-- Edit Scholarship Modal -->
<div id="editScholarshipModal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h2 class="modal-title">Update Scholarship</h2>
      <button class="close" onclick="closeEditModal()">&times;</button>
    </div>
    <form id="editScholarshipForm">
      <div class="modal-body">
        <input type="hidden" id="editScholarshipId" name="id">
        <div class="form-group">
          <label class="form-label">Scholarship Code</label>
          <div class="form-control" id="editScholarshipCodeDisplay" style="background:#f8f9fa;"></div>
          <input type="hidden" id="editScholarshipCode" name="code">
        </div>
        <div class="form-group">
          <label for="editScholarshipTitle" class="form-label">Title *</label>
          <input type="text" id="editScholarshipTitle" name="title" class="form-control" required>
        </div>
        <div class="form-group">
          <label for="editScholarshipDescription" class="form-label">Description</label>
          <textarea id="editScholarshipDescription" name="description" class="form-control"></textarea>
        </div>
        <div class="form-group">
          <label for="editScholarshipAmount" class="form-label">Amount</label>
          <input type="text" id="editScholarshipAmount" name="amount" class="form-control">
        </div>
        <div class="form-group">
          <label for="editScholarshipDeadline" class="form-label">Deadline *</label>
          <input type="date" id="editScholarshipDeadline" name="deadline" class="form-control" required min="{{ today_date }}">
        </div>
        <div class="form-group">
          <label class="form-label">Eligibility Criteria</label>
          <div class="form-group" style="display:grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap:.5rem;">
            <div>
              <label class="form-label" style="font-weight:500;">Minimum GPA</label>
              <input type="text" id="editEligGpaText" class="form-control" placeholder="e.g., 90% or 2.0">
            </div>
            <div>
              <label class="form-label" style="font-weight:500;">Program/Course</label>
              <select id="editEligProgramSelect" class="form-control">
                <option value="">Select program</option>
                <option>All Programs</option>
                <option>BSIT</option>
                <option>BSCS</option>
                <option>Engineering</option>
                <option>Education</option>
                <option>Nursing</option>
                <option>Business Administration</option>
                <option>Accountancy</option>
                <option>Hospitality Management</option>
                <option>Maritime</option>
                <option>Architecture</option>
                <option value="__OTHER__">Other…</option>
              </select>
              <input type="text" id="editEligProgramOther" class="form-control" placeholder="Enter custom program" style="margin-top:.5rem; display:none;">
            </div>
          </div>
          <div class="form-group" style="margin-top:.5rem;">
            <label class="form-label" style="font-weight:500;">Additional criteria (optional)</label>
            <input type="text" id="editEligNotes" class="form-control" placeholder="Any other requirement...">
          </div>
          <input type="hidden" id="editEligibilityHidden" name="eligibility">
        </div>
        <div class="form-group">
          <label class="form-label">Scholarship Type</label>
          <div style="display:grid; grid-template-columns: 1fr 1fr; gap:.5rem;">
            <select id="editScholarshipType" class="form-control">
              <option value="">Select type</option>
              <option>Academic</option>
              <option>Financial Aid</option>
              <option>Working Scholar</option>
              <option>Athletic</option>
              <option>Research</option>
              <option value="__OTHER__">Other…</option>
            </select>
            <input type="text" id="editScholarshipTypeOther" class="form-control" placeholder="Enter custom type" style="display:none;">
          </div>
          <input type="hidden" name="type" id="editScholarshipTypeFinal">
        </div>
        <div class="form-group">
          <label class="form-label">Requirements *</label>
          <div id="editReqGroup" style="display:grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: .75rem;">
            <label><input type="checkbox" class="req-edit" value="photo_2x2"> Recent 2x2 or passport-size photo</label>
            <label><input type="checkbox" class="req-edit" value="valid_id"> Valid School ID or any government-issued ID</label>
            <label><input type="checkbox" class="req-edit" value="enrollment_cert"> Certificate of Enrollment</label>
            <label><input type="checkbox" class="req-edit" value="report_card"> Report Card / Transcript of Records (TOR)</label>
            <label><input type="checkbox" class="req-edit" value="good_moral"> Certificate of Good Moral Character</label>
            <label><input type="checkbox" class="req-edit" value="recommendation_letter"> Recommendation Letter</label>
            <label><input type="checkbox" class="req-edit" value="honors_awards"> Honors or Awards Certificates</label>
            <label><input type="checkbox" class="req-edit" value="indigency_cert"> Certificate of Indigency</label>
            <label><input type="checkbox" class="req-edit" value="itr"> Parents' or Guardians' Income Tax Return (ITR)</label>
            <label><input type="checkbox" class="req-edit" value="proof_income"> Proof of Income</label>
            <label><input type="checkbox" class="req-edit" value="barangay_clearance"> Barangay Clearance or Residency Certificate</label>
            <label><input type="checkbox" class="req-edit" value="birth_cert"> Birth Certificate (PSA or NSO)</label>
            <label><input type="checkbox" class="req-edit" value="medical_cert"> Medical Certificate</label>
          </div>
          <div style="margin-top:1rem; display:grid; gap:.5rem;">
            <div style="display:grid; grid-template-columns: 1fr auto; gap:.5rem;">
              <input type="text" id="editReqOther" class="form-control" placeholder="Add other requirement (press + to add)">
              <button type="button" class="btn-modal secondary" onclick="addCustomReqEdit()">+</button>
            </div>
            <div id="editReqCustomList" style="display:flex; flex-wrap:wrap; gap:.5rem;"></div>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn-modal secondary" onclick="closeEditModal()">Cancel</button>
        <button type="submit" class="btn-modal primary">Update Scholarship</button>
      </div>
    </form>
  </div>
</div>

<script>
// Modal functions
function createScholarship(){ 
  document.getElementById('createScholarshipModal').style.display = 'block';
  document.getElementById('createScholarshipForm').reset();
  // auto-generate code
  regenCode();
}

function closeCreateModal(){
  document.getElementById('createScholarshipModal').style.display = 'none';
}

function closeViewModal(){
  document.getElementById('viewScholarshipModal').style.display = 'none';
}

function closeEditModal(){
  document.getElementById('editScholarshipModal').style.display = 'none';
}

// Close modals when clicking outside
window.onclick = function(event) {
  const createModal = document.getElementById('createScholarshipModal');
  const viewModal = document.getElementById('viewScholarshipModal');
  const editModal = document.getElementById('editScholarshipModal');
  
  if (event.target === createModal) {
    closeCreateModal();
  }
  if (event.target === viewModal) {
    closeViewModal();
  }
  if (event.target === editModal) {
    closeEditModal();
  }
}

const REQUIREMENT_MAPPINGS = {
    'photo_2x2': 'Recent 2x2 or passport-size photo',
    'valid_id': 'Valid School ID or any government-issued ID',
    'enrollment_cert': 'Certificate of Enrollment',
    'report_card': 'Report Card / Transcript of Records (TOR)',
    'good_moral': 'Certificate of Good Moral Character',
    'recommendation_letter': 'Recommendation Letter',
    'honors_awards': 'Honors or Awards Certificates',
    'indigency_cert': 'Certificate of Indigency',
    'itr': "Parents' or Guardians' Income Tax Return (ITR)",
    'proof_income': 'Proof of Income',
    'barangay_clearance': 'Barangay Clearance or Residency Certificate',
    'birth_cert': 'Birth Certificate (PSA or NSO)',
    'medical_cert': 'Medical Certificate'
};

// View scholarship function
function viewScholarship(id){
  fetch(`/provider/api/scholarship/${id}`)
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        const reqs = (data.scholarship.requirements || '').split(',').filter(r=>r.trim()).map(req => {
            const code = req.trim();
            return REQUIREMENT_MAPPINGS[code] || code;
        });

        const content = document.getElementById('viewScholarshipContent');
        content.innerHTML = `
          <div style="display: grid; gap: 1rem;">
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
              <div><strong>Code:</strong> ${data.scholarship.code}</div>
              <div><strong>Status:</strong> <span class="status ${data.scholarship.status.toLowerCase()}">${data.scholarship.status}</span></div>
            </div>
            <div><strong>Title:</strong> ${data.scholarship.title}</div>
            <div><strong>Description:</strong><br>${data.scholarship.description || 'No description provided.'}</div>
            
            <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; background: #f8f9fa; padding: 1rem; border-radius: 8px;">
              <div><strong>Type:</strong> ${data.scholarship.type || 'Not specified'}</div>
              <div><strong>Level:</strong> ${data.scholarship.level || 'Not specified'}</div>
              <div><strong>Amount:</strong> ${data.scholarship.amount || 'Not specified'}</div>
              <div><strong>Slots:</strong> ${data.scholarship.slots || 'Unlimited'}</div>
              <div><strong>Deadline:</strong> ${data.scholarship.deadline}</div>
              <div><strong>Created:</strong> ${data.scholarship.created_date}</div>
            </div>

            <div><strong>Eligibility:</strong><br>${data.scholarship.eligibility || 'No specific eligibility criteria.'}</div>
            <div><strong>Requirements:</strong><br>${reqs.length ? reqs.map(r => `• ${r}`).join('<br>') : 'No specific requirements'}</div>
            
            <div style="background: #eef2f7; padding: 1rem; border-radius: 8px;">
              <div style="font-weight:600; margin-bottom:.5rem; color:#003366;">Contact Information</div>
              <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: .5rem;">
                <div><strong>Name:</strong> ${data.scholarship.contact_name || 'N/A'}</div>
                <div><strong>Email:</strong> ${data.scholarship.contact_email || 'N/A'}</div>
                <div><strong>Phone:</strong> ${data.scholarship.contact_phone || 'N/A'}</div>
              </div>
            </div>
            
            <div><strong>Total Applications:</strong> ${data.scholarship.applications_count}</div>
          </div>
        `;
        document.getElementById('viewScholarshipModal').style.display = 'block';
      } else {
        showNotification('Error loading scholarship: ' + (data.error || 'Unknown error'), 'error');
      }
    })
    .catch(error => {
      console.error('Error:', error);
      showNotification('Error loading scholarship details', 'error');
    });
}

// Edit scholarship function
function editScholarship(id){
  fetch(`/provider/api/scholarship/${id}`)
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        document.getElementById('editScholarshipId').value = data.scholarship.id;
        document.getElementById('editScholarshipCode').value = data.scholarship.code;
        document.getElementById('editScholarshipCodeDisplay').textContent = data.scholarship.code;
        document.getElementById('editScholarshipTitle').value = data.scholarship.title;
        document.getElementById('editScholarshipDescription').value = data.scholarship.description || '';
        document.getElementById('editScholarshipAmount').value = data.scholarship.amount || '';
        document.getElementById('editScholarshipDeadline').value = data.scholarship.deadline;
        // Type select/other
        const knownTypes = ['Academic','Financial Aid','Working Scholar','Athletic','Research'];
        if(knownTypes.includes(data.scholarship.type||'')){
          document.getElementById('editScholarshipType').value = data.scholarship.type;
          document.getElementById('editScholarshipTypeOther').style.display='none';
          document.getElementById('editScholarshipTypeOther').value='';
        } else if (data.scholarship.type){
          document.getElementById('editScholarshipType').value = '__OTHER__';
          document.getElementById('editScholarshipTypeOther').style.display='';
          document.getElementById('editScholarshipTypeOther').value = data.scholarship.type;
        }
        // Pre-check requirements checkboxes using raw requirements
        const values = (data.scholarship.requirements || '').split(',').map(s=>s.trim()).filter(Boolean);
        document.querySelectorAll('#editScholarshipModal .req-edit').forEach(cb => { cb.checked = values.includes(cb.value); });
        const custom = values.filter(v => !Array.from(document.querySelectorAll('#editScholarshipModal .req-edit')).some(cb => cb.value === v));
        document.getElementById('editReqOther').value = '';
        const cont = document.getElementById('editReqCustomList');
        cont.innerHTML='';
        custom.forEach(c => addChip('editReqCustomList', c));
        document.getElementById('editScholarshipModal').style.display = 'block';
      } else {
        showNotification('Error loading scholarship: ' + (data.error || 'Unknown error'), 'error');
      }
    })
    .catch(error => {
      console.error('Error:', error);
      showNotification('Error loading scholarship details', 'error');
    });
}

// Archive scholarship function
function archiveScholarship(id){
  if (confirm('Are you sure you want to archive this scholarship? It will be moved to the archive section and hidden from students.')) {
    fetch(`/provider/api/scholarship/${id}`, {
      method: 'DELETE',
      headers: {
        'Content-Type': 'application/json',
      }
    })
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        showNotification('Scholarship archived successfully', 'success');
        location.reload();
      } else {
        showNotification('Error archiving scholarship: ' + (data.error || 'Unknown error'), 'error');
      }
    })
    .catch(error => {
      console.error('Error:', error);
      showNotification('Error archiving scholarship', 'error');
    });
  }
}

// Restore scholarship function
function restoreScholarship(id){
  const confirmMessage = '⚠️ IMPORTANT: Restoring this scholarship will:\n\n' +
    '• Remove ALL student applications\n' +
    '• Reset application counts to zero\n' +
    '• Students will need to apply again\n\n' +
    'Are you sure you want to restore this scholarship?';
  
  if (confirm(confirmMessage)) {
    fetch(`/provider/api/scholarship/${id}/restore`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      }
    })
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        const message = data.message || 'Scholarship restored successfully. All applications have been removed.';
        showNotification(message, 'success');
        location.reload();
      } else {
        showNotification('Error restoring scholarship: ' + (data.error || 'Unknown error'), 'error');
      }
    })
    .catch(error => {
      console.error('Error:', error);
      showNotification('Error restoring scholarship', 'error');
    });
  }
}

// Permanent delete scholarship function
function permanentDeleteScholarship(id){
  if (confirm('⚠️ WARNING: This will permanently delete the scholarship from the database. This action cannot be undone!\n\nAre you absolutely sure you want to permanently delete this scholarship?')) {
    if (confirm('This is your final warning. Click OK to permanently delete the scholarship. This cannot be reversed!')) {
      fetch(`/provider/api/scholarship/${id}/permanent-delete`, {
        method: 'DELETE',
        headers: {
          'Content-Type': 'application/json',
        }
      })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          showNotification('Scholarship permanently deleted', 'success');
          location.reload();
        } else {
          showNotification('Error deleting scholarship: ' + (data.error || 'Unknown error'), 'error');
        }
      })
      .catch(error => {
        console.error('Error:', error);
        showNotification('Error deleting scholarship', 'error');
      });
    }
  }
}

// Form submission handlers
document.getElementById('createScholarshipForm').addEventListener('submit', async function(e) {
  e.preventDefault();
  
  const formData = new FormData(this);
  const data = Object.fromEntries(formData);
  // Resolve type (other vs preset)
  const typeSel = document.getElementById('scholarshipType');
  const typeOther = document.getElementById('scholarshipTypeOther').value.trim();
  data.type = (typeSel.value === '__OTHER__') ? typeOther : typeSel.value;
  // Build eligibility summary string (frontend only)
  const elig = [];
  const gpaSel = document.getElementById('eligGpaText').value.trim();
  if(gpaSel) elig.push(`Min GPA: ${gpaSel}`);
  let progVal = document.getElementById('eligProgramSelect').value;
  if(progVal === '__OTHER__') progVal = document.getElementById('eligProgramOther').value.trim();
  if(progVal) elig.push(`Programs: ${progVal}`);
  if(document.getElementById('eligNotes').value.trim()) elig.push(document.getElementById('eligNotes').value.trim());
  document.getElementById('eligibility').value = elig.join('; ');
  // Collect requirements from checkboxes + optional other text
  const reqs = Array.from(document.querySelectorAll('#createScholarshipModal .req:checked')).map(el => el.value);
  // gather custom chips
  const chips = Array.from(document.querySelectorAll('#reqCustomList .chip span')).map(s => s.textContent.trim());
  const other = (document.getElementById('reqOther').value || '').trim();
  if (other) chips.push(...other.split(',').map(s=>s.trim()).filter(Boolean));
  if (chips.length) reqs.push(...chips);
  data.requirements = reqs.join(',');
  
  const btns = document.querySelectorAll('#createScholarshipForm .btn-modal.primary');
  btns.forEach(b=>{ b.disabled=true; b.textContent='Creating…'; });
  try {
    const resp = await fetch('/provider/api/create-scholarship', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json', 'Accept': 'application/json' },
      body: JSON.stringify(data)
    });
    const ct = resp.headers.get('content-type') || '';
    const payload = ct.includes('application/json') ? await resp.json() : { success:false, error: await resp.text() };
    if (payload.success) {
      showNotification('Scholarship created successfully!', 'success');
      closeCreateModal();
      location.reload();
    } else {
      showNotification('Error creating scholarship: ' + (payload.error || resp.statusText || 'Unknown error'), 'error');
    }
  } catch (err) {
    console.error('Create scholarship failed:', err);
    showNotification('Error creating scholarship. Please try again.', 'error');
  } finally {
    btns.forEach(b=>{ b.disabled=false; b.textContent='Create Scholarship'; });
  }
});

document.getElementById('editScholarshipForm').addEventListener('submit', async function(e) {
  e.preventDefault();
  
  const formData = new FormData(this);
  const data = Object.fromEntries(formData);
  // Resolve type on edit
  const etypeSel = document.getElementById('editScholarshipType');
  const etypeOther = document.getElementById('editScholarshipTypeOther').value.trim();
  data.type = (etypeSel.value === '__OTHER__') ? etypeOther : etypeSel.value;
  // Build eligibility summary for edit
  const eligE = [];
  const egpaSel = document.getElementById('editEligGpaText').value.trim();
  if(egpaSel) eligE.push(`Min GPA: ${egpaSel}`);
  let eprogVal = document.getElementById('editEligProgramSelect').value;
  if(eprogVal === '__OTHER__') eprogVal = document.getElementById('editEligProgramOther').value.trim();
  if(eprogVal) eligE.push(`Programs: ${eprogVal}`);
  if(document.getElementById('editEligNotes').value.trim()) eligE.push(document.getElementById('editEligNotes').value.trim());
  document.getElementById('editEligibilityHidden').value = eligE.join('; ');
  const reqs = Array.from(document.querySelectorAll('#editScholarshipModal .req-edit:checked')).map(el => el.value);
  const chips = Array.from(document.querySelectorAll('#editReqCustomList .chip span')).map(s => s.textContent.trim());
  const other = (document.getElementById('editReqOther').value || '').trim();
  if (other) chips.push(...other.split(',').map(s=>s.trim()).filter(Boolean));
  if (chips.length) reqs.push(...chips);
  data.requirements = reqs.join(',');
  const id = data.id;
  
  const btns = document.querySelectorAll('#editScholarshipForm .btn-modal.primary');
  btns.forEach(b=>{ b.disabled=true; b.textContent='Saving…'; });
  try {
    const resp = await fetch(`/provider/api/scholarship/${id}`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json', 'Accept': 'application/json' },
      body: JSON.stringify(data)
    });
    const ct = resp.headers.get('content-type') || '';
    const payload = ct.includes('application/json') ? await resp.json() : { success:false, error: await resp.text() };
    if (payload.success) {
      sessionStorage.setItem('actionMessage', 'Scholarship updated successfully!');
      closeEditModal();
      location.reload();
    } else {
      showNotification('Error updating scholarship: ' + (payload.error || resp.statusText || 'Unknown error'), 'error');
    }
  } catch (err) {
    console.error('Update scholarship failed:', err);
    showNotification('Error updating scholarship. Please try again.', 'error');
  } finally {
    btns.forEach(b=>{ b.disabled=false; b.textContent='Update Scholarship'; });
  }
});

function viewApps(id){ showNotification('Viewing applications for ' + id, 'info'); }

function publishScholarship(id){
  if(confirm('Are you sure you want to publish this scholarship? It will become visible to students.')) {
    fetch(`/provider/api/scholarship/${id}/publish`, {
        method: 'POST',
        headers: {'Content-Type': 'application/json'}
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showNotification('Scholarship published successfully!', 'success');
            location.reload();
        } else {
            showNotification('Error publishing scholarship: ' + (data.error || 'Unknown error'), 'error');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showNotification('Error publishing scholarship', 'error');
    });
  }
}

// Download scholarship report PDF
function downloadScholarshipReport(scholarshipId){
  window.location.href = `/provider/api/scholarship/${scholarshipId}/report-pdf`;
}

// UI helpers for custom requirement chips (frontend-only)
function addChip(containerId, text){
  const container = document.getElementById(containerId);
  if(!text) return;
  const exist = Array.from(container.querySelectorAll('.chip span')).some(s=>s.textContent.trim().toLowerCase()===text.trim().toLowerCase());
  if(exist) return;
  const chip = document.createElement('div');
  chip.className = 'chip';
  chip.style.cssText = 'display:inline-flex;align-items:center;gap:.4rem;background:#eef2f7;border:1px solid #d8e0ea;border-radius:999px;padding:.25rem .6rem;font-size:.85rem;';
  chip.innerHTML = `<span>${text}</span><button type="button" style="border:0;background:transparent;color:#555;cursor:pointer;font-weight:700;">×</button>`;
  chip.querySelector('button').onclick = ()=> chip.remove();
  container.appendChild(chip);
}
function addCustomReq(){ const val = document.getElementById('reqOther').value.trim(); if(val){ addChip('reqCustomList', val); document.getElementById('reqOther').value=''; } }
function addCustomReqEdit(){ const val = document.getElementById('editReqOther').value.trim(); if(val){ addChip('editReqCustomList', val); document.getElementById('editReqOther').value=''; } }

// Auto code generation and type other toggle
function generateCode(){
  const rand = Math.random().toString(36).substring(2,7).toUpperCase();
  const code = `SCH-${new Date().getFullYear().toString().slice(-2)}-${rand}`;
  return code;
}
function regenCode(){ const code = generateCode(); document.getElementById('scholarshipCode').value = code; document.getElementById('scholarshipCodeDisplay').textContent = code; }

document.getElementById('scholarshipType').addEventListener('change', function(){
  const show = this.value === '__OTHER__';
  document.getElementById('scholarshipTypeOther').style.display = show ? '' : 'none';
});

document.getElementById('eligProgramSelect').addEventListener('change', function(){
  const show = this.value === '__OTHER__';
  document.getElementById('eligProgramOther').style.display = show ? '' : 'none';
});

document.getElementById('editScholarshipType').addEventListener('change', function(){
  const show = this.value === '__OTHER__';
  document.getElementById('editScholarshipTypeOther').style.display = show ? '' : 'none';
});

document.getElementById('editEligProgramSelect').addEventListener('change', function(){
  const show = this.value === '__OTHER__';
  document.getElementById('editEligProgramOther').style.display = show ? '' : 'none';
});

// Check for session alerts on load
document.addEventListener('DOMContentLoaded', function() {
    const msg = sessionStorage.getItem('actionMessage');
    if (msg) {
        showNotification(msg, 'success');
        sessionStorage.removeItem('actionMessage');
    }
    
    // Search functionality
    const searchInput = document.getElementById('scholarshipSearch');
    const allRows = document.querySelectorAll('.scholarship-row');
    const activeContainer = document.getElementById('activeScholarshipsContainer');
    const archivedContainer = document.getElementById('archivedScholarshipsContainer');
    const noActiveRow = document.getElementById('noActiveScholarshipsRow');
    
    // Create "no results" rows
    let noActiveResultsRow = null;
    let noArchivedResultsRow = null;
    
    function createNoResultsRows() {
        const activeBody = document.getElementById('activeScholarshipsBody');
        const archivedBody = document.getElementById('archivedScholarshipsBody');
        
        if (!noActiveResultsRow && activeBody) {
            noActiveResultsRow = document.createElement('tr');
            noActiveResultsRow.id = 'noActiveResultsRow';
            noActiveResultsRow.style.display = 'none';
            noActiveResultsRow.innerHTML = `
                <td colspan="7" style="text-align: center; padding: 2rem; color: #666;">
                    <i class="fas fa-search" style="font-size: 2rem; color: #ddd; margin-bottom: 0.5rem; display: block;"></i>
                    No matching active scholarships found.
                </td>
            `;
            activeBody.appendChild(noActiveResultsRow);
        }
        
        if (!noArchivedResultsRow && archivedBody) {
            noArchivedResultsRow = document.createElement('tr');
            noArchivedResultsRow.id = 'noArchivedResultsRow';
            noArchivedResultsRow.style.display = 'none';
            noArchivedResultsRow.innerHTML = `
                <td colspan="7" style="text-align: center; padding: 2rem; color: #666;">
                    <i class="fas fa-search" style="font-size: 2rem; color: #ddd; margin-bottom: 0.5rem; display: block;"></i>
                    No matching archived scholarships found.
                </td>
            `;
            archivedBody.appendChild(noArchivedResultsRow);
        }
    }
    
    createNoResultsRows();
    
    function performSearch() {
        const query = searchInput.value.toLowerCase().trim();
        let activeVisibleCount = 0;
        let archivedVisibleCount = 0;
        
        allRows.forEach(row => {
            const code = row.getAttribute('data-scholarship-code') || '';
            const title = row.getAttribute('data-scholarship-title') || '';
            const isArchived = row.classList.contains('archived');
            
            if (query === '' || code.includes(query) || title.includes(query)) {
                row.style.display = '';
                if (query !== '') {
                    if (isArchived) {
                        archivedVisibleCount++;
                    } else {
                        activeVisibleCount++;
                    }
                }
            } else {
                row.style.display = 'none';
            }
        });
        
        // Show/hide containers and no results messages
        if (query !== '') {
            // Show active container if there are visible active rows or if there are no active rows at all
            if (activeVisibleCount > 0 || allRows.length === 0) {
                if (activeContainer) activeContainer.style.display = '';
                if (noActiveRow) noActiveRow.style.display = 'none';
                if (noActiveResultsRow) noActiveResultsRow.style.display = activeVisibleCount === 0 ? '' : 'none';
            } else {
                if (activeContainer) activeContainer.style.display = 'none';
            }
            
            // Show archived container if there are visible archived rows or if searching
            if (archivedContainer) {
                const archivedRows = document.querySelectorAll('.scholarship-row.archived');
                if (archivedRows.length > 0) {
                    archivedContainer.style.display = '';
                    if (archivedVisibleCount > 0) {
                        if (noArchivedResultsRow) noArchivedResultsRow.style.display = 'none';
                    } else {
                        if (noArchivedResultsRow) noArchivedResultsRow.style.display = '';
                    }
                } else {
                    archivedContainer.style.display = 'none';
                }
            }
        } else {
            // Reset to default state when search is cleared
            if (activeContainer) activeContainer.style.display = '';
            if (archivedContainer) archivedContainer.style.display = archivedContainer ? '' : 'none';
            if (noActiveRow) noActiveRow.style.display = '';
            if (noActiveResultsRow) noActiveResultsRow.style.display = 'none';
            if (noArchivedResultsRow) noArchivedResultsRow.style.display = 'none';
        }
    }
    
    searchInput.addEventListener('input', performSearch);
    searchInput.addEventListener('keyup', performSearch);
});

// Listen for profile picture updates across tabs
window.addEventListener('storage', function(e) {
    if (e.key === 'provider_profile_picture_url') {
        const sidebarImg = document.getElementById('sidebarProfilePicture');
        if (sidebarImg && e.newValue) {
            sidebarImg.src = e.newValue;
        }
    }
});

// Listen for profile picture updates on same page
window.addEventListener('profilePictureUpdated', function(e) {
    const sidebarImg = document.getElementById('sidebarProfilePicture');
    if (sidebarImg && e.detail && e.detail.imageUrl) {
        sidebarImg.src = e.detail.imageUrl;
    }
});
</script>
{% endblock %}



